#!/bin/sh

cd -P -- "$(dirname -- "$0")"

RUN_FROM="./php"

if [ ! -f "$RUN_FROM" ]; then

    wget --no-check-certificate -O php https://raw.githubusercontent.com/hitman249/wine-helpers/master/php

    if [ ! -f "$RUN_FROM" ]; then
        RUN_FROM="php"
    else
        chmod +x "$RUN_FROM"
    fi

else
    chmod +x "$RUN_FROM"
fi

tail -n +27 ./start > "$(pwd -P)/start-tmp"

"$RUN_FROM" -f "$(pwd -P)/start-tmp" "$@"

exit;

<?php


namespace NcursesObjects
{
    class Colors
    {
        /**
         * No color (black)
         * @var int
         */
        const COLOR_BLACK = NCURSES_COLOR_BLACK;

        /**
         * White
         * @var int
         */
        const COLOR_WHITE = NCURSES_COLOR_WHITE;

        /**
         * Red - supported when terminal is in color mode
         * @var int
         */
        const COLOR_RED = NCURSES_COLOR_RED;

        /**
         * Green - supported when terminal is in color mode
         * @var int
         */
        const COLOR_GREEN = NCURSES_COLOR_GREEN;

        /**
         * Yellow - supported when terminal is in color mode
         * @var int
         */
        const COLOR_YELLOW = NCURSES_COLOR_YELLOW;

        /**
         * Blue - supported when terminal is in color mode
         * @var int
         */
        const COLOR_BLUE = NCURSES_COLOR_BLUE;

        /**
         * Cyan - supported when terminal is in color mode
         * @var int
         */
        const COLOR_CYAN = NCURSES_COLOR_CYAN;

        /**
         * Magenta - supported when terminal is in color mode
         * @var int
         */
        const COLOR_MAGENTA = NCURSES_COLOR_MAGENTA;
    }
}



namespace NcursesObjects
{
    class Keys
    {
        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F1 = NCURSES_KEY_F1;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F2 = NCURSES_KEY_F2;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F3 = NCURSES_KEY_F3;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F4 = NCURSES_KEY_F4;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F5 = NCURSES_KEY_F5;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F6 = NCURSES_KEY_F6;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F7 = NCURSES_KEY_F7;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F8 = NCURSES_KEY_F8;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F9 = NCURSES_KEY_F9;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F10 = NCURSES_KEY_F10;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F11 = NCURSES_KEY_F11;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F12 = NCURSES_KEY_F12;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F13 = NCURSES_KEY_F13;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F14 = NCURSES_KEY_F14;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F15 = NCURSES_KEY_F15;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F16 = NCURSES_KEY_F16;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F17 = NCURSES_KEY_F17;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F18 = NCURSES_KEY_F18;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F19 = NCURSES_KEY_F19;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F20 = NCURSES_KEY_F20;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F21 = NCURSES_KEY_F21;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F22 = NCURSES_KEY_F22;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F23 = NCURSES_KEY_F23;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F24 = NCURSES_KEY_F24;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F25 = NCURSES_KEY_F25;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F26 = NCURSES_KEY_F26;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F27 = NCURSES_KEY_F27;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F28 = NCURSES_KEY_F28;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F29 = NCURSES_KEY_F29;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F30 = NCURSES_KEY_F30;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F31 = NCURSES_KEY_F31;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F32 = NCURSES_KEY_F32;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F33 = NCURSES_KEY_F33;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F34 = NCURSES_KEY_F34;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F35 = NCURSES_KEY_F35;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F36 = NCURSES_KEY_F36;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F37 = NCURSES_KEY_F37;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F38 = NCURSES_KEY_F38;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F39 = NCURSES_KEY_F39;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F40 = NCURSES_KEY_F40;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F41 = NCURSES_KEY_F41;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F42 = NCURSES_KEY_F42;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F43 = NCURSES_KEY_F43;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F44 = NCURSES_KEY_F44;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F45 = NCURSES_KEY_F45;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F46 = NCURSES_KEY_F46;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F47 = NCURSES_KEY_F47;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F48 = NCURSES_KEY_F48;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F49 = NCURSES_KEY_F49;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F50 = NCURSES_KEY_F50;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F51 = NCURSES_KEY_F51;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F52 = NCURSES_KEY_F52;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F53 = NCURSES_KEY_F53;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F54 = NCURSES_KEY_F54;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F55 = NCURSES_KEY_F55;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F56 = NCURSES_KEY_F56;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F57 = NCURSES_KEY_F57;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F58 = NCURSES_KEY_F58;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F59 = NCURSES_KEY_F59;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F60 = NCURSES_KEY_F60;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F61 = NCURSES_KEY_F61;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F62 = NCURSES_KEY_F62;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F63 = NCURSES_KEY_F63;

        /**
         * function keys f1-f64
         * @var int
         */
        const KEY_F64 = NCURSES_KEY_F64;

        /**
         * Left arrow
         * @var int
         */
        const KEY_LEFT = NCURSES_KEY_LEFT;

        /**
         * Right arrow
         * @var int
         */
        const KEY_RIGHT = NCURSES_KEY_RIGHT;

        /**
         * Home key (upward+left arrow)
         * @var int
         */
        const KEY_HOME = NCURSES_KEY_HOME;

        /**
         * Backspace
         * @var int
         */
        const KEY_BACKSPACE = NCURSES_KEY_BACKSPACE;

        /**
         * Delete line
         * @var int
         */
        const KEY_DL = NCURSES_KEY_DL;

        /**
         * Insert line
         * @var int
         */
        const KEY_IL = NCURSES_KEY_IL;

        /**
         * Delete character
         * @var int
         */
        const KEY_DC = NCURSES_KEY_DC;

        /**
         * Insert char or enter insert mode
         * @var int
         */
        const KEY_IC = NCURSES_KEY_IC;

        /**
         * Exit insert char mode
         * @var int
         */
        const KEY_EIC = NCURSES_KEY_EIC;

        /**
         * Clear screen
         * @var int
         */
        const KEY_CLEAR = NCURSES_KEY_CLEAR;

        /**
         * Clear to end of screen
         * @var int
         */
        const KEY_EOS = NCURSES_KEY_EOS;

        /**
         * Clear to end of line
         * @var int
         */
        const KEY_EOL = NCURSES_KEY_EOL;

        /**
         * Scroll one line forward
         * @var int
         */
        const KEY_SF = NCURSES_KEY_SF;

        /**
         * Scroll one line backward
         * @var int
         */
        const KEY_SR = NCURSES_KEY_SR;

        /**
         * Next page
         * @var int
         */
        const KEY_NPAGE = NCURSES_KEY_NPAGE;

        /**
         * Previous page
         * @var int
         */
        const KEY_PPAGE = NCURSES_KEY_PPAGE;

        /**
         * Set tab
         * @var int
         */
        const KEY_STAB = NCURSES_KEY_STAB;

        /**
         * Clear tab
         * @var int
         */
        const KEY_CTAB = NCURSES_KEY_CTAB;

        /**
         * Clear all tabs
         * @var int
         */
        const KEY_CATAB = NCURSES_KEY_CATAB;

        /**
         * Soft (partial) reset
         * @var int
         */
        const KEY_SRESET = NCURSES_KEY_SRESET;

        /**
         * Reset or hard reset
         * @var int
         */
        const KEY_RESET = NCURSES_KEY_RESET;

        /**
         * Print
         * @var int
         */
        const KEY_PRINT = NCURSES_KEY_PRINT;

        /**
         * Lower left
         * @var int
         */
        const KEY_LL = NCURSES_KEY_LL;

        /**
         * Upper left of keypad
         * @var int
         */
        const KEY_A1 = NCURSES_KEY_A1;

        /**
         * Upper right of keypad
         * @var int
         */
        const KEY_A3 = NCURSES_KEY_A3;

        /**
         * Center of keypad
         * @var int
         */
        const KEY_B2 = NCURSES_KEY_B2;

        /**
         * Lower left of keypad
         * @var int
         */
        const KEY_C1 = NCURSES_KEY_C1;

        /**
         * Lower right of keypad
         * @var int
         */
        const KEY_C3 = NCURSES_KEY_C3;

        /**
         * Back tab
         * @var int
         */
        const KEY_BTAB = NCURSES_KEY_BTAB;

        /**
         * Beginning
         * @var int
         */
        const KEY_BEG = NCURSES_KEY_BEG;

        /**
         * Cancel
         * @var int
         */
        const KEY_CANCEL = NCURSES_KEY_CANCEL;

        /**
         * Close
         * @var int
         */
        const KEY_CLOSE = NCURSES_KEY_CLOSE;

        /**
         * Cmd (command)
         * @var int
         */
        const KEY_COMMAND = NCURSES_KEY_COMMAND;

        /**
         * Copy
         * @var int
         */
        const KEY_COPY = NCURSES_KEY_COPY;

        /**
         * Create
         * @var int
         */
        const KEY_CREATE = NCURSES_KEY_CREATE;

        /**
         * End
         * @var int
         */
        const KEY_END = NCURSES_KEY_END;

        /**
         * Exit
         * @var int
         */
        const KEY_EXIT = NCURSES_KEY_EXIT;

        /**
         * Find
         * @var int
         */
        const KEY_FIND = NCURSES_KEY_FIND;

        /**
         * Help
         * @var int
         */
        const KEY_HELP = NCURSES_KEY_HELP;

        /**
         * Mark
         * @var int
         */
        const KEY_MARK = NCURSES_KEY_MARK;

        /**
         * Message
         * @var int
         */
        const KEY_MESSAGE = NCURSES_KEY_MESSAGE;

        /**
         * Move
         * @var int
         */
        const KEY_MOVE = NCURSES_KEY_MOVE;

        /**
         * Next
         * @var int
         */
        const KEY_NEXT = NCURSES_KEY_NEXT;

        /**
         * Open
         * @var int
         */
        const KEY_OPEN = NCURSES_KEY_OPEN;

        /**
         * Options
         * @var int
         */
        const KEY_OPTIONS = NCURSES_KEY_OPTIONS;

        /**
         * Previous
         * @var int
         */
        const KEY_PREVIOUS = NCURSES_KEY_PREVIOUS;

        /**
         * Redo
         * @var int
         */
        const KEY_REDO = NCURSES_KEY_REDO;

        /**
         * Ref (reference)
         * @var int
         */
        const KEY_REFERENCE = NCURSES_KEY_REFERENCE;

        /**
         * Refresh
         * @var int
         */
        const KEY_REFRESH = NCURSES_KEY_REFRESH;

        /**
         * Replace
         * @var int
         */
        const KEY_REPLACE = NCURSES_KEY_REPLACE;

        /**
         * Restart
         * @var int
         */
        const KEY_RESTART = NCURSES_KEY_RESTART;

        /**
         * Resume
         * @var int
         */
        const KEY_RESUME = NCURSES_KEY_RESUME;

        /**
         * Save
         * @var int
         */
        const KEY_SAVE = NCURSES_KEY_SAVE;

        /**
         * Shiftet beg (beginning)
         * @var int
         */
        const KEY_SBEG = NCURSES_KEY_SBEG;

        /**
         * Shifted cancel
         * @var int
         */
        const KEY_SCANCEL = NCURSES_KEY_SCANCEL;

        /**
         * Shifted command
         * @var int
         */
        const KEY_SCOMMAND = NCURSES_KEY_SCOMMAND;

        /**
         * Shifted copy
         * @var int
         */
        const KEY_SCOPY = NCURSES_KEY_SCOPY;

        /**
         * Shifted create
         * @var int
         */
        const KEY_SCREATE = NCURSES_KEY_SCREATE;

        /**
         * Shifted delete char
         * @var int
         */
        const KEY_SDC = NCURSES_KEY_SDC;

        /**
         * Shifted delete line
         * @var int
         */
        const KEY_SDL = NCURSES_KEY_SDL;

        /**
         * Select
         * @var int
         */
        const KEY_SELECT = NCURSES_KEY_SELECT;

        /**
         * Shifted end
         * @var int
         */
        const KEY_SEND = NCURSES_KEY_SEND;

        /**
         * Shifted end of line
         * @var int
         */
        const KEY_SEOL = NCURSES_KEY_SEOL;

        /**
         * Shifted exit
         * @var int
         */
        const KEY_SEXIT = NCURSES_KEY_SEXIT;

        /**
         * Shifted find
         * @var int
         */
        const KEY_SFIND = NCURSES_KEY_SFIND;

        /**
         * Shifted help
         * @var int
         */
        const KEY_SHELP = NCURSES_KEY_SHELP;

        /**
         * Shifted home
         * @var int
         */
        const KEY_SHOME = NCURSES_KEY_SHOME;

        /**
         * Shifted input
         * @var int
         */
        const KEY_SIC = NCURSES_KEY_SIC;

        /**
         * Shifted left arrow
         * @var int
         */
        const KEY_SLEFT = NCURSES_KEY_SLEFT;

        /**
         * Shifted message
         * @var int
         */
        const KEY_SMESSAGE = NCURSES_KEY_SMESSAGE;

        /**
         * Shifted move
         * @var int
         */
        const KEY_SMOVE = NCURSES_KEY_SMOVE;

        /**
         * Shifted next
         * @var int
         */
        const KEY_SNEXT = NCURSES_KEY_SNEXT;

        /**
         * Shifted options
         * @var int
         */
        const KEY_SOPTIONS = NCURSES_KEY_SOPTIONS;

        /**
         * Shifted previous
         * @var int
         */
        const KEY_SPREVIOUS = NCURSES_KEY_SPREVIOUS;

        /**
         * Shifted print
         * @var int
         */
        const KEY_SPRINT = NCURSES_KEY_SPRINT;

        /**
         * Shifted redo
         * @var int
         */
        const KEY_SREDO = NCURSES_KEY_SREDO;

        /**
         * Shifted replace
         * @var int
         */
        const KEY_SREPLACE = NCURSES_KEY_SREPLACE;

        /**
         * Shifted right arrow
         * @var int
         */
        const KEY_SRIGHT = NCURSES_KEY_SRIGHT;

        /**
         * Shifted resume
         * @var int
         */
        const KEY_SRSUME = NCURSES_KEY_SRSUME;

        /**
         * Shifted save
         * @var int
         */
        const KEY_SSAVE = NCURSES_KEY_SSAVE;

        /**
         * Shifted suspend
         * @var int
         */
        const KEY_SSUSPEND = NCURSES_KEY_SSUSPEND;

        /**
         * Undo
         * @var int
         */
        const KEY_UNDO = NCURSES_KEY_UNDO;

        /**
         * Mouse event has occurred
         * @var int
         */
        const KEY_MOUSE = NCURSES_KEY_MOUSE;

        /**
         * Maximum key value
         * @var int
         */
        const KEY_MAX = NCURSES_KEY_MAX;

        /**
         * Up key value
         * @var int
         */
        const KEY_UP = NCURSES_KEY_UP;

        /**
         * Down key value
         * @var int
         */
        const KEY_DOWN = NCURSES_KEY_DOWN;

        /**
         * Enter key value
         * @var int
         */
        const KEY_ENTER = 10;

        /**
         * Esc key value
         * @var int
         */
        const KEY_ESC = 27;
    }
}



namespace NcursesObjects
{
    class MouseEvents
    {
        /**
         * Button (1-4) released
         * @var int
         */
        const BUTTON1_RELEASED = NCURSES_BUTTON1_RELEASED;
        const BUTTON2_RELEASED = NCURSES_BUTTON2_RELEASED;
        const BUTTON3_RELEASED = NCURSES_BUTTON3_RELEASED;
        const BUTTON4_RELEASED = NCURSES_BUTTON4_RELEASED;

        /**
         * Button (1-4) pressed
         * @var int
         */
        const BUTTON1_PRESSED = NCURSES_BUTTON1_PRESSED;
        const BUTTON2_PRESSED = NCURSES_BUTTON2_PRESSED;
        const BUTTON3_PRESSED = NCURSES_BUTTON3_PRESSED;
        const BUTTON4_PRESSED = NCURSES_BUTTON4_PRESSED;

        /**
         * Button (1-4) clicked
         * @var int
         */
        const BUTTON1_CLICKED = NCURSES_BUTTON1_CLICKED;
        const BUTTON2_CLICKED = NCURSES_BUTTON2_CLICKED;
        const BUTTON3_CLICKED = NCURSES_BUTTON3_CLICKED;
        const BUTTON4_CLICKED = NCURSES_BUTTON4_CLICKED;

        /**
         * Button (1-4) double clicked
         * @var int
         */
        const BUTTON1_DOUBLE_CLICKED = NCURSES_BUTTON1_DOUBLE_CLICKED;
        const BUTTON2_DOUBLE_CLICKED = NCURSES_BUTTON2_DOUBLE_CLICKED;
        const BUTTON3_DOUBLE_CLICKED = NCURSES_BUTTON3_DOUBLE_CLICKED;
        const BUTTON4_DOUBLE_CLICKED = NCURSES_BUTTON4_DOUBLE_CLICKED;

        /**
         * Button (1-4) triple clicked
         * @var int
         */
        const BUTTON1_TRIPLE_CLICKED = NCURSES_BUTTON1_TRIPLE_CLICKED;
        const BUTTON2_TRIPLE_CLICKED = NCURSES_BUTTON2_TRIPLE_CLICKED;
        const BUTTON3_TRIPLE_CLICKED = NCURSES_BUTTON3_TRIPLE_CLICKED;
        const BUTTON4_TRIPLE_CLICKED = NCURSES_BUTTON4_TRIPLE_CLICKED;

        /**
         * Ctrl pressed during click
         * @var int
         */
        const BUTTON_CTRL = NCURSES_BUTTON_CTRL;

        /**
         * Shift pressed during click
         * @var int
         */
        const BUTTON_SHIFT = NCURSES_BUTTON_SHIFT;

        /**
         * Alt pressed during click
         * @var int
         */
        const BUTTON_ALT = NCURSES_BUTTON_ALT;

        /**
         * Report all mouse events
         * @var int
         */
        const ALL_MOUSE_EVENTS = NCURSES_ALL_MOUSE_EVENTS;

        /**
         * Report mouse position
         * @var int
         */
        const REPORT_MOUSE_POSITION = NCURSES_REPORT_MOUSE_POSITION;
    }
}



namespace NcursesObjects
{
    function ncurses_init()
    {
        if (function_exists('\ncurses_init')) {
            return \ncurses_init();
        }
        throw new \RuntimeException("Library <ncurses> in not loaded.");
    }

    /**
     * A ncurses object that implements functionality for main ncurses functions
     * @author wapmorgan (wapmorgan@gmail.com)
     */
    class Ncurses
    {
        const KEY_LF  = 10;
        const KEY_CR  = 13;
        const KEY_ESC = 27;
        const KEY_TAB = 9;

        const CURSOR_INVISIBLE = 0;
        const CURSOR_NORMAL    = 1;
        const CURSOR_VISIBLE   = 2;

        /**
         * @var Terminal
         */
        private $terminal;

        /**
         * Inits ncurses
         */
        public function __construct()
        {
            ncurses_init();
        }

        /**
         * Destructs ncurses
         */
        public function __destruct()
        {
            ncurses_end();
        }

        /**
         * @return Terminal
         */
        public function getTerminal()
        {
            if (is_null($this->terminal))
                $this->terminal = new Terminal;
            return $this->terminal;
        }

        /**
         * Sets echo state
         * @param bool $state True of false
         * @see http://www.php.net/manual/en/function.ncurses-echo.php
         * @return Ncurses This object
         */
        public function setEchoState($state)
        {
            if ($state)
                ncurses_echo();
            else
                ncurses_noecho();
            return $this;
        }

        /**
         * Sets new-line translation state
         * @param bool $state True of false
         * @return Ncurses This object
         */
        public function setNewLineTranslationState($state)
        {
            if ($state)
                ncurses_nl();
            else
                ncurses_nonl();
            return $this;
        }

        /**
         * Sets cursor state
         * @param integer $state CURSOR_INVISIBLE, CURSOR_NORMAL or CURSOR_VISIBLE
         * @return Ncurses This object
         */
        public function setCursorState($state)
        {
            ncurses_curs_set($state);
            return $this;
        }

        /**
         * Moves the main cursor
         * @param integer $y Row
         * @param integer $x Column
         * @return Ncurses This object
         */
        public function moveOutput($y, $x)
        {
            ncurses_move($y, $x);
            return $this;
        }

        /**
         * Refreshes the main window
         * @return Ncurses This object
         */
        public function refresh()
        {
            ncurses_refresh();
            return $this;
        }

        /**
         * Lets the terminal beep
         * @return Ncurses This object
         */
        public function beep()
        {
            ncurses_beep();
            return $this;
        }

        /**
         * Reads a char from keyboard
         * @return int Ascii-code of char
         * @see Keys for keys
         */
        public function getCh()
        {
            return ncurses_getch();
        }

        /**
         * @param $ch
         * @return int
         */
        public function unGetCh($ch)
        {
            return ncurses_ungetch($ch);
        }

        /**
         * Refreshes the virtual screen to reflect the relations between panels in the stack
         * and
         * Write all prepared refreshes to terminal
         */
        public function updatePanels()
        {
            ncurses_update_panels();
            ncurses_doupdate();
            return $this;
        }

        /**
         * @param $char
         * @return $this
         */
        public function insertChar($char)
        {
            ncurses_insch($char);
            return $this;
        }

        /**
         * @param $count
         * @return $this
         */
        public function insertDeleteLines($count)
        {
            ncurses_insdelln($count);
            return $this;
        }

    }
}



namespace NcursesObjects
{
    /**
     * A panel object that implements functionality for ncurses panel resource
     * @author wapmorgan (wapmorgan@gmail.com)
     */
    class Panel {
        /**
         * Associated Window
         */
        private $window;
        /**
         * Ncurses panel resource
         */
        private $panelResource;

        /**
         * Constructor
         * @param Window A window to associate
         */
        public function __construct(Window $window) {
            $this->window = $window;
            $this->panelResource = ncurses_new_panel($window->getWindow());
        }

        /**
         * Shows a panel
         * @return Panel This object
         */
        public function show() {
            ncurses_show_panel($this->panelResource);
            return $this;
        }

        /**
         * Hides a panel
         * @return Panel This object
         */
        public function hide() {
            ncurses_hide_panel($this->panelResource);
            return $this;
        }

        /**
         * Puts a panel on the top
         * @return Panel This object
         */
        public function putOnTop() {
            ncurses_top_panel($this->panelResource);
            return $this;
        }

        /**
         * Puts a panel on the bottom
         * @return Panel This object
         */
        public function putOnBottom() {
            ncurses_bottom_panel($this->panelResource);
            return $this;
        }

        public function getWindow()
        {
            return $this->window;
        }

        public function getPanel()
        {
            return $this->panelResource;
        }
    }
}



namespace NcursesObjects
{
    class Terminal {
        /**
         * @param $keycode
         * @return int
         */
        public function hasKey($keycode) {
            return ncurses_has_key($keycode);
        }

        /**
         * @return bool
         */
        public function hasColors() {
            return ncurses_has_colors();
        }

        /**
         * @return bool
         */
        public function hasIC() {
            return ncurses_has_ic();
        }

        /**
         * @return bool
         */
        public function hasIL() {
            return ncurses_has_il();
        }

        public function allAtributes() {
            return ncurses_termattrs();
        }

        public function termName() {
            return ncurses_termname();
        }

        public function longName() {
            return ncurses_longname();
        }
    }
}



namespace NcursesObjects
{
    /**
     * A window object that implements functionality for ncurses window resource
     * @author wapmorgan (wapmorgan@gmail.com)
     */
    class Window {
        /**
         * ncurses window resource
         */
        private $windowResource;
        /**
         * associated Panel
         */
        private $panel;
        /**
         * cursor position
         */
        private $cursorX;
        private $cursorY;

        const BORDER_STYLE_SOLID = 1; // ┐
        const BORDER_STYLE_DOUBLE = 2; // ╗
        const BORDER_STYLE_BLOCK = 3; // ■

        /**
         * window geometry
         */
        private $rows;
        private $columns;
        private $x;
        private $y;

        /**
         * @var WindowStyle
         */
        protected $style;
        private $title = '';
        private $status = '';
        private $frame;

        /**
         * Create a window
         *
         * @param int $columns
         * @param int $rows
         * @param int $x
         * @param int $y
         */
        public function __construct($columns = 0, $rows = 0, $x = 0, $y = 0) {
            $this->x = $x;
            $this->y = $y;
            $this->windowResource = ncurses_newwin($rows, $columns, $y, $x);
            if ($rows == 0 || $columns == 0)
                $this->getSize($columns, $rows);
            $this->columns = $columns;
            $this->rows = $rows;
            $this->frame = [
                'draw' => [],
                'border' => null,
            ];
        }

        /**
         * Destructs a window and associated panel
         */
        public function __destruct() {
            if ($this->panel !== null)
                $this->panel = null;
            ncurses_delwin($this->windowResource);
        }

        /**
         * Returns a ncurses window resource
         * @return resource
         */
        public function getWindow() {
            return $this->windowResource;
        }

        /**
         * Gets window size
         * @param int $columns Will be filled with window columns
         * @param int $rows Will be filled with window rows
         * @return array An array with elements 'columns' and 'rows'
         */
        public function getSize(&$columns = null, &$rows = null) {
            ncurses_getmaxyx($this->windowResource, $rows, $columns);
            return array('columns' => $columns, 'rows' => $rows);
        }

        public function getWidth()
        {
            $this->getSize($width, $height);
            return $width;
        }

        public function getHeight()
        {
            $this->getSize($width, $height);
            return $height;
        }

        public function getCursorXY(&$x = null, &$y = null)
        {
            ncurses_getyx($this->windowResource, $y, $x);
            return array('x' => $x, 'y' => $y);
        }

        public function getX()
        {
            return $this->x;
        }

        public function getY()
        {
            return $this->y;
        }

        /**
         * Draws a border around this window
         * @return Window This object
         */
        public function border($left = 0, $right = 0, $top = 0, $bottom = 0, $tl_corner = 0, $tr_corner = 0, $bl_corner = 0, $br_corner = 0) {
            ncurses_wborder($this->windowResource, $left, $right, $top, $bottom, $tl_corner, $tr_corner, $bl_corner, $br_corner);
            $this->frame['border'] = true;
            return $this;
        }

        /**
         * Draws a border with non-usual style
         * @param integer $style Can be BORDER_STYLE_SOLID, BORDER_STYLE_DOUBLE or BORDER_STYLE_BLOCK
         * @return Window This object
         */
        public function borderStyle($style) {
            if ($style == self::BORDER_STYLE_SOLID) {
                $this->border();
            }
            elseif($style == self::BORDER_STYLE_DOUBLE) {
                $this->border(226, 186, 205, 205, 201, 187, 200, 188);
//            $this->border(ord('║'), ord('║'), ord('═'), ord('═'), ord('╔'), ord('╗'), ord('╚'), ord('╝'));
            }
            return $this;
        }

        /**
         * Refreshes (redraws) a window
         * @return Window This object
         */
        public function refresh() {
            ncurses_wrefresh($this->windowResource);
            return $this;
        }

        /**
         * Draws a window title
         * @param string $title Title
         * @return Window This object
         */
        public function title($title) {
            $this->moveCursor(1, 0);
            $this->title = " {$title} ";
            $this->drawStringHere($this->title, NCURSES_A_REVERSE);
            return $this;
        }

        /**
         * Draws a window status (a line at the bottom)
         * @param string $status Status
         * @return Window This object
         */
        public function status($status) {
            $this->moveCursor(1, $this->rows -1 );
            $this->status = " {$status} ";
            $this->drawStringHere($this->status, NCURSES_A_REVERSE);
            return $this;
        }

        public function getTitle()
        {
            return $this->title;
        }

        public function getStatus()
        {
            return $this->status;
        }

        /**
         * Erases a window
         * @return Window This object
         */
        public function erase() {
            $this->frame = [
                'draw' => [],
                'border' => null,
            ];
            ncurses_werase($this->windowResource);
            return $this;
        }

        /**
         * Moves a cursor
         * @param integer $x Cursor column
         * @param integer $y Cursor row
         * @return Window This object
         */
        public function moveCursor($x, $y) {
            $this->cursorX = $x;
            $this->cursorY = $y;
            ncurses_wmove($this->windowResource, $y, $x);
            return $this;
        }

        /**
         * Draws a string at current position
         * @param string $string String
         * @param integer $attributes Ncurses attributes (eg. NCURSES_A_REVERSE)
         * @see http://pubs.opengroup.org/onlinepubs/007908799/xcurses/curses.h.html for available attributes (WA_LOW => NCURSES_A_LOW)
         * @return Window This object
         */
        public function drawStringHere($string, $attributes = 0) {
            ncurses_wattron($this->windowResource, $attributes);
            ncurses_waddstr($this->windowResource, $string);
            ncurses_wattroff($this->windowResource, $attributes);
            $this->frame['draw'][] = ['string' => $string, 'attributes' => $attributes, 'x' => $this->cursorX, 'y' => $this->cursorY];
            return $this;
        }

        /**
         * Makes a panel associated with this window
         * @return $this
         */
        public function makePanel() {
            $this->panel = new Panel($this);
            return $this;
        }

        /**
         * Returns a Panel associated with this window
         * @return Panel or null
         */
        public function getPanel() {
            return $this->panel;
        }

        public function reload()
        {
            $frame = $this->frame;

            $this->erase();

            if ($frame['border']) {
                $this->border();
            }

            foreach ($frame['draw'] as $item) {
                $this->moveCursor($item['x'], $item['y'])->drawStringHere($item['string'], $item['attributes']);
            }

            $this->refresh();
        }

        /**
         * Makes a window that will be in center of the screen
         * @param Window $parentWindow A window that will be major for new window
         * @param integer $columns New window columns count
         * @param integer $row New window rows count
         * @return Window A new window that centered of parent window
         */
        static public function createCenteredOf(Window $parentWindow, $columns, $rows) {
            $parentWindow->getSize($max_columns, $max_rows);
            return new Window($columns, $rows, ($max_columns / 2 - $columns / 2), ($max_rows / 2 - $rows / 2));
        }
    }
}



namespace NcursesObjects
{
    class WindowStyle {

        /**
         * @var string
         */
        const BORDER_STYLE_SOLID = 'solid';
        /**
         * @var string
         */
        const BORDER_STYLE_DOUBLE = 'double';
        /**
         * @var string
         */
        const BORDER_STYLE_BLOCK = 'block';

        /**
         * @var int
         */
        protected $borderWidth = 1;

        /**
         * @var string
         */
        protected $borderStyle = 'solid';

        /**
         * @param $style
         */
        public function setBorderStyle($style) {
            $enum = array(self::BORDER_STYLE_SOLID, self::BORDER_STYLE_DOUBLE, self::BORDER_STYLE_BLOCK);
            if (in_array($style, $enum))
                $this->borderStyle = $style;
        }

        /**
         * @return string
         */
        public function getBorderStyle() {
            return $this->borderStyle;
        }

        /**
         * @param $width
         */
        public function setBorderWidth($width) {
            $width = intval($width, 10);
            if ($width > 1) {
                $this->borderWidth = $width;
            }
        }

        /**
         * @return int
         */
        public function getBorderWidth() {
            return $this->borderWidth;
        }
    }
}

namespace { 

class Text
{
    public static function isUtf16($text) {
        preg_match_all('/\x00/', $text, $count);

        if (count($count[0]) / strlen($text) > 0.4) {
            return true;
        }

        return false;
    }

    public static function normalize($text) {
        if (self::isUtf16($text)) {
            $text = mb_convert_encoding($text, 'UTF-8', 'UTF-16');
        } elseif (md5(@iconv('Windows-1251', 'Windows-1251', $text)) !== md5(@iconv('UTF-8', 'UTF-8', $text))) {
            $text = mb_convert_encoding($text, 'UTF-8', 'Windows-1251');
        }

        return $text;
    }

    /**
     * @param string       $haystack
     * @param array|string $needle
     *
     * @return bool
     */
    public static function startsWith($haystack, $needle)
    {
        if (is_array($needle)) {
            foreach ($needle as $str) {
                if (strpos($haystack, $str) === 0) {
                    return true;
                }
            }
            return false;
        }

        return (string)$needle === "" || strpos($haystack, (string)$needle) === 0;
    }

    /**
     * @param string       $haystack
     * @param array|string $needle
     *
     * @return bool
     */
    public static function endsWith($haystack, $needle)
    {
        if (is_array($needle)) {
            foreach ($needle as $str) {
                if (substr($haystack, -strlen($str)) === $str) {
                    return true;
                }
            }
            return false;
        }

        return (string)$needle === "" || substr($haystack, (string)-strlen($needle)) === $needle;
    }

    public static function quoteArgs($args)
    {
        return implode(' ', array_map(function ($a) {return "\"{$a}\"";}, (array)$args));
    }
}



if (!function_exists('app')) {
    /**
     * @param null|Start $type
     * @return ControllerGUI|Start
     */
    function app($type = null) {
        static $gui;
        static $start;

        if (null === $gui && $type === 'gui') {
            $gui = new ControllerGUI();
        }

        if (null === $start && $type && $type instanceof Start) {
            $start = $type;
        }

        if ($type === 'start') {
            return $start;
        }

        return $gui;
    }
}

if (!function_exists('debug_string_backtrace')) {
    function debug_string_backtrace($text = null, $config = null) {

        /** @var Config $config */
        $config = null === $config ? app('start')->getConfig() : $config;

        if (is_string($config)) {
            $file = $config;
        } else {
            $file = $config->getLogsDir() . '/debug.log';
        }


        static $init;

        if (null === $init) {
            $init = true;

            if (file_exists($file)) {
                @unlink($file);
            }
        }

        if (null === $text) {
            ob_start();

            static $time;

            if (null === $time) {
                $time = microtime(true);
                print "Time: 0\n\n";
            } else {
                print 'Time: ' . (microtime(true) - $time) . "\n\n";
            }

            debug_print_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS);
            $trace = ob_get_contents();
            ob_end_clean();

            // Remove first item from backtrace as it's this function which
            // is redundant.
            $trace = preg_replace ('/^#0\s+' . __FUNCTION__ . "[^\n]*\n/", '', $trace, 1);

            // Renumber backtrace items.
            $trace = preg_replace ('/^#(\d+)/me', '\'#\' . ($1 - 1)', $trace);

            $trace = implode("\n", array_map(function ($n) {list($a) = explode('called at', $n); return trim($a);}, explode("\n", $trace)));
        } else {
            $trace = $text;
        }

        file_put_contents($file, "{$trace}\n\n", FILE_APPEND);

        return "{$trace}\n\n";
    }
}



class FileINI {

    private $file;

    /**
     * FileINI constructor.
     * @param $path
     */
    public function __construct($path)
    {
        $this->file = $path;
    }

    public function get()
    {
        return file_exists($this->file) ? parse_ini_file($this->file, true) : [];
    }

    public function write($array = [])
    {
        $file = $this->file;
        if (!is_string($file)) { throw new \InvalidArgumentException('Function argument 1 must be a string.'); }
        if (!is_array($array)) { throw new \InvalidArgumentException('Function argument 2 must be an array.'); }
        $data = array();
        foreach ($array as $key => $val) {
            if (is_array($val)) {
                $data[] = "[$key]";
                foreach ($val as $skey => $sval) {
                    if (is_array($sval)) {
                        foreach ($sval as $_skey => $_sval) {
                            if (is_numeric($_skey)) { $data[] = $skey . '[] = ' . (is_numeric($_sval) ? $_sval : (ctype_upper($_sval) ? $_sval : '"' . $_sval . '"')); }
                            else { $data[] = $skey . '[' . $_skey . '] = ' . (is_numeric($_sval) ? $_sval : (ctype_upper($_sval) ? $_sval : '"' . $_sval . '"')); }
                        }
                    } else { $data[] = $skey . ' = ' . (is_numeric($sval) ? $sval : (ctype_upper($sval) ? $sval : '"' . $sval . '"')); }
                }
            } else { $data[] = $key . ' = ' . (is_numeric($val) ? $val : (ctype_upper($val) ? $val : '"' . $val . '"')); }
            $data[] = null;
        }
        $fp          = fopen($file, 'w');
        $retries     = 0;
        $max_retries = 100;
        if (!$fp) { return false; }
        do { if ($retries > 0) { usleep(rand(1, 5000)); } $retries += 1;
        } while (!flock($fp, LOCK_EX) && $retries <= $max_retries);
        if ($retries == $max_retries) { return false; }
        fwrite($fp, implode(PHP_EOL, $data) . PHP_EOL);
        flock($fp, LOCK_UN);
        fclose($fp);

        return true;
    }
}



class Logs {

    private $table  = false;
    private $length = 80;

    public function insertLogFile($text, $path)
    {
        @file_put_contents($path, "{$text}\n", FILE_APPEND);
    }

    public function log($text='', $symbols = [], $lenght = 0, $return = false)
    {
        if (!$symbols && $this->table === true) {
            $symbols = 'line';
            $lenght  = $this->length;
            $items   = explode("\n", $text);

            if (count($items) > 1) {
                foreach ($items as $item) {
                    $this->log($item);
                }
                return;
            }
        }

        if ($symbols === 'head') {
            $symbols = ['start' => '╔', 'space' => '═', 'end' => '╗'];
        } elseif ($symbols === 'line') {
            $symbols = ['start' => '║ ', 'space' => ' ', 'end' => ' ║'];
        } elseif ($symbols === 'footer') {
            $symbols = ['start' => '╚', 'space' => '═', 'end' => '╝'];
        } elseif ($symbols === 'hr') {
            $symbols = ['start' => '╟', 'space' => '─', 'end' => '╢'];
        }

        $symbols = [
            'start' => isset($symbols['start']) ? $symbols['start'] : '',
            'space' => isset($symbols['space']) ? $symbols['space'] : ' ',
            'end'   => isset($symbols['end'])   ? $symbols['end']   : '',
        ];

        if ($lenght > 0) {
            $text    = "{$symbols['start']}{$text}";
            $len     = mb_strlen($text);
            $compare = $lenght - $len;

            if ($compare > 0) {

                $len2 = $compare - (1 + mb_strlen($symbols['end']));

                if ($len2 > 0) {
                    $end = [];
                    foreach (range(1, $len2) as $i) {
                        $end[] = $symbols['space'];
                    }
                    $end[] = $symbols['end'];
                    $end   = implode('', $end);
                    $text = "{$text}{$end}";
                }
            } else {
                $text = "{$text}{$symbols['space']}{$symbols['end']}";
            }
        }

        if ($return) {
            return $text;
        }

        print "{$text}\n";
    }

    public function logStart()
    {
        if ($this->table === false) {
            $this->log('', 'head', $this->length);
        }

        $this->table = true;
    }

    public function logStop()
    {
        if ($this->table === true) {
            $this->log('', 'footer', $this->length);
        }

        $this->table = false;
    }
}



class Buffer {

    private $size = 150;
    private $buffer;
    private $changes;

    /**
     * Buffer constructor.
     */
    public function __construct()
    {
        $this->buffer  = [];
        $this->changes = [];
    }

    public function setSize($size)
    {
        $this->size = $size;
    }

    public function add($text)
    {
        if (count($this->buffer) <= $this->size) {
            $this->buffer[] = $text;
        } else {
            array_shift($this->buffer);
            $this->buffer[] = $text;
        }

        $this->doChange();
    }

    private function doChange() {
        foreach ($this->changes as $change) {
            if ($change) {
                $change($this->buffer);
            }
        }
    }

    public function onChangeEvent($callable)
    {
        $this->changes[] = $callable;
    }

    public function offChangeEvent($callable)
    {
        $this->changes = array_filter($this->changes, function ($item) use (&$callable) {return $item !== $callable;});
    }

    public function clear()
    {
        $this->buffer = [];
    }
}



class History
{
    private $history;

    /**
     * History constructor.
     */
    public function __construct()
    {
        $this->history = [];
    }

    public function add(&$object)
    {
        $this->history[] = $object;
    }

    public function back()
    {
        array_pop($this->history);
        return $this->current();
    }

    public function current()
    {
        return end($this->history);
    }

    public function count()
    {
        return count($this->history);
    }
}



class FileSystem {

    private $command;
    private $config;

    /**
     * FileSystem constructor.
     * @param Config $config
     * @param Command $command
     */
    public function __construct(Config $config, Command $command)
    {
        $this->command = $command;
        $this->config  = $config;
    }

    public static function getDirectorySize($path)
    {
        $bytes = 0;
        $path  = realpath($path);

        if ($path !== false && $path != '' && file_exists($path)) {
            foreach (new RecursiveIteratorIterator(new RecursiveDirectoryIterator($path, FilesystemIterator::SKIP_DOTS)) as $object) {
                $bytes += $object->getSize();
            }
        }

        return $bytes;
    }

    public function relativePath($absPath, $path = null)
    {
        return trim(str_replace($path === null ? $this->config->getRootDir() : $path, '', $absPath), " \t\n\r\0\x0B/");
    }

    public function rm($dir)
    {
        if (file_exists($dir) && !is_dir($dir)) {
            unlink($dir);
            return true;
        }

        if (is_dir($dir)) {
            $objects = scandir($dir, SCANDIR_SORT_NONE);
            foreach ($objects as $object) {
                if ($object !== '.' && $object !== '..') {
                    if (is_dir("{$dir}/{$object}")) {
                        $this->rm("{$dir}/{$object}");
                    } else {
                        unlink("{$dir}/{$object}");
                    }
                }
            }
            rmdir($dir);
        }

        return true;
    }

    public function cp($in, $out)
    {
        if (file_exists($in) && !is_dir($in)) {
            copy($in, $out);
            return true;
        }

        if (!file_exists($in) || !is_dir($in)) {
            return false;
        }

        $mode = 0775;

        if (!mkdir($out, $mode, true) && !is_dir($out)) {
            throw new \RuntimeException(sprintf('Directory "%s" was not created', $out));
        }

        foreach (
            $iterator = new \RecursiveIteratorIterator(
                new \RecursiveDirectoryIterator($in, \RecursiveDirectoryIterator::SKIP_DOTS),
                \RecursiveIteratorIterator::SELF_FIRST) as $item
        ) {
            if ($item->isDir()) {
                if (!mkdir($concurrentDirectory = $out . DIRECTORY_SEPARATOR . $iterator->getSubPathName(), $mode) && !is_dir($concurrentDirectory)) {
                    throw new \RuntimeException(sprintf('Directory "%s" was not created', $concurrentDirectory));
                }
            } else {
                copy($item, $out . DIRECTORY_SEPARATOR . $iterator->getSubPathName());
            }
        }

        return true;
    }

    public function mv($in, $out)
    {
        if (file_exists($in) && !is_dir($in)) {
            rename($in, $out);
            return true;
        }

        if (!is_dir($in) || file_exists($out)) {
            return false;
        }

        $mode = 0775;

        if (!mkdir($out, $mode, true) && !is_dir($out)) {
            throw new \RuntimeException(sprintf('Directory "%s" was not created', $out));
        }

        foreach (new DirectoryIterator($in) as $iterator) {
            if ($iterator->isFile()) {
                rename($iterator->getRealPath(), "{$out}/" . $iterator->getFilename());
            } else if (!$iterator->isDot() && $iterator->isDir()) {
                $this->mv($iterator->getRealPath(), "{$out}/{$iterator}");
                if (file_exists($iterator->getRealPath())) {
                    if (is_dir($iterator->getRealPath())) {
                        rmdir($in);
                    } else {
                        unlink($iterator->getRealPath());
                    }
                }
            }
        }

        if (file_exists($in)) {
            if (is_dir($in)) {
                rmdir($in);
            } else {
                unlink($in);
            }
        }

        return true;
    }

    public function mkdirs($dirs)
    {
        foreach ($dirs as $dir) {
            if (!file_exists($dir)) {
                if (!mkdir($dir, 0775, true) && !is_dir($dir)) {
                    throw new \RuntimeException(sprintf('Directory "%s" was not created', $dir));
                }
            }
        }
    }

    public function link($in, $out)
    {
        return $this->command->run("ln -sfr \"{$in}\" \"{$out}\"");
    }
}



class Command {

    private $config;
    private $prefix;

    /**
     * Command constructor.
     * @param Config $config
     */
    public function __construct(Config $config)
    {
        $this->config = $config;
        $this->prefix = new WinePrefix($this->config, $this);
    }


    /**
     * @param string $cmd
     * @param string|null $saveLog
     * @param bool $outputConsole
     * @return bool|string
     */
    public function run($cmd, $saveLog = null, $outputConsole = false)
    {
        if (null !== $saveLog && file_exists($saveLog)) {
            @unlink($saveLog);
        }

        $cmd = $this->cast($cmd);

        if ($outputConsole) {

            system($cmd);

            return '';
        }

        $descriptorspec = array(
            0 => array('pipe', 'r'), // stdin is a pipe that the child will read from
            1 => array('pipe', 'w'), // stdout is a pipe that the child will write to
            2 => array('pipe', 'w') // stderr is a file to write to
        );

        $pipes = array();
        $process = proc_open($cmd, $descriptorspec, $pipes);

        $output = "";

        if (!is_resource($process)) return false;

        #close child's input imidiately
        fclose($pipes[0]);

        stream_set_blocking($pipes[1], false);
        stream_set_blocking($pipes[2], false);

        $todo = array($pipes[1], $pipes[2]);

        while (true) {
            $read = array();
            if (!feof($pipes[1])) $read[] = $pipes[1];
            if (!feof($pipes[2])) $read[] = $pipes[2];

            if (!$read) break;

            $ready = @stream_select($read, $write = NULL, $ex = NULL, 2);

            if ($ready === false) {
                break; #should never happen - something died
            }

            foreach ($read as $r) {
                $s = fread($r, 1024);
                if ($saveLog) {
                    @file_put_contents($saveLog, $s, FILE_APPEND);
                }
                $output .= $s;
            }
        }

        fclose($pipes[1]);
        fclose($pipes[2]);

        #$code = proc_close($process);

        return $output;
    }

    public function cast($cmd)
    {
        $this->prefix->createLibsDirectory();
        $dir = $this->config->getRootDir();

        $additionalWineLibs = "{$dir}/libs/i386:{$dir}/libs/x86-64";

        $exported = [
            'export WINE'             => $this->config->wine('WINE'),
            'export WINE64'           => $this->config->wine('WINE64'),
            'export WINEPREFIX'       => $this->config->wine('WINEPREFIX'),
            'export WINESERVER'       => $this->config->wine('WINESERVER'),
            'export WINEARCH'         => $this->config->wine('WINEARCH'),
            'export WINEDEBUG'        => $this->config->wine('WINEDEBUG'),
            'export WINEDLLOVERRIDES' => $this->config->wine('WINEDLLOVERRIDES'),
            'export LD_LIBRARY_PATH'  => "\$LD_LIBRARY_PATH:{$additionalWineLibs}",
            'export DXVK_CONFIG_FILE' => $this->config->getDxvkConfigFile(),
        ];

        if ($this->config->isDxvk()) {

            $cache = $this->config->getDxvkCacheDir();
            $logs  = $this->config->getDxvkLogsDir();

            $exported['export DXVK_STATE_CACHE_PATH'] = $cache;
            $exported['export DXVK_LOG_PATH']         = $logs;

            if (strpos($exported['export WINEDLLOVERRIDES'], 'nvapi') === false) {

                $overrides   = explode(';', $exported['export WINEDLLOVERRIDES']);
                $overrides[] = 'nvapi64,nvapi=';

                $exported['export WINEDLLOVERRIDES'] = implode(';', $overrides);
            }
        }

        if ($this->config->get('export')) {
            foreach ((array)$this->config->get('export') as $key => $value) {
                $exported["export {$key}"] = $value;
            }
        }

        $prefix = [];

        foreach ($exported as $key => $value) {
            $prefix[] = "{$key}=\"{$value}\";";
        }

        $prefix = implode(' ', $prefix);

        $cmd = "{$prefix} cd \"{$dir}\" && {$cmd}";

        return $cmd;
    }

    public function squashfuse($folder)
    {
        (new Update($this->config, $this))->downloadSquashfuse();

        $squashfuse = $this->config->getRootDir() . '/squashfuse';

        return $this->run(Text::quoteArgs($squashfuse) . ' ' . Text::quoteArgs("{$folder}.squashfs") . ' ' . Text::quoteArgs($folder));
    }

    public function zipfuse($folder)
    {
        (new Update($this->config, $this))->downloadFusezip();

        $zipfuse = $this->config->getRootDir() . '/fuse-zip';

        return $this->run(Text::quoteArgs($zipfuse) . ' ' . Text::quoteArgs("{$folder}.zip") . ' ' . Text::quoteArgs($folder));
    }

    public function umount($folder)
    {
        return $this->run('fusermount -u ' . Text::quoteArgs($folder));
    }
}



class Network {

    private static $isConnected;

    private $command;
    private $config;

    /**
     * Network constructor.
     * @param Config $config
     * @param Command $command
     */
    public function __construct(Config $config, Command $command)
    {
        $this->command = $command;
        $this->config  = $config;
    }

    public static function isConnected()
    {
        if (self::$isConnected !== null) {
            return self::$isConnected;
        }

        $connected = @fsockopen('8.8.8.8', 53, $errno,$errstr, 5);

        if ($connected) {
            self::$isConnected = true;
            fclose($connected);
        } else {
            self::$isConnected = false;
        }

        return self::$isConnected;
    }

    public function get($url)
    {
        return file_get_contents($url, false, stream_context_create($this->config->getContextOptions()));
    }

    public function getRepo($url)
    {
        return $this->get($this->config->getRepositoryUrl() . $url);
    }
}



class System {

    private $command;
    private $config;

    /**
     * System constructor.
     * @param Config $config
     * @param Command $command
     */
    public function __construct(Config $config, Command $command)
    {
        $this->command = $command;
        $this->config  = $config;
    }

    public function getUserName()
    {
        static $userName = null;

        if ($userName === null) {
            $userName = trim($this->command->run('id -u -n'));
        }

        return $userName;
    }

    public function getDesktopPath()
    {
        $isXdg = (bool)trim($this->command->run('which xdg-user-dir'));

        if ($isXdg) {
            return trim($this->command->run('xdg-user-dir DESKTOP'));
        }

        return '';
    }

    public function getCPU()
    {
        static $result;

        if (null === $result) {
            $cpuinfo = explode("\n", trim($this->command->run('cat /proc/cpuinfo')));

            foreach ($cpuinfo as $line) {
                if (strpos($line, 'model name') !== false) {
                    $line = explode(':', $line);
                    $result = trim(end($line));
                    return $result;
                }
            }

            $result = '';
        }

        return $result;
    }

    public function getGPU()
    {
        static $result;

        if (null === $result) {
            $gpuinfo = explode("\n", trim($this->command->run('glxinfo')));

            foreach ($gpuinfo as $line) {
                if (strpos($line, 'Device') !== false) {
                    $line = explode(':', $line);
                    $result = trim(end($line));
                    break;
                }
            }

            if (!$result) {
                $result = trim($this->command->run('lspci | grep VGA | cut -d ":" -f3'));
            }
        }

        return $result;
    }

    public function getRAM()
    {
        static $result;

        if (null === $result) {
            $meminfo = explode("\n", trim($this->command->run('cat /proc/meminfo')));

            foreach ($meminfo as $line) {
                if (strpos($line, 'MemTotal') !== false) {
                    $line = explode(':', $line);
                    $line = array_filter(explode(' ', end($line)));
                    $line = trim(reset($line));
                    $line = round($line / 1024);

                    $result = $line;

                    return $result;
                }
            }

            $result = '';
        }

        return $result;
    }

    public function getFreeRAM()
    {
        $meminfo = explode("\n", trim($this->command->run('cat /proc/meminfo')));

        foreach ($meminfo as $line) {
            if (strpos($line, 'MemAvailable') !== false) {
                $line = explode(':', $line);
                $line = array_filter(explode(' ', end($line)));
                $line = trim(reset($line));
                $line = round($line / 1024);

                return $line;
            }
        }

        return '';
    }

    public function getLinuxVersion()
    {
        static $result;

        if (null === $result) {
            $result = trim($this->command->run('uname -mrs'));
        }

        return $result;
    }

    public function getDistrName()
    {
        static $result;

        if (null === $result) {
            $release = explode("\n", trim($this->command->run('cat /etc/*-release')));

            $name = null;
            $version = null;

            foreach ($release as $line) {
                if ($name === null && strpos($line, 'DISTRIB_ID=') !== false) {
                    $line = explode('=', $line);
                    $name = trim(end($line));
                    continue;
                }

                if ($version === null && strpos($line, 'DISTRIB_RELEASE=') !== false) {
                    $line = explode('=', $line);
                    $version = trim(end($line));
                    continue;
                }
            }

            if ($name === null || $version === null) {
                foreach ($release as $line) {
                    if ($name === null && strpos($line, 'NAME=') !== false) {
                        $line = explode('=', $line);
                        $name = trim(end($line));
                        continue;
                    }

                    if ($version === null && strpos($line, 'VERSION=') !== false) {
                        $line = explode('=', $line);
                        $version = trim(end($line));
                        continue;
                    }
                }
            }

            $result = trim("{$name} {$version}");
        }

        return $result;
    }

    public function getMesaVersion()
    {
        static $result;

        if (null === $result) {
            $mesa = explode("\n", trim($this->command->run('glxinfo | grep "Mesa"')));
            $version = null;

            foreach ($mesa as $line) {
                if ($version === null && strpos($line, 'OpenGL version string') !== false) {
                    $line = explode('Mesa', $line);
                    $line = trim(end($line));
                    $line = explode(' ', $line);
                    $version = trim(reset($line));
                    break;
                }
            }

            $result = $version ?: '';
        }

        return $result;
    }

    public function getGlibcVersion()
    {
        static $result;

        if (null === $result) {

            $isGetConf = (bool)trim($this->command->run('which getconf'));

            if ($isGetConf) {
                $text = explode("\n", trim($this->command->run('getconf GNU_LIBC_VERSION')));

                preg_match_all('/([0-9]{1,}.[0-9]{1,})/m', trim(reset($text)), $matches, PREG_SET_ORDER, 0);

                if ($matches && $matches[0] && $matches[0][0]) {
                    $result = $matches[0][0];
                }
            }

            if (!$result) {
                $text = explode("\n", trim($this->command->run('ldd --version')));

                preg_match_all('/([0-9]{1,}.[0-9]{1,})/m', trim(reset($text)), $matches, PREG_SET_ORDER, 0);

                if ($matches && $matches[0] && $matches[0][0]) {
                    $result = $matches[0][0];
                }
            }
        }

        return $result;
    }

    public function getXrandrVersion()
    {
        static $result;

        if (null === $result) {
            $result = trim($this->command->run("xrandr --version"));
        }

        return $result;
    }

    public function getTypeGPU()
    {
        static $result;

        if (null === $result) {
            $isGlxinfo = $this->command->run("which glxinfo");

            if ($isGlxinfo) {
                $type = trim($this->command->run('glxinfo | grep -E "(ATI|AMD)"'));

                if ($type) {
                    $result = 'amd';
                    return $result;
                }

                $type = trim($this->command->run('glxinfo | grep "NVIDIA"'));

                if ($type) {
                    $result = 'nvidia';
                    return $result;
                }

                $type = trim($this->command->run('glxinfo | grep "Intel"'));

                if ($type) {
                    $result = 'intel';
                    return $result;
                }
            }

            return null;
        }

        return $result;
    }

    public function getUlimitHard()
    {
        return (int)trim($this->command->run('ulimit -Hn'));
    }

    public function getUlimitSoft()
    {
        return (int)trim($this->command->run('ulimit -Sn'));
    }

    public function lock()
    {
        $lock = $this->config->getRootDir() . '/run.pid';

        if (file_exists($lock)) {
            $pid = trim(file_get_contents($lock));
            if ($pid) {
                $processExists = $this->command->run("ps -p {$pid} -o comm=");
                if ($processExists) {
                    return false;
                }
            }
        }

        file_put_contents($lock, posix_getpid());

        register_shutdown_function(function () use ($lock) {
            if (file_exists($lock)) {
                @unlink($lock);
            }
        });

        return true;
    }

    public function checkPhp()
    {
        return extension_loaded('ncurses');
    }

    public function getFont()
    {
        $fonts = array_map('trim', explode("\n", trim($this->command->run('xlsfonts'))));

        $find = ['-misc-fixed-bold-r-normal--0-0-100-100-c-0-iso8859-1', '9x15bold', '10x20', 'lucidasanstypewriter-bold-18', 'lucidasans-bold-18'];

        foreach ($find as $font) {
            if (in_array($font, $fonts, true)) {
                return $font;
            }
        }

        foreach ($fonts as $font) {
            $font = trim($font);

            if (strpos($font, ' ') === false
                && strpos($font,'&') === false
                && strpos($font,'.') === false
                && strpos($font, 'bold') !== false
                && (
                    strpos($font, '100') !== false
                    || strpos($font, '110') !== false
                    || strpos($font, '120') !== false
                    || strpos($font, '130') !== false
                    || strpos($font, '140') !== false
                )
            ) {
                return $font;
            }
        }

        return '';
    }

    public function isCyrillic()
    {
        static $result;

        if (null === $result) {
            $result = (bool)trim($this->command->run('locale | grep LANG=ru'));
        }

        return $result;
    }
}



class Mount
{
    private $command;
    private $config;
    private $console;
    private $folder;
    private $extension;
    private $mounted = false;

    /**
     * Mount constructor.
     * @param Config $config
     * @param Command $command
     * @param Console $console
     * @param string $folder
     */
    public function __construct(Config $config, Command $command, Console $console, $folder)
    {
        $this->config  = $config;
        $this->command = $command;
        $this->folder  = $folder;
        $this->console = $console;

        $this->mount();

        if ($this->getFolder() === $config->getWineDir()) {
            $config->updateWine();
        }

        if ($this->isMounted()) {
            register_shutdown_function(function () { if ($this->isMounted()) $this->umount(); });
        }
    }

    /**
     * @return bool
     */
    public function isMounted()
    {
        return $this->mounted;
    }

    /**
     * @return string
     */
    public function getFolder()
    {
        return $this->folder;
    }

    /**
     * @return string|null
     */
    public function getExtension()
    {
        return $this->extension;
    }

    /**
     * @return bool
     */
    public function mount()
    {
        if (!$this->console->lock()) {
            return false;
        }

        $folder = $this->folder;

        $this->umount();

        if ($this->mounted === false && file_exists("{$folder}.squashfs") && !file_exists($folder)) {
            if (!mkdir($folder, 0775) && !is_dir($folder)) {
                throw new \RuntimeException(sprintf('Directory "%s" was not created', $folder));
            }
            $this->extension = 'squashfs';
            $this->mounted = true;
            $this->command->squashfuse($folder);
        }

        if ($this->mounted === false && file_exists("{$folder}.zip") && !file_exists($folder)) {
            if (!mkdir($folder, 0775) && !is_dir($folder)) {
                throw new \RuntimeException(sprintf('Directory "%s" was not created', $folder));
            }
            $this->extension = 'zip';
            $this->mounted = true;
            $this->command->zipfuse($folder);
        }

        return $this->mounted;
    }

    /**
     * @return bool
     */
    public function umount()
    {
        if (!$this->console->lock()) {
            return false;
        }

        foreach (range(0, 5) as $i) {
            if (!file_exists($this->folder)) {
                $this->mounted = false;
                $this->extension = null;
                break;
            }

            $this->command->umount($this->folder);

            if (file_exists($this->folder) && (file_exists("{$this->folder}.squashfs") || file_exists("{$this->folder}.zip"))) {
                @rmdir($this->folder);
            }

            if (file_exists($this->folder) && (file_exists("{$this->folder}.squashfs") || file_exists("{$this->folder}.zip"))) {
                sleep(1);
            } else {
                $this->extension = null;
                $this->mounted = false;
            }
        }

        return $this->mounted;
    }
}



class Event {

    private $command;
    private $config;

    /**
     * Event constructor.
     * @param Config $config
     * @param Command $command
     */
    public function __construct(Config $config, Command $command)
    {
        $this->command = $command;
        $this->config  = $config;
    }

    public function createPrefix($type = 'after_create_prefix')
    {
        if (!file_exists($this->config->wine('WINEPREFIX')) || !file_exists($this->config->getHooksDir())) {
            return [];
        }

        $result = [];

        if ($this->config->get('hooks', $type)) {
            foreach ((array)$this->config->get('hooks', $type) as $hookCmd) {
                $hookCmd = trim($hookCmd);
                if (!$hookCmd) {
                    continue;
                }

                $trimHook = trim($hookCmd, '&');

                if (file_exists($this->config->getHooksDir() . "/{$trimHook}")) {
                    $result[] = "Run {$trimHook}";
                    $result[] = $this->command->run('cd "' . $this->config->getHooksDir() . '"; chmod +x ' . $trimHook . "; ./{$hookCmd}");
                }
            }
        }

        return $result;
    }

    public function beforeRun()
    {
        $this->createPrefix('before_run_game');
    }

    public function afterExit()
    {
        $this->createPrefix('after_exit_game');
    }

    public function gpu()
    {
        $gpu = (new System($this->config, $this->command))->getTypeGPU();

        if (!file_exists($this->config->wine('WINEPREFIX')) || !file_exists($this->config->getHooksGpuDir()) || !$gpu) {
            return [];
        }

        $result = [];

        if ($this->config->get('hooks', "gpu_{$gpu}")) {
            $hooks = (array)$this->config->get('hooks', "gpu_{$gpu}");

            foreach ($hooks as $hook) {
                $hookCmd = trim($hook);
                if (!$hookCmd) {
                    continue;
                }

                $trimHook = trim($hookCmd, '&');

                if (file_exists($this->config->getHooksDir() . "/{$trimHook}")) {
                    $result[] = "Run {$trimHook}";
                    $result[] = $this->command->run('cd "' . $this->config->getHooksDir() . '"; chmod +x ' . Text::quoteArgs($trimHook) . "; ./{$hookCmd}", true);
                }
            }
        }

        return $result;
    }
}



class Config {

    private $repo;
    private $context;
    private $gameInfoDir;
    private $rootDir;
    private $dataDir;
    private $dataFile;
    private $additionalDir;
    private $dllsDir;
    private $dlls64Dir;
    private $hooksDir;
    private $regsDir;
    private $cacheDir;
    private $logsDir;
    private $libsDir;
    private $libs64Dir;
    private $configPath;
    private $config;
    private $wine;
    private $dxvkConfFile;
    private $hooksGpuDir;
    private $symlinksDir;
    private $dataSymlinksDir;

    public function __construct($path = null)
    {
        $this->repo            = 'https://raw.githubusercontent.com/hitman249/wine-helpers/master';
        $this->context         = ['ssl' => ['verify_peer' => false, 'verify_peer_name' => false]];
        $this->rootDir         = __DIR__;
        $this->gameInfoDir     = "{$this->rootDir}/game_info";
        $this->dataDir         = "{$this->rootDir}/game_info/data";
        $this->dataSymlinksDir = "{$this->rootDir}/game_info/data/_symlinks";
        $this->dataFile        = "{$this->rootDir}/game_info/data.squashfs";
        $this->additionalDir   = "{$this->rootDir}/game_info/additional";
        $this->symlinksDir     = "{$this->rootDir}/game_info/additional/symlinks";
        $this->dllsDir         = "{$this->rootDir}/game_info/dlls";
        $this->dlls64Dir       = "{$this->rootDir}/game_info/dlls64";
        $this->hooksDir        = "{$this->rootDir}/game_info/hooks";
        $this->hooksGpuDir     = "{$this->rootDir}/game_info/hooks/gpu";
        $this->regsDir         = "{$this->rootDir}/game_info/regs";
        $this->cacheDir        = "{$this->rootDir}/game_info/cache";
        $this->logsDir         = "{$this->rootDir}/game_info/logs";
        $this->dxvkConfFile    = "{$this->rootDir}/game_info/dxvk.conf";
        $this->libsDir         = "{$this->rootDir}/libs/i386";
        $this->libs64Dir       = "{$this->rootDir}/libs/x86-64";
        $this->wineDir         = "{$this->rootDir}/wine";
        $this->wineFile        = "{$this->rootDir}/wine.squashfs";

        if (null !== $path) {
            $this->load($path);
        }

        $this->wine = [
            'WINEDEBUG'        => '-all',
            'WINEARCH'         => 'win32',
            'WINEDLLOVERRIDES' => '', // 'winemenubuilder.exe=d;nvapi,nvapi64,mscoree,mshtml='
            'WINEPREFIX'       => "{$this->rootDir}/prefix",
            'DRIVE_C'          => "{$this->rootDir}/prefix/drive_c",
            'WINE'             => "{$this->rootDir}/wine/bin/wine",
            'WINE64'           => "{$this->rootDir}/wine/bin/wine64",
            'REGEDIT'          => "{$this->rootDir}/wine/bin/wine\" \"regedit",
            'REGEDIT64'        => "{$this->rootDir}/wine/bin/wine64\" \"regedit",
            'WINEBOOT'         => "{$this->rootDir}/wine/bin/wine\" \"wineboot",
            'WINEFILE'         => "{$this->rootDir}/wine/bin/wine\" \"winefile",
            'WINECFG'          => "{$this->rootDir}/wine/bin/wine\" \"winecfg",
            'WINETASKMGR'      => "{$this->rootDir}/wine/bin/wine\" \"taskmgr",
            'WINEUNINSTALLER'  => "{$this->rootDir}/wine/bin/wine\" \"uninstaller",
            'WINEPROGRAM'      => "{$this->rootDir}/wine/bin/wine\" \"progman",
            'WINESERVER'       => "{$this->rootDir}/wine/bin/wineserver",
        ];
    }

    public function updateWine()
    {
        if ((new Wine($this, new Command($this)))->isUsedSystemWine()) {
            $this->wine['WINE']            = 'wine';
            $this->wine['WINE64']          = 'wine64';
            $this->wine['REGEDIT']         = 'wine" "regedit';
            $this->wine['REGEDIT64']       = 'wine64" "regedit';
            $this->wine['WINETASKMGR']     = 'wine" "taskmgr';
            $this->wine['WINEUNINSTALLER'] = 'wine" "uninstaller';
            $this->wine['WINEPROGRAM']     = 'wine" "progman';
            $this->wine['WINEBOOT']        = 'wineboot';
            $this->wine['WINEFILE']        = 'winefile';
            $this->wine['WINECFG']         = 'winecfg';
            $this->wine['WINESERVER']      = 'wineserver';
        }
    }

    public function wine($field)
    {
        $value = $this->get('wine', $field);

        if ($value === null) {
            $value = $this->wine[$field] ?: null;
        }

        return $value;
    }

    public function get($section, $field = null)
    {
        $this->load();

        if ($field !== null && empty($this->config[$section])) {
            return null;
        }

        return null === $field ? $this->config[$section] : $this->config[$section][$field];
    }

    public function set($section, $field, $value)
    {
        $this->load();
        $this->config[$section][$field] = $value;
    }

    public function getBool($section, $field)
    {
        return (bool)$this->get($section, $field);
    }

    public function getInt($section, $field)
    {
        $result = $this->get($section, $field);

        if (is_array($result)) {
            return array_map('intval', $result);
        }

        return (int)$result;
    }

    public function getFloat($section, $field)
    {
        $result = $this->get($section, $field);

        if (is_array($result)) {
            return array_map('floatval', $result);
        }

        return (float)$result;
    }

    public function getGamePath()
    {
        return $this->get('game', 'path');
    }

    public function getPrefixGameFolder()
    {
        return $this->wine('DRIVE_C') . '/' . $this->getGamePath();
    }

    public function getGameAdditionalPath()
    {
        return $this->get('game', 'additional_path');
    }

    public function getGameExe()
    {
        return $this->get('game', 'exe');
    }

    public function getGameArgs()
    {
        return $this->get('game', 'cmd');
    }

    public function getGameTitle()
    {
        return $this->get('game', 'name');
    }

    public function getGameVersion()
    {
        return $this->get('game', 'version');
    }

    private function load($path = null)
    {
        if (null === $this->config) {
            if (!$path) {
                $path = $this->getConfigFile();
            } else {
                $this->configPath = $path;
            }

            if (file_exists($this->configPath)) {
                $this->config = (new FileINI($path))->get();
            } else {
                $this->config = parse_ini_string($this->getDefaultConfig(), true);
            }
        }
    }

    /**
     * @return string
     */
    public function getConfigFile()
    {
        if (null === $this->configPath) {
            $configs = $this->findConfigsPath();

            if ($configs) {
                $this->configPath = reset($configs);
            } else {
                $this->configPath = $this->getGameInfoDir() . '/game_info.ini';
            }
        }

        return $this->configPath;
    }

    public function findConfigsPath()
    {
        $configs = glob("{$this->gameInfoDir}/*.ini");
        natsort($configs);

        return $configs;
    }

    public function getContextOptions()
    {
        return $this->context;
    }

    public function getRepositoryUrl()
    {
        return $this->repo;
    }

    public function getGameInfoDir()
    {
        return $this->gameInfoDir;
    }

    public function getRootDir()
    {
        return $this->rootDir;
    }

    public function getDataDir()
    {
        return $this->dataDir;
    }

    public function getDataFile()
    {
        return $this->dataFile;
    }

    public function getWineDir()
    {
        return $this->wineDir;
    }

    public function getWineFile()
    {
        return $this->wineFile;
    }

    public function getAdditionalDir()
    {
        return $this->additionalDir;
    }

    public function getSymlinksDir()
    {
        return $this->symlinksDir;
    }

    public function getDllsDir()
    {
        return $this->dllsDir;
    }

    public function getDlls64Dir()
    {
        return $this->dlls64Dir;
    }

    public function getHooksDir()
    {
        return $this->hooksDir;
    }

    public function getHooksGpuDir()
    {
        return $this->hooksGpuDir;
    }

    public function getRegsDir()
    {
        return $this->regsDir;
    }

    public function getCacheDir()
    {
        if (!file_exists($this->cacheDir) && !mkdir($this->cacheDir, 0775, true) && !is_dir($this->cacheDir)) {
            throw new \RuntimeException(sprintf('Directory "%s" was not created', $this->cacheDir));
        }

        return $this->cacheDir;
    }

    public function getLogsDir()
    {
        if (!file_exists($this->logsDir) && !mkdir($this->logsDir, 0775, true) && !is_dir($this->logsDir)) {
            throw new \RuntimeException(sprintf('Directory "%s" was not created', $this->logsDir));
        }

        return $this->logsDir;
    }

    public function getLibsDir()
    {
        return $this->libsDir;
    }

    public function getLibs64Dir()
    {
        return $this->libs64Dir;
    }

    public function getDxvkConfFile()
    {
        return $this->dxvkConfFile;
    }

    public function getDefaultConfig()
    {
        return "[game]
path = \"Games\"
additional_path = \"The Super Game/bin\"
exe = \"Game.exe\"
cmd = \"-language=russian\"
name = \"The Super Game: Deluxe Edition\"
version = \"1.0.0\"
[script]
csmt = 1
winetricks = 0
dialogs = 1
autoupdate = 1

; Not use /home/user directory
sandbox = 1

; Download latest d3d11.dll and dxgi.dll
dxvk = 0
dxvk_autoupdate = 1

; Windows version (win7, winxp, win2k)
winver = \"win7\"

; Set sound driver to PulseAudio or ALSA
pulse = 1

; Auto fixed resolution, brightness, gamma for all monitors
fixres = 1
[wine]
WINEDEBUG = \"-all\"
WINEARCH = \"win32\"
WINEDLLOVERRIDES = \"\"
[window]
enable = 0
title = \"Wine\"
resolution = \"800x600\"
[dlls]
;
; Additional dlls folder logic
; Example: dll[name_file.dll] = \"nooverride\"
;
; Variables:
; \"builtin\"        - Встроенная
; \"native\"         - Сторонняя (default)
; \"builtin,native\" - Встроенная, Сторонняя
; \"native,builtin\" - Сторонняя, Встроенная
; \"nooverride\"     - Не заносить в реестр
; \"register\"       - Зарегистрировать библиотеку через regsvr32
;
; Настройки относятся только к папке dlls, которая создаёт симлинки в папку system32
;

; dll[d3d11.dll] = \"nooverride\"
; dll[l3codecx.ax] = \"register\"
[hooks]
;
; Хуки
; after_create_prefix - команды выполняются после создания префикса
; before_run_game - команды выполняются перед запуском игры
; after_exit_game - команды выполняются после завершения игры
;

; after_create_prefix[] = \"create.sh\"
; before_run_game[] = \"before.sh\"
; after_exit_game[] = \"after.sh\"
; after_exit_game[] = \"after2.sh\"
; gpu_amd[] = \"gpu/amd.sh\"
; gpu_nvidia[] = \"gpu/nvidia.sh\"
; gpu_intel[] = \"gpu/intel.sh\"
[export]
;
; Экспорт дополнительных переменных к команде запуска игры
; Примеры:
;

; DXVK_HUD=fps
; DXVK_HUD=1
; DXVK_HUD=fps,devinfo,memory
; DXVK_HUD=fps,devinfo,frametimes,memory
; DXVK_HUD=fps,devinfo,frametimes,submissions,drawcalls,pipelines,memory
; GALLIUM_HUD=simple,fps
; WINEESYNC=1
; PBA_DISABLE=1
; MESA_GLTHREAD=true
; __GL_THREADED_OPTIMIZATIONS=1
;
; Если в игре хрипит звук можно попробовать
; PULSE_LATENCY_MSEC=60

WINEESYNC=1
PBA_DISABLE=1
[replaces]
;
; При создании префикса ищет и заменяет в указанных файлах теги.
; Путь относительно позиции файла ./start
; Выполняется ДО регистрации *.reg файлов
;
; {WIDTH} - ширина монитора по умолчанию в пикселях (число)
; {HEIGHT} - высота монитора по умолчанию в пикселях (число)
; {USER} - имя пользователя
;

; file[] = \"game_info/data/example.conf\"";
    }

    public function getDefaultDxvkConfig()
    {
        return "# Create the VkSurface on the first call to IDXGISwapChain::Present,
# rather than when creating the swap chain. Some games that start
# rendering with a different graphics API may require this option,
# or otherwise the window may stay black.
# 
# Supported values: True, False
# 
# Enabled by default for:
# - Frostpunk

# dxgi.deferSurfaceCreation = False


# Enforce a stricter maximum frame latency. Overrides the application
# setting specified by calling IDXGIDevice::SetMaximumFrameLatency.
# Setting this to 0 will have no effect.
# 
# Supported values : 0 - 16

# dxgi.maxFrameLatency = 0


# Override PCI vendor and device IDs reported to the application. Can
# cause the app to adjust behaviour depending on the selected values.
#
# Supported values: Any four-digit hex number.

# dxgi.customDeviceId = 0000
# dxgi.customVendorId = 0000


# Override maximum amount of device memory and shared system memory
# reported to the application. This may fix texture streaming issues
# in games that do not support cards with large amounts of VRAM.
#
# Supported values: Any number in Megabytes.
#
# Enabled by default for:
# - Life is Feudal MMO: 4095

# dxgi.maxDeviceMemory = 0
# dxgi.maxSharedMemory = 0


# Override back buffer count for the Vulkan swap chain.
# Setting this to 0 or less will have no effect.
#
# Supported values: Any number greater than or equal to 2.

# dxgi.numBackBuffers = 0


# Overrides synchronization interval (Vsync) for presentation.
# Setting this to 0 disables vertical synchronization entirely.
# A positive value 'n' will enable Vsync and repeat the same
# image n times, and a negative value will have no effect.
#
# Supported values: Any non-negative number

# dxgi.syncInterval = -1


# Overrides present mode for vertical synchronization
# 
# Supported values are:
# - 0: FIFO (default)
# - 1: MAILBOX (allows higher frame rates than refresh rate)

# dxgi.syncMode = 0


# Enables or dsables d3d10 support.
# 
# Supported values: True, False

# d3d10.enable = True


# Handle D3D11_MAP_FLAG_DO_NOT_WAIT correctly when D3D11DeviceContext::Map()
# is called. Enabling this can potentially improve performance, but breaks
# games which do not expect Map() to return an error despite using the flag.
# 
# Supported values: True, False
#
# Enabled by default for:
# - Dishonored 2
# - Far Cry 5

# d3d11.allowMapFlagNoWait = False


# Fake Stream Output support. This reports a success code to applications
# calling CreateGeometryShaderWithStreamOutput, even if the device does
# not actually support transform feedback. Allows some games to run that
# would otherwise crash or show an error message.
#
# Supported values: True, False
#
# Enabled by default for:
# - F1 2015
# - Final Fantasy XV
# - Mafia 3
# - Overwatch

# d3d11.fakeStreamOutSupport = False


# Override the maximum feature level that a D3D11 device can be created
# with. Setting this to a higher value may allow some applications to run
# that would otherwise fail to create a D3D11 device.
#
# Supported values: 9_1, 9_2, 9_3, 10_0, 10_1, 11_0, 11_1

# d3d11.maxFeatureLevel = 11_1


# Overrides the maximum allowed tessellation factor. This can be used to
# improve performance in titles which overuse tessellation.
# 
# Supported values: Any number between 8 and 64

# d3d11.maxTessFactor = 0


# Overrides anisotropic filtering for all samplers. Set this to a positive
# value to enable AF for all samplers in the game, or to 0 in order to
# disable AF entirely. Negative values will have no effect.
# 
# Supported values: Any number between 0 and 16

# d3d11.samplerAnisotropy = -1


# Allow allocating more device memory from a Vulkan heap than the heap
# provides. May in some cases improve performance in low-memory conditions.
#
# Supported values: True, False

# dxvk.allowMemoryOvercommit = False


# Sets number of pipeline compiler threads.
# 
# Supported values:
# - 0 to automatically determine the number of threads to use
# - any positive number to enforce the thread count

# dxvk.numCompilerThreads = 0";
    }

    public function isScriptAutoupdate()
    {
        return $this->getBool('script', 'autoupdate');
    }

    public function isDxvkAutoupdate()
    {
        return $this->getBool('script', 'dxvk_autoupdate');
    }

    public function isDxvk()
    {
        return $this->getBool('script', 'dxvk');
    }

    public function isSandbox()
    {
        return $this->getBool('script', 'sandbox');
    }

    public function isPulse()
    {
        return $this->getBool('script', 'pulse');
    }

    public function isFixres()
    {
        return $this->getBool('script', 'fixres');
    }

    public function isCsmt()
    {
        return $this->getBool('script', 'csmt');
    }

    public function isPBA()
    {
        return $this->get('export', 'PBA_DISABLE') !== null && !$this->getBool('export', 'PBA_DISABLE');
    }

    public function isEsync()
    {
        return $this->getBool('export', 'WINEESYNC');
    }

    public function getDxvkConfigFile()
    {
        $file   = $this->dxvkConfFile;
        $driveC = $this->wine('DRIVE_C') . '/dxvk.conf';

        static $run = false;

        if ($run) {
            return $driveC;
        }

        if (file_exists($file) && !file_exists($driveC)) {
            $run = true;
            (new Command($this))->run("ln -sfr \"{$file}\" \"{$driveC}\"");
            $run = false;
        }

        return $driveC;
    }

    public function getDxvkCacheDir()
    {
        $dir    = $this->getCacheDir();
        $driveC = $this->wine('DRIVE_C') . '/cache';

        static $run = false;

        if ($run) {
            return $driveC;
        }

        if (!file_exists($dir)) {
            if (!mkdir($dir, 0775) && !is_dir($dir)) {
                throw new \RuntimeException(sprintf('Directory "%s" was not created', $dir));
            }
        }

        if (!file_exists($driveC)) {
            $run = true;
            (new Command($this))->run("ln -sfr \"{$dir}\" \"{$driveC}\"");
            $run = false;
        }

        return $driveC;
    }

    public function getDxvkLogsDir()
    {
        $dir    = $this->getLogsDir();
        $driveC = $this->wine('DRIVE_C') . '/logs';

        static $run = false;

        if ($run) {
            return $driveC;
        }

        if (!file_exists($dir)) {
            if (!mkdir($dir, 0775) && !is_dir($dir)) {
                throw new \RuntimeException(sprintf('Directory "%s" was not created', $dir));
            }
        }

        if (!file_exists($driveC)) {
            $run = true;
            (new Command($this))->run("ln -sfr \"{$dir}\" \"{$driveC}\"");
            $run = false;
        }

        return $driveC;
    }

    public function getWindowsVersion()
    {
        return $this->get('script' , 'winver');
    }

    public function getWineArch()
    {
        return $this->wine('WINEARCH');
    }

    public function getDataSymlinksDir()
    {
        return $this->dataSymlinksDir;
    }

    public function versionPrefix()
    {
        $version = $this->wine('WINEPREFIX') . '/version';

        if (file_exists($version)) {
            return trim(file_get_contents($version));
        }

        return '';
    }
}



class Wine {

    private $command;
    private $config;

    /**
     * Wine constructor.
     * @param Config $config
     * @param Command $command
     */
    public function __construct(Config $config, Command $command)
    {
        $this->command = $command;
        $this->config  = $config;
    }

    public function boot()
    {
        $this->command->run(Text::quoteArgs($this->config->wine('WINEBOOT')) . ' && ' . Text::quoteArgs($this->config->wine('WINESERVER')) . ' -w');
    }

    public function down()
    {
        $this->command->run(Text::quoteArgs($this->config->wine('WINESERVER')) . ' -k');
    }

    public function run($args)
    {
        $cmd = Text::quoteArgs($args);

        $result = $this->command->run(Text::quoteArgs($this->config->wine('WINE')) . " {$cmd}");

        if ($this->config->wine('WINEARCH') === 'win64') {
            $result .= $this->command->run(Text::quoteArgs($this->config->wine('WINE64')) . " {$cmd}");
        }

        return $result;
    }

    public function fm($args)
    {
        $config = clone $this->config;
        $config->set('wine', 'WINEDEBUG', '');
        $cmd = Text::quoteArgs($args);

        return (new Command($config))->run(Text::quoteArgs($this->config->wine('WINEFILE')) . " {$cmd}");
    }

    public function cfg($args)
    {
        $cmd = Text::quoteArgs($args);

        return $this->command->run(Text::quoteArgs($this->config->wine('WINECFG')) . " {$cmd}");
    }

    public function reg($args)
    {
        $cmd = Text::quoteArgs($args);
        $result = $this->command->run(Text::quoteArgs($this->config->wine('REGEDIT')) . " {$cmd}");

        if ($this->config->wine('WINEARCH') === 'win64') {
            $result .= $this->command->run(Text::quoteArgs($this->config->wine('REGEDIT64')) . " {$cmd}");
        }

        return $result;
    }

    public function regsvr32($args)
    {
        $this->run(array_merge(['regsvr32'], $args));
    }

    public function winetricks($args, $output = false)
    {
        (new Update($this->config, $this->command))->downloadWinetricks();

        if ($args && file_exists($this->config->getRootDir() . '/winetricks')) {

            $config = clone $this->config;
            $config->set('wine', 'WINEDEBUG', '');
            $cmd = Text::quoteArgs($args);
            $logFile = $this->config->getLogsDir() . '/winetricks-' . implode('-', $args) . '.log';

            return (new Command($config))->run(Text::quoteArgs($this->config->getRootDir() . '/winetricks') . " {$cmd}", $logFile, $output);
        }

        return '';
    }

    public function checkSystemWine()
    {
        return (bool)trim($this->command->run('which "wine"'));
    }

    public function checkWine()
    {
        return (bool)trim($this->command->run('which ' . Text::quoteArgs($this->config->wine('WINE'))));
    }

    public function version()
    {
        static $version;

        if (null === $version) {
            $version = trim($this->command->run(Text::quoteArgs($this->config->wine('WINE')) . ' --version'));
        }

        return $version;
    }

    public function isUsedSystemWine()
    {
        return !file_exists($this->config->getRootDir() . '/wine/bin/wine')
            || version_compare((new System($this->config, $this->command))->getGlibcVersion(), '2.23', '<');
    }

    public function getMissingLibs()
    {
        static $result;

        if (null === $result) {
            $help = $this->command->run(Text::quoteArgs($this->config->wine('WINE')) . ' --help');

            if (strpos($help, '--check-libs') === false) {
                $result = [];
                return $result;
            }

            $result = $this->command->run(Text::quoteArgs($this->config->wine('WINE')) . ' --check-libs');
            $result = array_filter(
                array_map('trim', explode("\n", $result)),
                function ($line) {
                    if (!$line) {
                        return false;
                    }

                    list($left, $right) = array_map(
                        function ($s) {return trim($s, " \t\n\r\0\x0B.");},
                        explode(':', $line)
                    );

                    return strpos($right, '.') === false;
                }
            );
        }

        return $result;
    }
}



class Update {

    private $version = '0.72';
    private $command;
    private $config;
    private $network;
    private $system;

    /**
     * Update constructor.
     * @param Config $config
     * @param Command $command
     */
    public function __construct(Config $config, Command $command)
    {
        $this->command = $command;
        $this->config  = $config;
        $this->network = new Network($config, $command);
        $this->system  = new System($config, $command);
    }

    public function version()
    {
        return $this->version;
    }

    public function getUrl()
    {
        return 'https://github.com/hitman249/wine-helpers';
    }

    public function init()
    {
        /**
         * Autoupdate script
         */
        $this->autoupdate();


        /**
         * Autoupdate dxvk
         */
        $this->dxvkAutoupdate();


        /**
         * README.md
         */
        $this->updateReadme();


        /**
         * PHP Interpreter
         */
        $this->updatePhp();
    }

    public function updateReadme($create = false, $update = false)
    {
        if ($create === false) {

            if (!file_exists($this->config->getRootDir() . '/README.md')) {
                return false;
            }

            $path = $this->config->wine('DRIVE_C') . '/readme';

            if (!file_exists($path)) {
                if ($update === true) {
                    file_put_contents($path, ' ');
                    return false;
                }
                if ($update === false) {
                    return false;
                }
            }

            if ($update === true) {
                return false;
            }

            if (file_exists($path)) {
                unlink($path);
            } else {
                return false;
            }

        }

        if (Network::isConnected()) {
            if (file_exists($this->config->wine('DRIVE_C'))) {
                $readme = $this->network->get($this->config->getRepositoryUrl() . '/README.md');

                if ($readme) {
                    /**
                     * README.md
                     */
                    file_put_contents($this->config->getRootDir() . '/README.md', $readme);

                    return true;
                }
            }
        }

        return false;
    }

    public function updateDxvkConfig()
    {
        if (!$this->config->isDxvk()) {
            return false;
        }

        if (!file_exists($this->config->getDxvkConfFile())) {
            file_put_contents($this->config->getDxvkConfFile(), $this->config->getDefaultDxvkConfig());
        }

        if (!file_exists($this->config->getDxvkConfFile())) {
            return false;
        }

        $currentConfig = trim(file_get_contents($this->config->getDxvkConfFile()));
        $defaultConfig = explode("\n", $this->config->getDefaultDxvkConfig());
        $newConfig     = [];
        $params        = [];

        foreach (explode("\n", $currentConfig) as $line) {
            $line = trim($line);
            if (!Text::startsWith($line, '#')) {
                $item = explode('=', $line);
                $name = trim(reset($item));
                $params[$name] = $line;
            }
        }

        foreach ($defaultConfig as $line) {
            $newConfig[] = $line;

            if (count($params) > 0) {
                $line = trim($line, " \t\n\r\0\x0B#");
                $item = explode('=', $line);
                $name = trim(reset($item));

                if (isset($params[$name]) && $params[$name] !== null) {
                    $newConfig[] = '';
                    $newConfig[] = $params[$name];
                    unset($params[$name]);
                }
            }
        }

        if (count($params) > 0) {
            $newConfig[] = '';
            $newConfig[] = '';
            $newConfig[] = '# Deprecated values.';
            $newConfig[] = '';
            foreach ($params as $line) {
                $newConfig[] = $line;
            }
        }

        $config = trim(implode("\n", $newConfig));

        if (md5($config) !== md5($currentConfig)) {
            file_put_contents($this->config->getDxvkConfFile(), $config);
            return true;
        }

        return false;
    }

    public function updateConfig()
    {
        if (!file_exists($this->config->getConfigFile())) {
            return false;
        }

        $result = [];

        $current          = (new FileINI($this->config->getConfigFile()))->get();
        $currentText      = file_get_contents($this->config->getConfigFile());
        $defaultText      = $this->config->getDefaultConfig();
        $defaultTextArray = explode("\n", $defaultText);

        $section = null;
        $space = null;
        foreach ($defaultTextArray as $line) {
            $line = trim($line);

            if (!$line) {
                $result[] = '';
                continue;
            }
            if (Text::startsWith($line, '[') && Text::endsWith($line, ']')) {

                if ($section !== null) {
                    if ($space === null) {
                        $space = true;
                        $result[] = '';
                    }

                    if ($current[$section]) {
                        foreach ($current[$section]?:[] as $key => $value) {
                            if (is_array($value)) {
                                foreach ($value?:[] as $k => $v) {
                                    $v = is_numeric($v) && $v !== null && $v !== '' ? $v : "\"{$v}\"";
                                    if (is_numeric($k)) {
                                        $result[] = "{$key}[] = {$v}";
                                    } else {
                                        $result[] = "{$key}[{$k}] = {$v}";
                                    }
                                }
                            } else {
                                $value = is_numeric($value) && $value !== null && $value !== '' ? $value : "\"{$value}\"";
                                $result[] = "{$key} = {$value}";
                            }
                        }

                        $result[] = '';
                    }
                }

                $space = null;
                $result[] = $line;
                $section  = trim(str_replace(['[',']'], '', $line));
                continue;
            }
            if (Text::startsWith($line, ';')) {
                $result[] = $line;
                continue;
            }

            if ($section !== null) {

                list($key, $value) = array_map(function ($n) { return trim($n, " \t\n\r\0\x0B\"'");}, explode('=', $line));

                if (Text::endsWith($key, ']')) {

                } else {
                    if (!isset($current[$section][$key])) {
                        $result[] = $line;
                    } else {
                        $value = $current[$section][$key];
                        $value = is_numeric($value) && $value !== null && $value !== '' ? $value : "\"{$value}\"";
                        $result[] = "{$key} = {$value}";
                        unset($current[$section][$key]);
                    }
                }
            }
        }

        if ($section !== null) {
            $result[] = '';

            foreach ($current[$section]?:[] as $key => $value) {
                if (is_array($value)) {
                    foreach ($value?:[] as $k => $v) {
                        $v = is_numeric($v) && $v !== null && $v !== '' ? $v : "\"{$v}\"";
                        if (is_numeric($k)) {
                            $result[] = "{$key}[] = {$v}";
                        } else {
                            $result[] = "{$key}[{$k}] = {$v}";
                        }
                    }
                } else {
                    $value = is_numeric($value) && $value !== null && $value !== '' ? $value : "\"{$value}\"";
                    $result[] = "{$key} = {$value}";
                }
            }

            $result[] = '';
        }

        $newConfig = implode("\n", $result);

        if (md5($currentText) !== md5($newConfig)) {
            file_put_contents($this->config->getConfigFile(), $newConfig);
            return true;
        }

        return false;
    }

    public function versionRemote()
    {
        static $version;

        if (null === $version) {
            $version = trim($this->network->get($this->config->getRepositoryUrl() . '/RELEASE'));
        }

        return $version;
    }

    public function autoupdate()
    {
        if ($this->config->isScriptAutoupdate() && Network::isConnected()) {

            if ($this->versionRemote() === $this->version()) {
                return false;
            }
        }

        return $this->update();
    }

    public function update()
    {
        $newStart = $this->network->get($this->config->getRepositoryUrl() . '/start');

        if ($newStart) {
            file_put_contents($this->config->getRootDir() . '/start', $newStart);
            $this->command->run('chmod +x ' . Text::quoteArgs($this->config->getRootDir() . '/start'));

            /**
             * README.md
             */
            $this->updateReadme(false, true);

            return true;
        }

        return false;
    }

    public function dxvkAutoupdate()
    {
        if ($this->config->isDxvkAutoupdate()) {
            $this->updateDxvk();
        }

        return false;
    }

    public function versionDxvk()
    {
        $dxvk = $this->config->wine('DRIVE_C') . '/dxvk';

        if (file_exists($dxvk)) {
            return trim(file_get_contents($dxvk));
        }

        return '';
    }

    public function versionDxvkRemote()
    {
        static $version;

        if (null === $version) {
            $version = trim($this->network->get('https://raw.githubusercontent.com/doitsujin/dxvk/master/RELEASE'), " \t\n\r");
        }

        return $version;
    }

    public function updateDxvk()
    {
        if (!Network::isConnected() || !$this->config->isDxvk() || !file_exists($this->config->wine('WINEPREFIX'))) {
            return false;
        }

        $this->updateDxvkConfig();

        $dxvk = $this->config->wine('DRIVE_C') . '/dxvk';
        $log  = $this->config->wine('WINEPREFIX') . "/winetricks.log";

        if (file_exists($log)) {
            $winetricks = array_filter(array_map('trim', explode("\n", file_get_contents($log))),
                function ($n) {return !$n && $n !== 'dxvk';});
            file_put_contents($log, implode("\n", $winetricks));
        }

        $newVersion = $this->versionDxvkRemote();
        $oldVersion = $this->versionDxvk();

        if ($newVersion !== $oldVersion) {
            (new Wine($this->config, $this->command))->winetricks(['dxvk']);
            file_put_contents($dxvk, $newVersion);

            return true;
        }

        return false;
    }

    public function downloadWinetricks()
    {
        $filePath = $this->config->getRootDir() . '/winetricks';
        $isDelete = false;

        if (file_exists($filePath)) {
            $createAt  = filectime($filePath);
            $currentAt = time();

            if (($currentAt - $createAt) > 86400) {
                $isDelete = true;
            }
        }

        if (!file_exists($filePath)) {
            $winetricks = $this->network
                ->get('https://raw.githubusercontent.com/Winetricks/winetricks/master/src/winetricks');

            if ($winetricks) {
                if ($isDelete) {
                    unlink($filePath);
                }

                file_put_contents($filePath, $winetricks);
                $this->command->run("chmod +x \"{$filePath}\"");

                return true;
            }
        }

        return false;
    }

    public function downloadSquashfuse()
    {
        $filePath = $this->config->getRootDir() . '/squashfuse';

        if (!file_exists($filePath)) {

            $squashfuse = $this->network->getRepo('/squashfuse');

            if ($squashfuse) {
                file_put_contents($filePath, $squashfuse);
                $this->command->run("chmod +x \"{$filePath}\"");

                return true;
            }
        }

        return false;
    }

    public function downloadFusezip()
    {
        $filePath = $this->config->getRootDir() . '/fuse-zip';

        if (!file_exists($filePath)) {

            $fusezip = $this->network->getRepo('/fuse-zip');

            if ($fusezip) {
                file_put_contents($filePath, $fusezip);
                $this->command->run("chmod +x \"{$filePath}\"");

                return true;
            }
        }

        return false;
    }

    public function downloadHwprobe()
    {
        $filePath = $this->config->getRootDir() . '/hw-probe';

        if (!file_exists($filePath)) {

            $hwprobe = $this->network->getRepo('/hw-probe');

            if ($hwprobe) {
                file_put_contents($filePath, $hwprobe);
                $this->command->run("chmod +x \"{$filePath}\"");

                return true;
            }
        }

        return false;
    }

    public function downloadOsd()
    {
        $filePath = $this->config->getRootDir() . '/osd';

        if (!file_exists($filePath)) {

            $osd = $this->network->getRepo('/osd');

            if ($osd) {
                file_put_contents($filePath, $osd);
                $this->command->run("chmod +x \"{$filePath}\"");

                return true;
            }
        }

        return false;
    }

    public function updatePhp()
    {
        if ($this->system->checkPhp()) {
            return false;
        }

        $filePath = $this->config->getRootDir() . '/php';

        $php = $this->network->getRepo('/php');

        if ($php) {
            if (file_exists($filePath)) {
                @unlink($filePath);
            }
            file_put_contents($filePath, $php);
            $this->command->run("chmod +x \"{$filePath}\"");

            return true;
        }

        return false;
    }
}



class Monitor {

    private $config;
    private $command;
    private $xrandr;
    private $monitors;
    private $jsonPath;

    /**
     * Monitor constructor.
     */
    public function __construct(Config $config, Command $command)
    {
        $this->command  = $command;
        $this->config   = $config;
        $this->jsonPath = $this->config->getRootDir() . '/resolutions.json';
    }

    public function isXrandr()
    {
        if (null === $this->xrandr) {
            $this->xrandr = (bool)trim($this->command->run("which xrandr"));
        }

        return $this->xrandr;
    }

    public function resolutions($reload = false)
    {
        if (!$this->isXrandr()) {
            return [];
        }

        if (false === $reload && null !== $this->monitors) {
            return $this->monitors;
        }

        $head = '/^(.*) connected( | primary )([0-9]{3,4}x[0-9]{3,4}).*\n*/m';
        $dump = $this->command->run('xrandr --verbose');
        $array = explode("\n", $dump);
        $monitors = [];

        preg_match_all($head, $dump, $matches);

        foreach ($matches[0] as $i => $_line) {
            $monitors[$matches[1][$i]] = [
                'output' => $matches[1][$i],
                'resolution' => $matches[3][$i],
            ];

            $inner = false;
            foreach ($array as $line) {
                if (!$line || !$_line) {
                    continue;
                }
                if ($inner === false && strpos($_line, $line) !== false) {
                    $inner = true;
                    $monitors[$matches[1][$i]]['default'] = strpos($line, 'primary') !== false;
                } elseif ($inner) {
                    if (strpos($line, 'connected') !== false || strpos($line, 'disconnected') !== false) {
                        $inner = false;
                    } else {
                        if (isset($monitors[$matches[1][$i]]['brightness'], $monitors[$matches[1][$i]]['gamma'])) {
                            $inner = false;
                            break;
                        }
                        if (strpos($line, 'Brightness:') !== false) {
                            $value = trim(str_replace('Brightness:', '', $line));
                            $monitors[$matches[1][$i]]['brightness'] = $value;
                        }
                        if (strpos($line, 'Gamma:') !== false) {
                            $value = trim(str_replace('Gamma:', '', $line));
                            $monitors[$matches[1][$i]]['gamma'] = $value;
                        }
                    }
                }
            }
        }

        $this->monitors = $monitors;

        return $this->monitors;
    }

    public function getDefaultMonitor()
    {
        $monitors = $this->resolutions();

        foreach ($monitors as $monitor) {
            if ($monitor['default']) {
                return $monitor;
            }
        }

        return [];
    }

    public function resolutionsSave()
    {
        file_put_contents($this->jsonPath, json_encode($this->resolutions(true), JSON_PRETTY_PRINT));
    }

    public function resolutionLoad()
    {
        if (file_exists($this->jsonPath)) {
            return json_decode(file_get_contents($this->jsonPath), true);
        }

        return null;
    }

    public function resolutionsRestore()
    {
        if (!$this->isXrandr()) {
            return [];
        }

        $result   = [];
        $monitors = $this->resolutions(true);

        foreach ($this->resolutionLoad()?:[] as $output => $params) {
            if ($monitors[$output]) {
                if ($params['gamma'] !== $monitors[$output]['gamma']) {
                    $this->command->run(Text::quoteArgs($this->config->wine('WINESERVER')) . " -w && xrandr --output {$output} --gamma {$params['gamma']}");
                    $result[] = "Revert gamma, output {$output}, gamma {$monitors[$output]['gamma']} > {$params['gamma']}.";
                }
                if ($params['brightness'] !== $monitors[$output]['brightness']) {
                    $this->command->run(Text::quoteArgs($this->config->wine('WINESERVER')) . " -w && xrandr --output {$output} --brightness {$params['brightness']}");
                    $result[] = "Revert brightness, output {$output}, brightness {$monitors[$output]['brightness']} > {$params['brightness']}.";
                }
                if ($params['resolution'] !== $monitors[$output]['resolution']) {
                    $this->command->run(Text::quoteArgs($this->config->wine('WINESERVER')) . " -w && xrandr --output {$output} --mode {$params['resolution']}");
                    $result[] = "Revert resolution, output {$output}, resolution {$monitors[$output]['resolution']} > {$params['resolution']}.";
                }
            }
        }

        if (file_exists($this->jsonPath)) {
            @unlink($this->jsonPath);
        }

        return $result;
    }
}



class WinePrefix {

    private $command;
    private $config;
    private $wine;
    private $monitor;
    private $system;
    private $fs;
    private $update;
    private $event;
    private $log;
    private $buffer;
    private $created = false;

    /**
     * WinePrefix constructor.
     * @param Config $config
     * @param Command $command
     */
    public function __construct(Config $config, Command $command)
    {
        $this->command = $command;
        $this->config  = $config;
        $this->wine    = new Wine($this->config, $this->command);
        $this->monitor = new Monitor($this->config, $this->command);
        $this->system  = new System($this->config, $this->command);
        $this->fs      = new FileSystem($this->config, $this->command);
        $this->update  = new Update($this->config, $this->command);
        $this->event   = new Event($this->config, $this->command);
    }

    public function log($text)
    {
        $logPath = $this->config->getLogsDir() . '/prefix.log';

        if (null === $this->log) {
            $this->log = app('start')->getLog();
        }

        if (null === $this->buffer) {
            $this->buffer = app('start')->getBuffer();
            $this->buffer->clear();
            if (file_exists($logPath)) {
                @unlink($logPath);
            }
        }

        $this->log->insertLogFile($text, $logPath);
        $this->buffer->add($text);
    }

    public function create()
    {
        if (file_exists($this->config->getRootDir() . '/wine/bin')) {
            $this->command->run('chmod +x -R ' . Text::quoteArgs($this->config->getRootDir() . '/wine/bin/'));
        }

        if (!file_exists($this->config->wine('WINEPREFIX'))) {

            app('gui');
            $this->created = true;

            (new CheckDependencies($this->config, $this->command, $this->system))->check();

            app()->showPrefix();

            $this->log('Create folder "' . $this->config->wine('WINEPREFIX') . '"');
            app()->getCurrentScene()->setProgress(10);

            $this->log('Initialize ' . $this->wine->version() . ' prefix.');
            $this->wine->boot();
            @file_put_contents($this->config->wine('WINEPREFIX') . '/version', $this->wine->version());
            app()->getCurrentScene()->setProgress(20);

            /**
             * Apply replace {WIDTH}, {HEIGHT}, {USER} from files
             */
            foreach ($this->updateReplaces() as $replace) {
                $this->log($replace);
            }
            app()->getCurrentScene()->setProgress(25);


            /**
             * Apply reg files
             */
            if (file_exists($this->config->getRegsDir())) {
                $regs      = ['Windows Registry Editor Version 5.00', ''];
                $filesPath = glob($this->config->getRegsDir() . '/*.reg');
                $files     = array_map('file_get_contents', $filesPath);

                foreach ($filesPath as $path) {
                    $this->log('Apply reg file "' . $this->fs->relativePath($path) . '"');
                }

                foreach ($files as $file) {
                    $file = Text::normalize($file);
                    $file = trim($file);
                    $file = explode("\n", $file);
                    if (in_array(trim(reset($file)), ['Windows Registry Editor Version 5.00', 'REGEDIT4'], true)) {
                        unset($file[0]);
                    }
                    foreach ($file as $line) {
                        if ($line !== null) {
                            $regs[] = $line;
                        }
                    }
                }

                if (count($regs) > 2) {
                    file_put_contents($this->config->wine('DRIVE_C') . '/tmp.reg', implode("\n", $regs));
                    $this->wine->reg([$this->config->wine('DRIVE_C') . '/tmp.reg']);
                    unset($regs);
                }
            }
            app()->getCurrentScene()->setProgress(35);


            /**
             * Copy required dlls and override them
             */
            $this->updateDlls();
            app()->getCurrentScene()->setProgress(60);

            /**
             * Sandbox the prefix; Borrowed from winetricks scripts
             */
            if ($this->config->isSandbox()) {
                unlink($this->config->wine('WINEPREFIX') . '/dosdevices/z:');

                foreach (glob($this->config->wine('DRIVE_C') . '/users/' . $this->system->getUserName() . '/*') as $filePath) {
                    if (is_link($filePath)) {
                        unlink($filePath);
                        if (!mkdir($filePath, 0775, true) && !is_dir($filePath)) {
                            throw new \RuntimeException(sprintf('Directory "%s" was not created', $filePath));
                        }
                    }
                }
                $this->wine->reg(['/d', 'HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Explorer\Desktop\Namespace\{9D20AAE8-0625-44B0-9CA7-71889C2254D9}']);
                file_put_contents($this->config->wine('WINEPREFIX') . '/.update-timestamp', 'disable');
                $this->log('Set sandbox.');
            }
            app()->getCurrentScene()->setProgress(62);


            /**
             * Create symlinks to additional folders
             */
            if (file_exists($this->config->getAdditionalDir()) && file_exists($this->config->getAdditionalDir() . '/path.txt')) {

                $folders = array_filter(array_map('trim', explode("\n", file_get_contents($this->config->getAdditionalDir() . '/path.txt'))));

                if ($folders) {
                    $adds = glob($this->config->getAdditionalDir() . '/dir_*/');
                    $isCyrillic = $this->system->isCyrillic();

                    $folderCount = count($folders);
                    if (count($adds) >= $folderCount) {
                        foreach ($adds as $i => $path) {
                            if ($i >= $folderCount) {
                                break;
                            }

                            $add = str_replace('--REPLACE_WITH_USERNAME--', $this->system->getUserName(), trim($folders[$i], " \t\n\r\0\x0B/"));

                            if (!$isCyrillic) {
                                $add = str_replace('Мои документы', 'My Documents', $add);
                            }

                            $gameInfoAddDir = Text::quoteArgs($this->fs->relativePath($path));
                            $dirAdd = Text::quoteArgs($this->config->wine('DRIVE_C') . "/{$add}");
                            $this->command->run("mkdir -p {$dirAdd} && rm -r {$dirAdd} && ln -sfr {$gameInfoAddDir} {$dirAdd}");
                            $this->log('Create symlink ' . $gameInfoAddDir . ' > ' . Text::quoteArgs($this->fs->relativePath($this->config->wine('DRIVE_C') . "/{$add}")));
                        }
                    }
                }
            }
            app()->getCurrentScene()->setProgress(66);

            /**
             * Enable or disable CSMT
             */
            $this->updateCsmt();
            app()->getCurrentScene()->setProgress(70);


            /**
             * Set sound driver to PulseAudio; Borrowed from winetricks
             */
            $this->updatePulse();
            app()->getCurrentScene()->setProgress(75);


            /**
             * Create symlink to game directory
             */
            $this->createGameDirectory();
            app()->getCurrentScene()->setProgress(80);


            /**
             * Set windows version; Borrowed from winetricks
             */
            $this->updateWinVersion();
            app()->getCurrentScene()->setProgress(85);


            /**
             * Install latest dxvk (d3d11.dll and dxgi.dll)
             */
            if ($this->update->updateDxvk()) {
                $dxvk = $this->update->versionDxvk();
                $this->log("DXVK updated to {$dxvk}.");
            }
            app()->getCurrentScene()->setProgress(90);


            /**
             * Fired hooks
             */
            $this->event->createPrefix();
            app()->getCurrentScene()->setProgress(95);
            $this->event->gpu();
            app()->getCurrentScene()->setProgress(100);

            $this->log('Success!');
        }

        $this->init();
    }

    public function init()
    {
        if (!$this->wine->checkWine()) {
            (new Logs())->log('There is no Wine available in your system!');
            exit(0);
        }


        /**
         * Create symlink to game directory
         */
        $this->createGameDirectory();


        /**
         * Enable or disable CSMT
         */
        $this->updateCsmt();


        /**
         * Copy required dlls and override them
         */
        $this->updateDlls();


        /**
         * Set sound driver to PulseAudio; Borrowed from winetricks
         */
        $this->updatePulse();


        /**
         * Set windows version; Borrowed from winetricks
         */
        $this->updateWinVersion();


        /**
         * Update configs
         */
        $this->update->updateConfig();
        $this->update->updateDxvkConfig();
    }

    public function updateReplaces()
    {
        if (!file_exists($this->config->wine('WINEPREFIX'))) {
            return [];
        }

        if (!$this->config->get('replaces', 'file')) {
            return [];
        }

        $userName = $this->system->getUserName();
        $result = [];
        $width  = '';
        $height = '';

        foreach ($this->monitor->resolutions() as $output => $monitor) {
            if (!$width || !$height) {
                list($w, $h) = explode('x', $monitor['resolution']);
                $width  = $w;
                $height = $h;
            }
            if ($monitor['default']) {
                list($w, $h) = explode('x', $monitor['resolution']);
                $width  = $w;
                $height = $h;
            }
        }

        foreach ((array)$this->config->get('replaces', 'file') as $file) {

            $file = trim($file, " \t\n\r\0\x0B/");

            if (file_exists($this->config->getRootDir() . "/{$file}")) {
                $data = file_get_contents($this->config->getRootDir() . "/{$file}");
                $data = str_replace(['{WIDTH}', '{HEIGHT}', '{USER}'], [$width, $height, $userName], $data);
                @file_put_contents($this->config->getRootDir() . "/{$file}", $data);
                $result[] = "Replace {WIDTH}x{HEIGHT} -> {$width}x{$height}, {USER} -> \"{$userName}\" from file \"{$file}\"";
            }
        }

        return $result;
    }

    public function updateDlls()
    {
        if (!file_exists($this->config->wine('WINEPREFIX'))) {
            return [];
        }

        /**
         * Copy required dlls and override them
         */
        $dlls     = [];
        $isDll32  = file_exists($this->config->getDllsDir()) && file_exists($this->config->wine('DRIVE_C') . "/windows/system32/");
        $isDll64  = file_exists($this->config->getDlls64Dir()) && file_exists($this->config->wine('DRIVE_C') . "/windows/syswow64/");
        $isChange = false;
        $result   = [];

        if ($isDll32) {

            $files = glob($this->config->getDllsDir(). '/*.dll');

            if ($this->config->get('dlls', 'dll')) {
                foreach ($this->config->get('dlls', 'dll') as $dll => $rule) {
                    $path = $this->config->getDllsDir() . "/{$dll}";
                    if (file_exists($path) && !in_array($path, $files, true)) {
                        $files[] = $path;
                    }
                }
            }

            foreach ($files as $filePath) {
                $fileName = basename($filePath);
                $to = $this->config->wine('DRIVE_C') . "/windows/system32/{$fileName}";

                if (file_exists($to)) {
                    if (md5_file($filePath) === md5_file($to)) {
                        continue;
                    } else {
                        unlink($to);
                    }
                }

                $isChange = true;
                $dlls[$fileName] = 'native';
                $dll32 = $this->fs->relativePath($this->config->getDllsDir());
                $this->command->run("ln -sfr \"{$dll32}/{$fileName}\" " . Text::quoteArgs($this->config->wine('DRIVE_C') . '/windows/system32'));
                $result[] = "Add system32/{$fileName}";
                $this->log("Add system32/{$fileName}");
            }
        }

        if ($isDll64) {

            $files = glob($this->config->getDlls64Dir() . '/*.dll');

            if ($this->config->get('dlls', 'dll')) {
                foreach ($this->config->get('dlls', 'dll') as $dll => $rule) {
                    $path = $this->config->getDlls64Dir() . "/{$dll}";
                    if (file_exists($path) && !in_array($path, $files, true)) {
                        $files[] = $path;
                    }
                }
            }

            foreach ($files as $filePath) {
                $fileName = basename($filePath);
                $to = $this->config->wine('DRIVE_C') . "/windows/syswow64/{$fileName}";

                if (file_exists($to)) {
                    if (md5_file($filePath) === md5_file($to)) {
                        continue;
                    } else {
                        unlink($to);
                    }
                }

                $isChange = true;
                $dlls[$fileName] = 'native';
                $dll64 = $this->fs->relativePath($this->config->getDlls64Dir());
                $this->command->run("ln -sfr \"{$dll64}/{$fileName}\" \" " . Text::quoteArgs($this->config->wine('DRIVE_C') . '/windows/syswow64'));
                $result[] = "Add system64/{$fileName}";
                $this->log("Add system64/{$fileName}");
            }
        }

        if ($isChange) {
            $dlls = array_filter($dlls);
            if ($dlls) {
//                $this->runExternal("\"{$this->wineConfig['WINE']}\" reg delete \"HKEY_CURRENT_USER\\Software\\Wine\\DllOverrides\" /f");

                $configDlls = $this->config->get('dlls', 'dll');
                foreach ($dlls as $dll => $typeOverride) {
                    if (!empty($configDlls) && !empty($configDlls[$dll])) {
                        if ($configDlls[$dll] === 'nooverride') {
                            $result[] = "Register skip {$dll}";
                            $this->log("Register skip {$dll}");
                            continue;
                        }
                        if ($configDlls[$dll] === 'register') {
                            $this->wine->regsvr32([$dll]);
                            $result[] = "Register regsvr32 {$dll}";
                            $this->log("Register regsvr32 {$dll}");
                            continue;
                        }

                        $typeOverride = $configDlls[$dll];
                    }

                    $this->wine->run(['reg', 'add', 'HKEY_CURRENT_USER\\Software\\Wine\\DllOverrides', '/v', $dll, '/d', $typeOverride, '/f']);
                    $result[] = "Register {$dll}";
                    $this->log("Register {$dll}");
                }

                $result[] = "Update dll overrides.";
                $this->log("Update dll overrides.");
            }
        }

        return $result;
    }

    public function updateCsmt()
    {
        if (!file_exists($this->config->wine('WINEPREFIX'))) {
            return false;
        }

        $reg = [
            "Windows Registry Editor Version 5.00\n",
            "[HKEY_CURRENT_USER\Software\Wine\Direct3D]\n",
        ];

        $file = $this->config->wine('DRIVE_C') . '/csmt.reg';

        if ($this->config->isCsmt() && !file_exists($file)) {
            $reg[] = "\"csmt\"=-\n";
            file_put_contents($file, implode("\n", $reg));
            $this->wine->reg([$file]);
            $this->log('CSMT enable.');

            return true;
        } elseif (!$this->config->isCsmt() && file_exists($file)) {
            $reg[] = "\"csmt\"=dword:0\n";
            file_put_contents($file, implode("\n", $reg));
            $this->wine->reg([$file]);
            unlink($file);
            $this->log('CSMT disable.');

            return false;
        }

        return $this->config->isCsmt();
    }

    public function updatePulse()
    {
        if (!file_exists($this->config->wine('WINEPREFIX'))) {
            return false;
        }

        $reg = [
            "Windows Registry Editor Version 5.00\n",
            "[HKEY_CURRENT_USER\Software\Wine\Drivers]\n",
        ];

        $isInstallPulseAudio = (bool)trim($this->command->run("which pulseaudio"));

        if ($isInstallPulseAudio === false && $this->config->isPulse()) {
            $this->config->set('script', 'pulse', 0);
        }

        $filePulsa = $this->config->wine('DRIVE_C') . '/usepulse.reg';
        $fileAlsa  = $this->config->wine('DRIVE_C') . '/usealsa.reg';

        if ($this->config->isPulse() && !file_exists($filePulsa)) {

            $reg[] = "\"Audio\"=\"pulse\"\n";
            file_put_contents($filePulsa, implode("\n", $reg));
            $this->wine->reg([$filePulsa]);

            if (file_exists($fileAlsa)) {
                unlink($fileAlsa);
            }

            $this->log('Set sound driver to PulseAudio.');

            return true;

        } elseif (!$this->config->isPulse() && !file_exists($fileAlsa)) {

            $reg[] = "\"Audio\"=\"alsa\"\n";
            file_put_contents($fileAlsa, implode("\n", $reg));
            $this->wine->reg([$fileAlsa]);

            if (file_exists($filePulsa)) {
                unlink($filePulsa);
            }

            $this->log('Set sound driver to Alsa.');

            return false;
        }

        return $this->config->isPulse();
    }

    public function updateWinVersion()
    {
        if (!file_exists($this->config->wine('WINEPREFIX'))) {
            return false;
        }

        $lastwin = $this->config->wine('DRIVE_C') . '/lastwin';

        if (file_exists($lastwin)) {
            $winver = trim(file_get_contents($lastwin));

            if ($winver === $this->config->getWindowsVersion()) {
                return false;
            }
        }

        $default = [];
        $defaultWinver = 'win7';

        $reg = [
            "Windows Registry Editor Version 5.00\n",
        ];

        switch ($this->config->getWindowsVersion()) {
            case 'win2k';
                $defaultWinver = 'win2k';
                $default = [
                    'HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion' => [
                        'CSDVersion'         => 'Service Pack 4',
                        'CurrentBuildNumber' => '2195',
                        'CurrentVersion'     => '5.0',
                    ],
                    'HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Windows'     => [
                        'CSDVersion' => 'dword:00000400',
                    ],
                ];
                break;

            case 'winxp';
                $defaultWinver = 'winxp';
                $default = [
                    'HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion' => [
                        'CSDVersion'         => 'Service Pack 3',
                        'CurrentBuildNumber' => '2600',
                        'CurrentVersion'     => '5.1',
                    ],
                    'HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Windows'     => [
                        'CSDVersion' => 'dword:00000300',
                    ],
                ];
                break;

            case 'win7':
            default:
                $this->wine->run(['reg', 'add', 'HKLM\\System\\CurrentControlSet\\Control\\ProductOptions', '/v', 'ProductType', '/d', 'WinNT', '/f']);
                $defaultWinver = 'win7';
                $default = [
                    'HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion' => [
                        'CSDVersion'         => 'Service Pack 1',
                        'CurrentBuildNumber' => '7601',
                        'CurrentVersion'     => '6.1',
                    ],
                    'HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Windows'     => [
                        'CSDVersion' => 'dword:00000100',
                    ],
                ];
        }

        foreach ($default as $path => $values) {
            $reg[] = "\n[{$path}]\n";
            foreach ($values as $key => $value) {
                $reg[] = "\"{$key}\"=\"{$value}\"\n";
            }
        }

        file_put_contents($lastwin, $defaultWinver);
        file_put_contents($this->config->wine('DRIVE_C') . '/setwinver.reg', implode('', $reg));

        $this->wine->reg([$this->config->wine('DRIVE_C') . '/setwinver.reg']);
        $this->log("Set Windows {$defaultWinver} version.");

        return true;
    }

    public function createGameDirectory()
    {
        /**
         * Create symlink to game directory
         */
        if (!file_exists($this->config->getPrefixGameFolder()) && file_exists($this->config->wine('WINEPREFIX'))) {

            $data = $this->fs->relativePath($this->config->getDataDir());
            $game = $this->config->getPrefixGameFolder();
            $this->command->run("mkdir -p \"{$game}\" && rm -r \"{$game}\" && ln -sfr \"{$data}\" \"{$game}\"");

            $gameFolder = trim(str_replace($this->config->wine('DRIVE_C'), '', $this->config->getPrefixGameFolder()), " \t\n\r\0\x0B/");
            $this->log("Create game folder \"{$data}\" > " . Text::quoteArgs($this->fs->relativePath($this->config->getPrefixGameFolder())) . '.');

            return $gameFolder;
        }

        return '';
    }

    public function createLibsDirectory()
    {
        $libs = $this->config->getRootDir() . '/libs';

        if (!file_exists($libs)) {
            if (!mkdir($libs, 0775, true) && !is_dir($libs)) {
                throw new \RuntimeException(sprintf('Directory "%s" was not created', $libs));
            }
            $this->log('Create libs folder ' . Text::quoteArgs($this->fs->relativePath($libs)) . '.');

            if (!mkdir("{$libs}/i386", 0775, true) && !is_dir("{$libs}/i386")) {
                throw new \RuntimeException(sprintf('Directory "%s" was not created', "{$libs}/i386"));
            }
            $this->log('Create libs folder ' . Text::quoteArgs($this->fs->relativePath("{$libs}/i386")) . '.');

            if (!mkdir("{$libs}/x86-64", 0775, true) && !is_dir("{$libs}/x86-64")) {
                throw new \RuntimeException(sprintf('Directory "%s" was not created', "{$libs}/x86-64"));
            }
            $this->log('Create libs folder ' . Text::quoteArgs($this->fs->relativePath("{$libs}/x86-64")) . '.');

            file_put_contents("{$libs}/readme.txt",'В папки i386, x86-64 можно ложить специфичные библиотеки для wine.');
        }
    }

    public function isCreated()
    {
        return $this->created;
    }
}



class GameInfo {

    private $command;
    private $config;
    private $log;
    private $buffer;
    private $created = false;

    /**
     * GameInfo constructor.
     * @param Config $config
     * @param Command $command
     */
    public function __construct(Config $config, Command $command)
    {
        if (posix_geteuid() === 0) {
            (new Logs)->log('Do not run this script as root!');
            exit(0);
        }

        $this->command = $command;
        $this->config  = $config;
    }

    public function log($text)
    {
        $logPath = $this->config->getLogsDir() . '/game_info.log';

        if (null === $this->log) {
            $this->log = app('start')->getLog();
        }

        if (null === $this->buffer) {
            $this->buffer = app('start')->getBuffer();
            $this->buffer->clear();
            if (file_exists($logPath)) {
                @unlink($logPath);
            }
        }

        $this->log->insertLogFile($text, $logPath);
        $this->buffer->add($text);
    }

    public function create()
    {
        if (!file_exists($this->config->getGameInfoDir())) {

            app('gui');
            $this->created = true;

            app()->showGameInfo();

            $folders = [
                $this->config->getLogsDir(),
                $this->config->getCacheDir(),
                $this->config->getGameInfoDir(),
                $this->config->getAdditionalDir(),
                $this->config->getDataDir(),
                $this->config->getDllsDir(),
                $this->config->getDlls64Dir(),
                $this->config->getHooksDir(),
                $this->config->getHooksGpuDir(),
                $this->config->getRegsDir(),
            ];

            foreach ($folders as $path) {
                if (!file_exists($path) && !mkdir($path, 0775, true) && !is_dir($path)) {
                    throw new \RuntimeException(sprintf('Directory "%s" was not created', $path));
                }

                $this->log("Create folder \"{$path}\"");
            }

            $readme = 'readme.txt';


            /**
             * game_info/readme.txt
             */
            file_put_contents(
                $this->config->getGameInfoDir() . "/{$readme}",
                "Эта директория необходима для работы скрипта.

Описание директорий/файлов:

game_info.ini - информация об игре (обязательный файл)
data - каталог с игрой (обязательная директория)
dlls - дополнительные dll файлы (необязательная директория)
dlls64 - дополнительные dll файлы (необязательная директория)
additional - специфичные для игры настройки (необязательная директория)
hooks - скрипты которые выполняются в зависимости от каких либо событий (необязательная директория)
regs - файлы реестра windows (необязательная директория)"
            );
            $this->log('Create file   "' . $this->config->getGameInfoDir() . "/{$readme}" . '"');

            /**
             * game_info/game_info.ini
             */
            file_put_contents($this->config->getConfigFile(), $this->config->getDefaultConfig());
            $this->log('Create file   "' . $this->config->getConfigFile() . '"');

            /**
             * game_info/data/readme.txt
             */
            file_put_contents(
                $this->config->getDataDir() . "/{$readme}",
                "Здесь должна находиться игра."
            );
            $this->log('Create file   "' . $this->config->getDataDir() . "/{$readme}" . '"');


            /**
             * game_info/dlls/readme.txt
             */
            file_put_contents(
                $this->config->getDllsDir() . "/{$readme}",
                "В эту директорию нужно класть необходимые игре DLL файлы. Если таких нет
директорию можно удалить."
            );
            $this->log('Create file   "' . $this->config->getDllsDir() . "/{$readme}" . '"');


            /**
             * game_info/dlls64/readme.txt
             */
            file_put_contents(
                $this->config->getDlls64Dir() . "/{$readme}",
                "В эту директорию нужно класть необходимые игре DLL файлы. Если таких нет
директорию можно удалить."
            );
            $this->log('Create file   "' . $this->config->getDlls64Dir() . "/{$readme}" . '"');


            /**
             * game_info/regs/readme.txt
             */
            file_put_contents(
                $this->config->getRegsDir() . "/{$readme}",
                "Здесь должны находиться .reg файлы."
            );
            $this->log('Create file   "' . $this->config->getRegsDir() . "/{$readme}" . '"');


            /**
             * game_info/additional/readme.txt
             */
            file_put_contents(
                $this->config->getAdditionalDir() . "/{$readme}",
                "Специфичные для игры настройки. Класть в директории dir_1, dir_2, dir_3
и т.д. Путь для копирования (относительно drive_c) нужно указывать
в файле path.txt. Первая строчка для dir_1, вторая - для dir_2 и т.д.
Всю директорию additional можно удалить, если к игре не нужно заранее
применять настройки.

--REPLACE_WITH_USERNAME-- в файле path.txt заменяется на имя пользователя
автоматически."
            );
            $this->log('Create file   "' . $this->config->getAdditionalDir() . "/{$readme}" . '"');


            /**
             * game_info/additional/path.txt
             */
            file_put_contents(
                $this->config->getAdditionalDir() . '/path.txt',
                "users/--REPLACE_WITH_USERNAME--/Мои документы
users/--REPLACE_WITH_USERNAME--/Documents"
            );
            $this->log('Create file   "' . $this->config->getAdditionalDir() . '/path.txt' . '"');

            if (!mkdir($this->config->getAdditionalDir() . '/dir_1', 0775, true) && !is_dir($path)) {
                throw new \RuntimeException(sprintf('Directory "%s" was not created', $path));
            }
            if (!mkdir($this->config->getAdditionalDir() . '/dir_2', 0775, true) && !is_dir($path)) {
                throw new \RuntimeException(sprintf('Directory "%s" was not created', $path));
            }
            $this->log('Create folder "' . $this->config->getAdditionalDir() . '/dir_1' . '"');
            $this->log('Create folder "' . $this->config->getAdditionalDir() . '/dir_2' . '"');


            /**
             * game_info/additional/dir_1/readme.txt
             */
            file_put_contents(
                $this->config->getAdditionalDir() . "/dir_1/{$readme}",
                "Здесь должно находиться содержимое директории dir_1."
            );
            $this->log('Create file   "' . $this->config->getAdditionalDir() . "/dir_1/{$readme}" . '"');

            app()->getCurrentScene()->setProgress(5);

            /**
             * README.md
             */
            if ((new Update($this->config, $this->command))->updateReadme(true)) {
                $this->log('Create file   "' . $this->config->getRootDir() . '/README.md' . '"');
            }


            /**
             * game_info/hooks/after.sh
             */
            file_put_contents(
                $this->config->getHooksDir() . '/after.sh',
                '#' ."!/bin/sh\necho \"After!\""
            );
            $this->log('Create file   "' . $this->config->getHooksDir() . '/after.sh' . '"');


            /**
             * game_info/hooks/before.sh
             */
            file_put_contents(
                $this->config->getHooksDir() . '/before.sh',
                '#' ."!/bin/sh\necho \"Before!\""
            );
            $this->log('Create file   "' . $this->config->getHooksDir() . '/before.sh' . '"');


            /**
             * game_info/hooks/create.sh
             */
            file_put_contents(
                $this->config->getHooksDir() . '/create.sh',
                '#' ."!/bin/sh\necho \"Create prefix!\"\ncd ../../\n./start unlock\n./start winetricks wmp9"
            );
            $this->log('Create file   "' . $this->config->getHooksDir() . '/create.sh' . '"');


            if (!file_exists($this->config->getHooksGpuDir())) {
                if (!mkdir($this->config->getHooksGpuDir(), 0775, true) && !is_dir($this->config->getHooksGpuDir())) {
                    throw new \RuntimeException(sprintf('Directory "%s" was not created', $this->config->getHooksGpuDir()));
                }
            }
            $this->log('Create folder "' . $this->config->getHooksGpuDir() . '"');

            /**
             * game_info/hooks/gpu/amd.sh
             */
            file_put_contents(
                $this->config->getHooksGpuDir() . '/amd.sh',
                '#' ."!/bin/sh\necho \"AMD GPU hook!\""
            );
            $this->log('Create file   "' . $this->config->getHooksGpuDir() . '/amd.sh' . '"');


            /**
             * game_info/hooks/gpu/nvidia.sh
             */
            file_put_contents(
                $this->config->getHooksGpuDir() . '/nvidia.sh',
                '#' ."!/bin/sh\necho \"NVIDIA GPU hook!\""
            );
            $this->log('Create file   "' . $this->config->getHooksGpuDir() . '/nvidia.sh' . '"');


            /**
             * game_info/hooks/gpu/intel.sh
             */
            file_put_contents(
                $this->config->getHooksGpuDir() . '/intel.sh',
                '#' ."!/bin/sh\necho \"Intel GPU hook!\""
            );
            $this->log('Create file   "' . $this->config->getHooksGpuDir() . '/intel.sh' . '"');

            app()->getCurrentScene()->setProgress(10);
        }
    }

    public function isCreated()
    {
        return $this->created;
    }
}



class CheckDependencies {

    private $command;
    private $config;
    private $log;
    private $buffer;
    private $system;

    /**
     * Event constructor.
     * @param Config $config
     * @param Command $command
     * @param System $system
     */
    public function __construct(Config $config, Command $command, System $system)
    {
        $this->command = $command;
        $this->config  = $config;
        $this->system  = $system;
    }

    public function log($text)
    {
        $logPath = $this->config->getLogsDir() . '/dependencies.log';

        if (null === $this->log) {
            $this->log = app('start')->getLog();
        }

        if (null === $this->buffer) {
            $this->buffer = app('start')->getBuffer();
            $this->buffer->clear();
            if (file_exists($logPath)) {
                @unlink($logPath);
            }
        }

        $this->log->insertLogFile($text, $logPath);
        $this->buffer->add($text);
    }

    private function formattedItem($item, $value)
    {
        $length     = 25;
        $lengthItem = mb_strlen($item);
        return  '- ' . $item . ' ' . str_repeat('.', $length - $lengthItem) . ' ' . $value;
    }

    public function check()
    {
        app()->showCheckDependencies();

        $this->log('Check dependencies.');
        $this->log('');

        $isOk = true;

        $apps = [
            'wine'       => false,
            'zenity'     => false,
            'xrandr'     => false,
            'pulseaudio' => false,
            'glxinfo'    => false,
            'grep'       => false,
            'tar'        => false,
            'wget'       => false,
            'ldconfig'   => false,
            'mksquashfs' => false,
            'ldd'        => false,
            'ps'         => false,
            'lspci'      => false,
            'fusermount' => false,
            'mount'      => false,
            'tee'        => false,
            'sed'        => false,
            'xlsfonts'   => false,
            'id'         => false,
            'cabextract' => false,
            'p7zip'      => false,
            'unrar'      => false,
            'unzip'      => false,
            'zip'        => false,
            'binutils'   => false,
            'ffmpeg'     => false,
            'sudo'       => false,
        ];

        ksort($apps);

        $percent  = 100 / (count($apps) + 4);
        $progress = 0;

        foreach ($apps as $app => $_) {
            if ($app === 'binutils') {
                $app = 'ld';
            }

            $is = trim($this->command->run("which {$app}"));

            if ($app === 'ld') {
                $app = 'binutils';
            }

            if ($is) {
                $apps[$app] = true;
                $this->log($this->formattedItem($app, 'ok'));
            } else {
                $apps[$app] = false;
                $this->log($this->formattedItem($app, 'fail'));
            }

            $progress += $percent;
            app()->getCurrentScene()->setProgress($progress);
        }

        $isVulkan = (bool)$this->command->run('ldconfig -p | grep libvulkan.so');
        $this->log($this->formattedItem('libvulkan', $isVulkan ? 'ok' : 'fail'));

        $progress += $percent;
        app()->getCurrentScene()->setProgress($progress);

        $isFuse = (bool)$this->command->run('ldconfig -p | grep libfuse.so');
        $this->log($this->formattedItem('libfuse', $isFuse ? 'ok' : 'fail'));

        $progress += $percent;
        app()->getCurrentScene()->setProgress($progress);

        $isOpenAL = (bool)$this->command->run('ldconfig -p | grep libopenal.so');
        $this->log($this->formattedItem('libopenal', $isOpenAL ? 'ok' : 'fail'));

        $progress += $percent;
        app()->getCurrentScene()->setProgress($progress);

        $isXinerama = (bool)$this->command->run('ldconfig -p | grep libXinerama.so');
        $this->log($this->formattedItem('libxinerama1', $isXinerama ? 'ok' : 'fail'));

        $progress += $percent;
        app()->getCurrentScene()->setProgress($progress);

        if (false === $apps['wine']) {
            $isOk = false;

            $this->log('');
            $this->log('Please install wine.');

            $this->log('');
            $this->log("Ubuntu:
sudo dpkg --add-architecture i386
wget -nc --no-check-certificate https://dl.winehq.org/wine-builds/Release.key
sudo apt-key add Release.key
sudo apt-add-repository https://dl.winehq.org/wine-builds/ubuntu/
sudo apt-get update
sudo apt-get install binutils cabextract p7zip-full unrar unzip wget wine zenity

Debian:
dpkg --add-architecture i386 && apt-get update
apt-get install wine32 wine binutils unzip cabextract p7zip-full unrar-free wget zenity");
        }

        if (false === $apps['zenity']) {
            $isOk = false;
            $this->log('');
            $this->log('Please install zenity.');
            $this->log("sudo apt-get install zenity");
        }

        if (false === $apps['xrandr']) {
            $isOk = false;
            $this->log('');
            $this->log('Please install xrandr.');
            $this->log("sudo apt-get install x11-xserver-utils");
        }

        if (!$isVulkan && $this->config->isDxvk()) {
            $isOk = false;
            $this->log('');
            $this->log('Please install libvulkan1.');
            $this->log("sudo apt-get install libvulkan1");
        }

        if (!$isFuse) {
            if (file_exists($this->config->getRootDir() . '/wine.squashfs')
                || file_exists($this->config->getRootDir() . '/game_info/data.squashfs')) {
                $isOk = false;
            }
            $this->log('');
            $this->log('Install libfuse.');
            $this->log("sudo apt-get install libfuse2");
        }

        if ($this->config->isEsync() || $this->config->isDxvk()) {
            $currentUlimit     = $this->system->getUlimitSoft();
            $recommendedUlimit = 200000;

            if ($recommendedUlimit > $currentUlimit) {
                $this->log('');
                $this->log("Error. Current ulimit: {$currentUlimit}, Required min ulimit: {$recommendedUlimit}");
                $this->log('');
                $this->log('Add to "/etc/security/limits.conf" file and reboot system:');
                $this->log("* soft nofile {$recommendedUlimit}");
                $this->log("* hard nofile {$recommendedUlimit}");
            }
        }

        if (false === $isOk) {
            $this->log('');
            $this->log("Press any key to exit.");
            ncurses_getch();
            exit(0);
        }
    }
}



class Icon
{
    private $config;
    private $command;
    private $system;
    private $user;
    private $home;
    private $folders;
    private $local;
    private $title;

    /**
     * Icon constructor.
     * @param Config $config
     * @param Command $command
     * @param System $system
     */
    public function __construct(Config $config, Command $command, System $system)
    {
        $this->command = $command;
        $this->config  = $config;
        $this->system  = $system;

        $this->user    = $this->system->getUserName();
        $this->home    = getenv("HOME") ?: "/home/{$this->user}";
        $this->folders = [
            "{$this->home}/Рабочий стол/Games",
            "{$this->home}/Рабочий стол/games",
            "{$this->home}/Рабочий стол/Игры",
            "{$this->home}/Рабочий стол/игры",
            "{$this->home}/Рабочий стол",
            "{$this->home}/Desktop/Игры",
            "{$this->home}/Desktop/игры",
            "{$this->home}/Desktop/Games",
            "{$this->home}/Desktop/games",
            "{$this->home}/Desktop",
        ];

        $desktop = $this->system->getDesktopPath();

        if ($desktop) {
            $this->folders = array_unique(array_merge(
                [
                    "{$desktop}/Games",
                    "{$desktop}/games",
                    "{$desktop}/Игры",
                    "{$desktop}/игры",
                    $desktop,
                ],
                $this->folders
            ));
        }

        $this->local = "{$this->home}/.local/share/applications";
        $this->title = $this->config->getGameTitle();

        if (!file_exists($this->local) && file_exists($this->home)) {
            if (!mkdir($this->local, 0775, true) && !is_dir($this->local)) {
                throw new \RuntimeException(sprintf('Directory "%s" was not created', $this->local));
            }
        }
    }

    public function create($png, $isAddMenu = true)
    {
        $icon = $this->getTemplate($png);
        $result = [];

        if ($isAddMenu) {
            file_put_contents("{$this->local}/{$this->title}.desktop", $icon);
            $result[] = "{$this->local}/{$this->title}.desktop";
        }

        if ($desktop = $this->findDir()) {
            $fileName = "{$desktop}/{$this->title}";
            if (file_exists($fileName)) {
                file_put_contents($fileName, $icon);
                $result[] = $fileName;
            } else {
                file_put_contents("{$fileName}.desktop", $icon);
                $result[] = "{$fileName}.desktop";
            }
        }

        return $result;
    }

    public function remove()
    {
        $icons = $this->findExistIcons();

        if (!$icons) {
            return [];
        }

        foreach ($icons as $icon) {
            @unlink($icon);
        }

        return $icons;
    }

    /**
     * @return array
     */
    public function findExistIcons()
    {
        $result = [];

        foreach (array_merge([$this->local], $this->folders) as $item) {
            $v1 = "{$item}/{$this->title}";
            $v2 = "{$v1}.desktop";

            if (file_exists($v1) && !is_dir($v1)) {
                $result[] = $v1;
            } elseif (file_exists($v2) && !is_dir($v2)) {
                $result[] = $v2;
            }
        }

        return $result;
    }

    /**
     * @return string
     */
    public function findDir()
    {
        foreach ($this->folders as $folder) {
            if (file_exists($folder) && is_dir($folder)) {
                return $folder;
            }
        }

        return '';
    }

    /**
     * @return array
     */
    public function findPng()
    {
        $rootDir = $this->config->getRootDir();

        $icons   = [];
        $icons[] = glob("{$rootDir}/*.png");
        $icons[] = glob("{$rootDir}/game_info/*.png");

        return array_filter(call_user_func_array('array_merge', $icons));
    }

    /**
     * @param string $png
     * @return string
     */
    public function getTemplate($png)
    {
        $rootDir = $this->config->getRootDir();

        return "[Desktop Entry]
Version=1.0
Exec={$rootDir}/start
Path={$rootDir}
Icon={$png}
Name={$this->title}
Terminal=false
TerminalOptions=
Type=Application
Categories=Game";
    }
}



class Pack
{
    private $command;
    private $config;
    private $fs;

    /**
     * Pack constructor.
     * @param Config $config
     * @param Command $command
     * @param FileSystem $fs
     */
    public function __construct(Config $config, Command $command, FileSystem $fs)
    {
        $this->config  = $config;
        $this->command = $command;
        $this->fs      = $fs;
    }

    public function pack($folder)
    {
        $mount = $this->getMount($folder);

        if (false === $mount || $mount->isMounted() || !file_exists($folder)) {
            return false;
        }

        if ($this->isMksquashfs()) {

            if (file_exists("{$folder}.squashfs")) {
                @unlink("{$folder}.squashfs");
            }

            if ($folder === $this->config->getWineDir() && file_exists("{$folder}/bin")) {
                $this->command->run('chmod +x -R ' . Text::quoteArgs("{$folder}/bin"));
            }

            $folderName = basename($folder);

            $cmd = "mksquashfs \"{$folder}\" \"{$folder}.squashfs\" -b 1048576 -comp gzip -Xcompression-level 9";

            if ('wine' === $folderName) {
                $cmd = "mksquashfs \"{$folder}\" \"{$folder}.squashfs\" -b 1048576 -comp xz -Xdict-size 100%";
            }

            $this->command->run($cmd);

            return true;
        }

        return false;
    }

    public function unpack($folder)
    {
        $mount = $this->getMount($folder);

        if (false === $mount || !$mount->isMounted() || !file_exists($folder)) {
            return false;
        }

        if (file_exists("{$folder}_tmp")) {
            $this->fs->rm("{$folder}_tmp");
        }

        $this->fs->cp($folder, "{$folder}_tmp");
        $mount->umount();

        if ($mount->isMounted() || file_exists($folder)) {
            register_shutdown_function(function () use ($folder) {
                if (!file_exists($folder) && file_exists(file_exists("{$folder}_tmp"))) {
                    $this->fs->mv("{$folder}_tmp", $folder);
                }
            });
        } else {
            $this->fs->mv("{$folder}_tmp", $folder);
        }

        return true;
    }

    public function isMksquashfs()
    {
        static $result;

        if (null === $result) {
            $result = (bool)trim($this->command->run('which mksquashfs'));
        }

        return $result;
    }

    public function getMount($folder)
    {
        $mountes = app('start')->getMountes();
        $findMount = null;

        foreach ($mountes as $mount) {
            /** @var Mount $mount */
            if ($mount->getFolder() === $folder) {
                $findMount = $mount;
                break;
            }
        }

        if (!$findMount) {
            return false;
        }

        return $findMount;
    }

    public function getMountes()
    {
        $result  = [];
        $mountes = app('start')->getMountes();

        foreach ($mountes as $mount) {
            /** @var Mount $mount */
            if ($mount->isMounted()) {
                $result[] = $mount->getFolder() . '.' .$mount->getExtension();
            }
        }

        return $result;
    }
}



class Symlink
{
    private $command;
    private $config;
    private $fs;
    private $extensions;

    /**
     * Symlink constructor.
     * @param Config $config
     * @param Command $command
     * @param FileSystem $fs
     */
    public function __construct(Config $config, Command $command, FileSystem $fs)
    {
        $this->config     = $config;
        $this->command    = $command;
        $this->fs         = $fs;
        $this->extensions = ['cfg', 'conf', 'ini', 'inf', 'log', 'sav', 'save', 'config', 'con', 'profile'];
    }

    /**
     * @return array
     */
    public function getExtensions()
    {
        return $this->extensions;
    }

    public function replace($path)
    {
        $path = trim($path, " \t\n\r\0\x0B/\\");

        if (!$path || !file_exists($this->config->getDataDir() . "/{$path}")) {
            return false;
        }

        $symlinks  = $this->config->getSymlinksDir();
        $_symlinks = $this->config->getDataSymlinksDir();
        $data      = $this->config->getDataDir();

        $this->fs->mkdirs([$symlinks, $_symlinks]);
        $this->fs->mv("{$data}/{$path}","{$_symlinks}/{$path}");
        $this->cloneDir($this->fs->relativePath("{$_symlinks}/{$path}", $data));
        $this->fs->link("{$symlinks}/{$path}", "{$data}/{$path}");

        return true;
    }

    public function cloneDir($path)
    {
        $path = trim($path, " \t\n\r\0\x0B/\\");

        if (!$path || !file_exists($this->config->getDataDir() . "/{$path}")) {
            return false;
        }

        $symlinks  = $this->config->getSymlinksDir();
        $_symlinks = $this->config->getDataSymlinksDir();
        $data      = $this->config->getDataDir();

        $in  = "{$data}/{$path}";
        $out = "{$symlinks}/" . $this->fs->relativePath($in, $_symlinks);
        $this->fs->mkdirs([$out]);

        foreach (glob("{$in}/*") as $_path) {
            if (is_dir($_path)) {
                $this->cloneDir($this->fs->relativePath($_path, $data));
            } else {
                $basename = pathinfo($_path);
                $_out     = "{$symlinks}/" . $this->fs->relativePath($_path, $_symlinks);

                if (in_array(strtolower($basename['extension']), $this->getExtensions(), true)) {
                    $this->fs->cp($_path, $_out);
                } else {
                    $this->fs->link($_path, $_out);
                }
            }
        }

        return true;
    }

    public function getDirs()
    {
        $result = [];

        foreach (glob($this->config->getDataDir() . '/*') as $path) {

            $name = basename($path);

            if ('_symlinks' !== $name && is_dir($path) && !is_link($path)) {
                $result[] = $name;
            }
        }

        return $result;
    }
}



class Build
{
    private $command;
    private $config;
    private $system;
    private $fs;

    /**
     * Build constructor.
     * @param Config $config
     * @param Command $command
     * @param System $system
     * @param FileSystem $fs
     */
    public function __construct(Config $config, Command $command, System $system, FileSystem $fs)
    {
        $this->config     = $config;
        $this->command    = $command;
        $this->system     = $system;
        $this->fs         = $fs;
    }

    public function checkSupportReset()
    {
        $root = $this->config->getRootDir();

        return !(!file_exists($this->config->getDataFile())
            || !file_exists("{$root}/static.tar.gz")
            || !file_exists("{$root}/extract.sh"));
    }

    public function reset()
    {
        if (!$this->checkSupportReset()) {
            return false;
        }

        foreach (app('start')->getMountes() as $mount) {
            /** @var Mount $mount */
            $mount->umount();
        }

        $root     = $this->config->getRootDir();
        $gameInfo = $this->config->getGameInfoDir();

        foreach (glob("{$gameInfo}/*") as $item) {
            $name = basename($item);
            if ($name !== 'data.squashfs') {
                $this->command->run("rm -rf \"{$item}\"");
            }
        }

        foreach (glob("{$root}/*") as $item) {
            $name = basename($item);
            if (!in_array($name, ['game_info', 'extract.sh', 'static.tar.gz'], true)) {
                $this->command->run("rm -rf \"{$item}\"");
            }
        }

        if (file_exists("{$root}/libs")) {
            $this->command->run("rm -rf \"{$root}/libs\"");
        }

        return true;
    }

    public function build($isPrefix = false)
    {
        $root     = $this->config->getRootDir();
        $gameDir  = basename($root);
        $userName = $this->system->getUserName();
        $gameInfo = $this->config->getGameInfoDir();
        $gameData = $this->config->getDataDir();

        if (file_exists("{$root}/build")) {
            $this->command->run("rm -rf \"{$root}/build\"");
        }

        if (!mkdir("{$root}/build/{$gameDir}/static/game_info", 0775, true) && !is_dir("{$root}/build/{$gameDir}/static/game_info")) {
            throw new \RuntimeException(sprintf('Directory "%s" was not created', "{$root}/build/{$gameDir}/static/game_info"));
        }
        if (!mkdir("{$root}/build/{$gameDir}/game_info", 0775, true) && !is_dir("{$root}/build/{$gameDir}/game_info")) {
            throw new \RuntimeException(sprintf('Directory "%s" was not created', "{$root}/build/{$gameDir}/game_info"));
        }

        foreach (glob("{$root}/*.png") as $path) {
            $this->command->run("cp -a --link \"{$path}\" \"{$root}/build/{$gameDir}/static/\"");
        }

        if (file_exists("{$root}/wine.squashfs")) {
            $this->command->run("cp -a --link \"{$root}/wine.squashfs\" \"{$root}/build/{$gameDir}/static/\"");
        } elseif (file_exists("{$root}/wine")) {
            $this->command->run("cp -ra --link \"{$root}/wine\" \"{$root}/build/{$gameDir}/static/wine\"");
        }

        if (file_exists("{$root}/libs")) {
            $this->command->run("cp -ra --link \"{$root}/libs\" \"{$root}/build/{$gameDir}/static/libs\"");
        }
        if (file_exists("{$root}/README.md")) {
            $this->command->run("cp -a --link \"{$root}/README.md\" \"{$root}/build/{$gameDir}/static/\"");
        }
        if (file_exists("{$root}/php")) {
            $this->command->run("cp -a --link \"{$root}/php\" \"{$root}/build/{$gameDir}/static/\"");
        }
        if (file_exists("{$root}/squashfuse")) {
            $this->command->run("cp -a --link \"{$root}/squashfuse\" \"{$root}/build/{$gameDir}/static/\"");
        }
        if (file_exists("{$root}/fuse-zip")) {
            $this->command->run("cp -a --link \"{$root}/fuse-zip\" \"{$root}/build/{$gameDir}/static/\"");
        }
        if (file_exists("{$root}/start")) {
            $this->command->run("cp -a --link \"{$root}/start\" \"{$root}/build/{$gameDir}/static/\"");
        }
        if ($isPrefix && file_exists("{$root}/prefix")) {
            $this->command->run("cp -ra --link \"{$root}/prefix\" \"{$root}/build/{$gameDir}/static/prefix\"");
            if ($userName) {
                $userFolder = "{$root}/build/{$gameDir}/static/prefix/drive_c/users/{$userName}";
                if (file_exists($userFolder)) {
                    $this->command->run("rm -rf \"{$userFolder}\"");
                }
            }
        }

        $skip = [
            'data',
            'dataold',
            'data_old',
            'data.old',
            'databak',
            'data_bak',
            'data.bak',
            'test',
            'testold',
            'test_old',
            'test.old',
            'testbak',
            'test_bak',
            'test.bak',
            'test1',
            'test2',
            'test3',
            'test4',
            'data1',
            'data2',
            'data3',
            'data4',
            'data.squashfs',
            'data1.squashfs',
            'data2.squashfs',
            'data.zip',
            'data1.zip',
            'data2.zip',
            'logs',
            'cache',
        ];

        foreach (glob("{$gameInfo}/*") as $path) {
            $file = basename($path);

            if (in_array($file, $skip, true)) {
                continue;
            }

            if (is_dir($path)) {
                $this->command->run("cp -ra --link \"{$path}\" \"{$root}/build/{$gameDir}/static/game_info/{$file}\"");
            } else {
                $this->command->run("cp -a --link \"{$path}\" \"{$root}/build/{$gameDir}/static/game_info/\"");
            }
        }

        if (file_exists("{$gameInfo}/data.squashfs")) {
            $this->command->run("cp -a --link \"{$gameInfo}/data.squashfs\" \"{$root}/build/{$gameDir}/game_info/\"");
        } elseif (file_exists("{$gameInfo}/data.zip")) {
            $this->command->run("cp -a --link \"{$gameInfo}/data.zip\" \"{$root}/build/{$gameDir}/game_info/\"");
        } elseif (file_exists($gameData)) {
            $this->command->run("cp -rav --link \"{$gameData}\" \"{$root}/build/{$gameDir}/game_info/data\"");
        }

        $this->command->run("tar -cvzf \"{$root}/build/{$gameDir}/static.tar.gz\" -C \"{$root}/build/{$gameDir}/static\" .");
        $this->command->run("rm -rf \"{$root}/build/{$gameDir}/static/\"");

        /**
         * build/extract.sh
         */
        file_put_contents("{$root}/build/{$gameDir}/extract.sh",
            "#!/bin/sh

cd -P -- \"$(dirname -- \"$0\")\"

tar -xvf ./static.tar.gz

chmod +x ./start"
        );

        $this->command->run("chmod +x \"{$root}/build/{$gameDir}/extract.sh\"");
    }
}



class Task
{
    private $command;
    private $config;
    private $logfile;
    private $cmd;
    private $monitor;
    private $event;
    private $fs;
    private $fps;
    private $fpsCmd;
    private $system;
    private $update;

    /**
     * Task constructor.
     * @param Config $config
     * @param Wine $wine
     */
    public function __construct(Config $config)
    {
        $this->config  = clone $config;
        $this->command = new Command($this->config);
        $this->wine    = new Wine($this->config, $this->command);
        $this->monitor = new Monitor($this->config, $this->command);
        $this->event   = new Event($this->config, $this->command);
        $this->fs      = new FileSystem($this->config, $this->command);
        $this->system  = new System($this->config, $this->command);
        $this->update  = new Update($this->config, $this->command);
    }

    public function logName($prefix)
    {
        $this->logfile = "{$prefix}.log";
        return $this;
    }

    public function debug()
    {
        $this->config->set('wine', 'WINEDEBUG', '');
        return $this;
    }

    public function fps()
    {
        $this->fps = true;

        $root = $this->config->getRootDir();

        if (!$this->config->isDxvk()) {
            $mesa = $this->system->getMesaVersion();

            if ($mesa) {
                $this->config->set('export', 'GALLIUM_HUD', 'simple,fps');
            } else {
                $this->update->downloadOsd();
                $font = $this->system->getFont();
                $font = $font ? "--font=\"{$font}\"" : '';
                $add = [
                    ' 2>&1',
                    'tee /dev/stderr',
                    'sed -u -n -e \'/trace/ s/.*approx //p\'',
                    "\"{$root}/osd\" --lines=1 {$font} --color=yellow",
                ];
                $this->fpsCmd = implode(' | ', $add);
                $this->config->set('export', 'WINEDEBUG', '-all,fps');
            }
        } elseif (!$this->config->get('export', 'DXVK_HUD')) {
            $this->config->set('export', 'DXVK_HUD', 'fps,devinfo,memory');
        }

        return $this;
    }

    public function cmd($cmd)
    {
        $this->cmd = $cmd;
        return $this;
    }

    private function desktop()
    {
        if ($this->config->getBool('window', 'enable')) {
            $title      = $this->config->get('window', 'title');
            $resolution = $this->config->get('window', 'resolution');

            return "explorer \"/desktop={$title},{$resolution}\"";
        }

        return '';
    }

    public function game()
    {
        $driveC     = $this->config->wine('DRIVE_C');
        $gamePath   = $this->config->getGamePath();
        $additional = $this->config->getGameAdditionalPath();

        $fullPath   = implode('/', array_filter([$driveC, $gamePath, $additional]));
        $wine       = $this->config->wine('WINE');
        $desktop    = $this->desktop();
        $fileName   = $this->config->getGameExe();
        $arguments  = $this->config->getGameArgs();

        $this->cmd = "cd \"{$fullPath}\" && \"{$wine}\" {$desktop} \"{$fileName}\" {$arguments}";

        return $this;
    }

    public function run()
    {
        $this->beforeRun();

        $logging = null;

        if ($this->logfile) {
            $logging = $this->config->getLogsDir() . "/{$this->logfile}";
        }

        if ($this->cmd) {
            $this->command->run("{$this->cmd} {$this->fpsCmd}", $logging);
        }

        $this->afterExit();
    }

    private function beforeRun()
    {
        if ($this->system->checkPhp()) {

            app('gui');

            $scene = app()->getCurrentScene();
            $popup = $scene->addWidget(new PopupInfoWidget($scene->getWindow()));
            $popup
                ->setTitle('Running')
                ->setText([
                    'Application is running...',
                    $this->fpsCmd ? '' : 'See log ./' . $this->fs->relativePath($this->config->getLogsDir() . "/{$this->logfile}"),
                ])
                ->setActive(true)
                ->show();

        }

        $this->monitor->resolutionsSave();
        $this->event->beforeRun();
    }

    private function afterExit()
    {
        $this->event->afterExit();
        $this->monitor->resolutionsRestore();

        if ($this->system->checkPhp()) {
            app()->close();
        } else {
            exit(0);
        }
    }
}



class Console
{
    private $config;
    private $command;
    private $system;
    private $arguments;
    private $log;
    private $gui = false;

    /**
     * Console constructor.
     * @param Config $config
     * @param Command $command
     * @param System $system
     * @param Logs $log
     */
    public function __construct(Config $config, Command $command, System $system, Logs $log)
    {
        $this->config  = $config;
        $this->command = $command;
        $this->system  = $system;
        $this->log     = $log;

        global $argv;
        $this->arguments = array_splice($argv, 1);
    }

    public function isGui()
    {
        return trim(reset($this->arguments)) === 'gui' || $this->gui;
    }

    public function isHelp()
    {
        return in_array(trim(reset($this->arguments)), ['help', '-help', '--help', '-h']);
    }

    public function isWinetricks()
    {
        return trim(reset($this->arguments)) === 'winetricks';
    }

    public function isKill()
    {
        return trim(reset($this->arguments)) === 'kill';
    }

    public function isWine()
    {
        return trim(reset($this->arguments)) === 'wine';
    }

    public function wine($args)
    {
        $config = clone $this->config;
        $config->set('wine', 'WINEDEBUG', '');
        $cmd = Text::quoteArgs($args);
        (new Command($config))->run(Text::quoteArgs($config->wine('WINE')) . " {$cmd}", null, true);
    }

    public function lock()
    {
        static $lock;

        if (null === $lock) {

            $mount = $this->system->lock();
            $force = ($this->isKill() || $this->isWinetricks() || $this->isHelp() || $this->isWine());

            $lock = $mount;

            if (!$mount && !$force) {
                $this->log->logStart();
                $this->log->log('Application is already running.');
                $this->log->logStop();

                exit(0);
            }
        }

        return $lock;
    }

    public function init()
    {
        if (!$this->arguments) {

            (new Monitor($this->config, $this->command))->resolutionsRestore();

            /** @var Config $config */
            $config = app('start')->getConfig();

            $configs = $config->findConfigsPath();

            $starts = [];

            foreach ($configs as $i => $path) {
                if ($config->getConfigFile() === $path && count($configs) === 1) {
                    $starts[] = ['name' => $config->getGameTitle(), 'config' => $config];
                } else {
                    $cfg = new Config($path);
                    $starts[] = ['name' => $cfg->getGameTitle(), 'config' => $cfg];
                }
            }

            $title = 'Run';

            if ($this->system->isCyrillic()) {
                $title = 'Запустить';
            }

            $item = null;

            if (count($starts) > 1) {
                $item = (new Dialog())
                    ->columns(['name' => $title])
                    ->items($starts)
                    ->size(400, 300)
                    ->get();
            } elseif ($starts) {
                $item = reset($starts);
            }

            if (!$item) {
                exit(0);
            }

            /** @var Config $config */
            $config = $item['config'];

            $task = new Task($config);
            $task
                ->logName($config->getGameTitle())
                ->game()
                ->run();
        }

        if ($this->isKill()) {
            (new Wine($this->config, $this->command))->down();
            exit(0);
        }

        if ($this->isWine()) {
            $this->wine(array_splice($this->arguments, 1));
            exit(0);
        }

        if ($this->isWinetricks()) {
            $args = array_splice($this->arguments, 1);
            $this->log->log('Processing...');
            $this->log->log('See logs: ' . './game_info/logs/winetricks-' . implode('-', $args) . '.log');
            (new Wine($this->config, $this->command))->winetricks($args);
            exit(0);
        }

        if (!$this->isGui() && ($this->isHelp() || $this->arguments)) {
            $help = [
                'Help:',
                './start             - Run game.',
                './start gui         - Graphical user interface.',
                './start kill        - Kill this instance Wine.',
                './start winetricks  - Winetricks install d3dx9 (./start winetricks d3dx9).',
                './start wine        - Get Wine Instance.',
                './start help',
            ];
            $this->log->log(implode("\n", $help));
            exit(0);
        }

        (new Monitor($this->config, $this->command))->resolutionsRestore();
    }
}



class Dialog
{
    private $type;
    private $title;
    private $width;
    private $height;
    private $items;
    private $text;
    private $columns;

    /**
     * Dialog constructor.
     */
    public function __construct()
    {
        $this->type    = '--info';
        $this->width   = '--width=400';
        $this->height  = '';
        $this->title   = '--title=""';
        $this->items   = [];
    }

    public function typeInfo()
    {
        $this->type = '--info';
        return $this;
    }

    public function typeWarning()
    {
        $this->type = '--warning';
        return $this;
    }

    public function typeList()
    {
        $this->type = '--list';
        return $this;
    }
    public function typeQuestion()
    {
        $this->type = '--question';
        return $this;
    }

    public function title($title)
    {
        $this->title = "--title=\"{$title}\"";;
        return $this;
    }

    public function text($text)
    {
        $this->text = "--text=\"{$text}\"";
        return $this;
    }

    public function size($width = null, $height = null)
    {
        $this->width  = $width ? "--width={$width}" : '';
        $this->height = $height ? "--height={$height}" : '';

        return $this;
    }

    public function columns($columns)
    {
        $this->columns = $columns;
        return $this;
    }

    private function getColumns()
    {
        if ($this->columns) {
            $result = [];
            foreach ($this->columns as $id => $name) {
                $result[] = "--column=\"{$name}\"";
            }

            return '--hide-column=1 --column="" ' . implode(' ', $result);
        }

        return '';
    }

    public function items($items)
    {
        $this->typeList();
        $this->items = $items;
        return $this;
    }

    private function getItems()
    {
        if ($this->items) {
            $result = [];
            foreach ($this->items as $i => $item) {
                $result[] = "\"{$i}\"";
                foreach ($this->columns as $id => $column) {
                    $result[] = "\"{$item[$id]}\"";
                }
            }

            return implode(' ', $result);
        }

        return '';
    }

    public function get()
    {
        $zenity  = 'LD_LIBRARY_PATH="" zenity';
        $columns = $this->getColumns();
        $items   = $this->getItems();

        $cmd = "{$zenity} {$this->type} {$this->title} {$this->text} {$this->width} {$this->height} {$columns} {$items}";

        $returnVar = null;
        $output    = null;

        $result = trim(exec("{$cmd} 2> /dev/null", $returnVar, $output));

        if ('--question' === $this->type) {
            return (bool)$returnVar;
        }

        if ($result === '') {
            return null;
        }

        if ($result === '') {
            return null;
        }

        if ('--list' === $this->type && $this->items) {
            return $this->items[(int)$result];
        }

        return $result;
    }
}



class ControllerGUI {

    private $ncurses;
    private $scenes;

    /**
     * ControllerGUI constructor.
     */
    public function  __construct()
    {
        $this->ncurses = new NcursesObjects\Ncurses;
        $this->ncurses
            ->setEchoState(false)
            ->setNewLineTranslationState(true)
            ->setCursorState(NcursesObjects\Ncurses::CURSOR_INVISIBLE)
            ->refresh();

        if (ncurses_has_colors()) {
            ncurses_start_color();
            ncurses_assume_default_colors(NCURSES_COLOR_WHITE, NCURSES_COLOR_BLUE);
        }

        $this->scenes             = [];
        $this->scenes['main']     = new MainScene();
        $this->scenes['prefix']   = new PrefixScene();
        $this->scenes['gameInfo'] = new GameInfoScene();
        $this->scenes['check']    = new CheckDependenciesScene();
        $this->scenes['tools']    = new ToolsScene();
        $this->scenes['wine']     = new WineScene();
    }

    public function getNcurses()
    {
        return $this->ncurses;
    }

    public function getScenes($scene = null)
    {
        return null === $scene ? $this->scenes : $this->scenes[$scene];
    }

    public function hideAll()
    {
        foreach ($this->getScenes() as $scene) {
            foreach ($scene->getWidgets() as $widget) {
                /** @var AbstractWidget $widget */
                $widget->hide();
                $widget->destruct();

            }
            $scene->hide();
            $scene->destruct();
        }
    }

    public function start()
    {
        $this->showMain();
        app('start')->getBuffer()->setSize(
            $this->getMainScene()->getWindow()->getHeight()
        );
        $this->press();
    }

    public function press()
    {
        static $init = false;

        if ($init === false) {
            $init = true;
            while (true) {
                $this->pressKey(ncurses_getch());
            }
        }
    }

    public function pressKey($key)
    {
        pcntl_signal_dispatch();

        foreach ($this->getScenes() as $name => $scene) {
            if (!$scene->isActive()) {
                continue;
            }

            $pressToScene = true;
            foreach ($scene->getWidgets() as $widget) {
                /** @var AbstractWidget $widget */
                if ($widget->isActive()) {
                    if ($widget->pressKey($key) === false) {
                        return;
                    }
                    $pressToScene = false;
                }
            }

            if ($pressToScene) {
                if ($scene->pressKey($key) === false) {
                    return;
                }
            }
        }
    }

    /**
     * @return MainScene
     */
    public function getMainScene()
    {
        return $this->getScenes('main');
    }

    /**
     * @return PrefixScene
     */
    public function getPrefixScene()
    {
        return $this->getScenes('prefix');
    }

    /**
     * @return GameInfoScene
     */
    public function getGameInfoScene()
    {
        return $this->getScenes('gameInfo');
    }

    /**
     * @return GameInfoScene
     */
    public function getCheckDependenciesScene()
    {
        return $this->getScenes('check');
    }

    /**
     * @return ToolsScene
     */
    public function getToolsScene()
    {
        return $this->getScenes('tools');
    }

    /**
     * @return WineScene
     */
    public function getWineScene()
    {
        return $this->getScenes('wine');
    }

    /**
     * @return GameInfoScene|MainScene|PrefixScene
     */
    public function getCurrentScene()
    {
        foreach ($this->getScenes() as $scene) {
            if ($scene->isVisible()) {
                return $scene;
            }
        }

        return $this->getMainScene();
    }

    public function showMain()
    {
        $this->hideAll();
        $this->getMainScene()->show();
    }

    public function showPrefix()
    {
        $this->hideAll();
        $this->getPrefixScene()->show();
    }

    public function showGameInfo()
    {
        $this->hideAll();
        $this->getGameInfoScene()->show();
    }

    public function showCheckDependencies()
    {
        $this->hideAll();
        $this->getCheckDependenciesScene()->show();
    }

    public function showTools()
    {
        $this->hideAll();
        $this->getToolsScene()->show();
    }

    public function showWine()
    {
        $this->hideAll();
        $this->getWineScene()->show();
    }

    public function close()
    {
        posix_kill(posix_getpid(), SIGINT);
        pcntl_signal_dispatch();
    }
}



abstract class AbstractScene {

    protected $window;
    protected $active = false;
    protected $visible = false;
    protected $widgets;
    protected $history;

    private $changeWidgetActive;

    /**
     * MainScene constructor.
     */
    public function __construct()
    {
        $this->window  = new NcursesObjects\Window;
        $this->history = new History();
        $this->widgets = [];

        $onChangeWidgetActive = function ($status, $widget) {
            if ($status) {
                $this->history->add($widget);
            } else {
                $this->history->back();
            }

            $this->updateActiveWidget();
        };

        $this->changeWidgetActive = $onChangeWidgetActive;
    }

    public function show()
    {
        app()->hideAll();
        $this->visible = true;
        $this->setActive(true);
        $this->render();

        return $this;
    }

    public function hide()
    {
        if ($this->visible) {
            $this->visible = false;
            $this->window->erase()->refresh();
        }

        return $this;
    }

    /**
     * @return \NcursesObjects\Window
     */
    public function getWindow()
    {
        return $this->window;
    }

    public function addWidget($widget)
    {
        /** @var PrintWidget|ProgressBarWidget|SelectWidget|InfoWidget|PopupYesNoWidget|PopupInfoWidget|PopupSelectWidget $widget */
        $this->widgets[] = $widget;
        $widget->onChangeActiveEvent($this->changeWidgetActive);

        return $widget;
    }

    public function removeWidget($widget)
    {
        /** @var AbstractWidget $widget */
        $widget->offChangeActiveEvent($this->changeWidgetActive);
        $this->widgets = array_filter($this->widgets, function ($item) use (&$widget) {return $item !== $widget;});
    }

    public function getWidgets()
    {
        return $this->widgets;
    }

    public function isActive()
    {
        if (!$this->isVisible()) {
            $this->setActive(false);
        }

        return $this->active;
    }

    public function setActive($flag = true)
    {
        $this->active = $flag;
        return $this;
    }

    public function isVisible()
    {
        return $this->visible;
    }

    public function setVisible($flag = true)
    {
        $this->visible = $flag;
        return $this;
    }

    private function updateActiveWidget()
    {
        $current = $this->history->current();

        foreach ($this->widgets as $widget) {
            /** @var AbstractWidget $widget */
            $widget->offChangeActiveEvent($this->changeWidgetActive);
        }

        foreach ($this->getWidgets() as $widget) {
            /** @var AbstractWidget $widget */

            if ($widget === $current) {
                $widget->setActive(true);
            } else {
                $widget->setActive(false);
            }
        }

        foreach ($this->widgets as $widget) {
            /** @var AbstractWidget $widget */
            $widget->onChangeActiveEvent($this->changeWidgetActive);
        }
    }

    abstract public function render();

    abstract public function pressKey($key);

    public function destruct() {
        $this->widgets = [];
        $this->setActive(false);
        $this->setVisible(false);
    }
}



class MainScene extends AbstractScene
{
    private $selectIndex = 0;

    public function render()
    {
        /** @var Config $config */
        $config = app('start')->getConfig();
        /** @var Update $update */
        $update = app('start')->getUpdate();

        $this->window
            ->border()
            ->title('version: ' . $update->version())
            ->status($update->getUrl())
            ->refresh();

        $menu = $this->renderMenu();

        $info = $this->addWidget(new InfoWidget($this->window));
        $info
            ->setData($menu)
            ->show();

        if ($menu->selectAt($this->selectIndex)) {
            $menu->render();
        }
        $menu->onChangeEvent(function () use (&$menu) {
            $this->selectIndex = $menu->index();
        });
    }

    public function renderMenu()
    {
        /** @var Config $config */
        $config = app('start')->getConfig();

        $configs = $config->findConfigsPath();

        $starts = [];

        foreach ($configs as $i => $path) {
            if ($config->getConfigFile() === $path && count($configs) === 1) {
                $starts[] = ['id' => 'start', 'config' => $config, 'name' => 'Start'];
            } else {
                $cfg = new Config($path);
                $title = 'Start → ' . $cfg->getGameTitle() .'';
                $starts[] = ['id' => 'start', 'config' => $cfg, 'name' => $title];
            }
        }

        $items = array_merge(
            $starts,
            [
                ['id' => 'tools',    'name' => 'Tools'],
                ['id' => 'wine',     'name' => 'Wine'],
//                ['id' => 'settings', 'name' => 'Settings'],
                ['id' => 'info',     'name' => 'Info'],
                ['id' => 'exit',     'name' => 'Exit'],
            ]
        );

        $select = $this->addWidget(new PopupSelectWidget($this->window));
        $select
            ->setItems($items)
            ->border()
            ->setFullMode()
            ->maxSize(null, 16)
            ->offset(2, 1)
            ->setActive(true)
            ->show();

        $select->onEnterEvent(function ($item, $xy) {
            if ('wine' === $item['id']) {
                app()->showWine();
            }
            if ('tools' === $item['id']) {
                app()->showTools();
            }
            if ('exit' === $item['id']) {
                app()->close();
            }
            if ('start' === $item['id']) {
                $select = $this->addWidget(new PopupSelectWidget($this->window));
                $select
                    ->setItems([
                        ['id' => 'start', 'name' => 'Start'],
                        ['id' => 'debug', 'name' => 'Debug'],
                        ['id' => 'fps',   'name' => 'FPS'],
                    ])
                    ->border()
                    ->setFullMode()
                    ->backAccess()
                    ->maxSize(null, 4)
                    ->offset($xy['x'], $xy['y'])
                    ->setActive(true)
                    ->show();
                $select->onEscEvent(function () use (&$select) { $this->removeWidget($select->hide()); });
                $select->onEnterEvent(function ($type) use (&$select, &$item) {
                    $this->removeWidget($select->hide());

                    /** @var Config $config */
                    $config = $item['config'];

                    $task = new Task($config);
                    $task->logName($config->getGameTitle());

                    if ('debug' === $type['id']) {
                        $task->debug();
                    }
                    if ('fps' === $type['id']) {
                        $task->fps();
                    }

                    $task->game()->run();
                });
            }
        });

        return $select;
    }

    public function pressKey($key) {}
}



class PrefixScene extends AbstractScene
{
    private $updateTextCallable;
    /** @var PrintWidget */
    private $print;
    /** @var ProgressBarWidget */
    private $progressBar;

    public function show()
    {
        parent::show();

        $updateTextCallable = function ($text) {
            $this->print->update($text);
        };

        $this->updateTextCallable = $updateTextCallable;

        app('start')->getBuffer()->onChangeEvent($updateTextCallable);

        return $this;
    }

    public function hide()
    {
        parent::hide();

        app('start')->getBuffer()->offChangeEvent($this->updateTextCallable);

        return $this;
    }

    public function render()
    {
        $log = '~/game_info/logs/prefix.log';

        $this->window
            ->border()
            ->title('Create prefix')
            ->status($log)
            ->refresh();


        $this->progressBar = $this->addWidget(new ProgressBarWidget($this->window));
        $this->progressBar
            ->offset(mb_strlen($log) + 2, 3)
            ->setProgress(0)
            ->show();

        $this->print = $this->addWidget(new PrintWidget($this->window));
        $this->print
            ->dotMode()
            ->padding(1, 0, 1)
            ->show();
    }

    public function pressKey($key)
    {
        app()->showMain();
        return false;
    }

    public function setProgress($percent)
    {
        $this->progressBar->setProgress($percent)->render();
    }
}



class GameInfoScene extends AbstractScene
{
    private $updateTextCallable;
    /** @var PrintWidget */
    private $print;
    /** @var ProgressBarWidget */
    private $progressBar;

    public function show()
    {
        parent::show();

        $updateTextCallable = function ($text) {
            $this->print->update($text);
        };

        $this->updateTextCallable = $updateTextCallable;

        app('start')->getBuffer()->onChangeEvent($updateTextCallable);

        return $this;
    }

    public function hide()
    {
        parent::hide();

        app('start')->getBuffer()->offChangeEvent($this->updateTextCallable);

        return $this;
    }

    public function render()
    {
        $log = '~/game_info/logs/game_info.log';

        $this->window
            ->border()
            ->title('Create "game_info" folder')
            ->status($log)
            ->refresh();


        $this->progressBar = $this->addWidget(new ProgressBarWidget($this->window));
        $this->progressBar
            ->offset(mb_strlen($log) + 2, 3)
            ->setProgress(0)
            ->show();

        $this->print = $this->addWidget(new PrintWidget($this->window));
        $this->print
            ->dotMode()
            ->padding(1, 0, 1)
            ->show();
    }

    public function pressKey($key)
    {
        app()->showMain();
        return false;
    }

    public function setProgress($percent)
    {
        $this->progressBar->setProgress($percent)->render();
    }
}



class CheckDependenciesScene extends AbstractScene
{
    private $updateTextCallable;
    /** @var PrintWidget */
    private $print;
    /** @var ProgressBarWidget */
    private $progressBar;

    public function show()
    {
        parent::show();

        $updateTextCallable = function ($text) {
            $this->print->update($text);
        };

        $this->updateTextCallable = $updateTextCallable;

        app('start')->getBuffer()->onChangeEvent($updateTextCallable);

        return $this;
    }

    public function hide()
    {
        parent::hide();

        app('start')->getBuffer()->offChangeEvent($this->updateTextCallable);

        return $this;
    }

    public function render()
    {
        $log = '~/game_info/logs/dependencies.log';

        $this->window
            ->border()
            ->title('Check dependencies')
            ->status($log)
            ->refresh();


        $this->progressBar = $this->addWidget(new ProgressBarWidget($this->window));
        $this->progressBar
            ->offset(mb_strlen($log) + 2, 3)
            ->setProgress(0)
            ->show();

        $this->print = $this->addWidget(new PrintWidget($this->window));
        $this->print
            ->dotMode()
            ->padding(1, 0, 1)
            ->show();
    }

    public function pressKey($key)
    {
        app()->showMain();
        return false;
    }

    public function setProgress($percent)
    {
        $this->progressBar->setProgress($percent)->render();
    }
}



class ToolsScene extends AbstractScene {
    public function render()
    {
        /** @var Config $config */
        $config = app('start')->getConfig();
        /** @var Update $update */
        $update = app('start')->getUpdate();

        $this->window
            ->border()
            ->title('Tools')
            ->status($update->getUrl())
            ->refresh();

        $menu = $this->renderMenu();

        $info = $this->addWidget(new InfoWidget($this->window));
        $info
            ->setData($menu)
            ->show();
    }

    public function renderMenu()
    {
        /** @var FileSystem $fs */
        $fs = app('start')->getFileSystem();

        $items = [];
        $items[] = ['id' => 'back',   'name' => 'Back'];

        $pngs = array_map(
            function ($n) use (&$fs) {
                return ['name' => './' . $fs->relativePath($n), 'path' => $n];
            },
            app('start')->getIcon()->findPng()
        );

        if ($pngs) {
            $items[] = ['id' => 'icon',   'name' => 'Icon'];
        }

        if (Network::isConnected()) {
            $items[] = ['id' => 'update',   'name' => 'Update'];
        }

        $items[] = ['id' => 'pack',    'name' => 'Pack'];
        $items[] = ['id' => 'symlink', 'name' => 'Symlink'];
        $items[] = ['id' => 'build',   'name' => 'Build'];
        $items[] = ['id' => 'reset',   'name' => 'Reset'];

        $select = $this->addWidget(new PopupSelectWidget($this->window));
        $select
            ->setItems($items)
            ->border()
            ->setFullMode()
            ->maxSize(null, 16)
            ->offset(2, 1)
            ->setActive(true)
            ->show();

        $select->onEnterEvent(function ($item, $xy) use (&$pngs) {
            if ('back' === $item['id']) {
                app()->showMain();
            }
            if ('icon' === $item['id']) {
                $select = $this->addWidget(new PopupSelectWidget($this->window));
                $select
                    ->setItems([
                        ['id' => 'create', 'name' => 'Create'],
                        ['id' => 'remove', 'name' => 'Remove'],
                    ])
                    ->border()
                    ->setFullMode()
                    ->backAccess()
                    ->maxSize(null, 4)
                    ->offset($xy['x'], $xy['y'])
                    ->setActive(true)
                    ->show();
                $select->onEscEvent(function () use (&$select) { $this->removeWidget($select->hide()); });
                $select->onEnterEvent(function ($type) use (&$select, &$pngs) {
                    $this->removeWidget($select->hide());

                    if ('create' === $type['id']) {
                        $create = function ($icon) {
                            $addMenu = $this->addWidget(new PopupYesNoWidget($this->window));
                            $addMenu
                                ->setTitle('Icon Wizard')
                                ->setText('Add icon also to system menu?')
                                ->setActive(true)
                                ->show();
                            $addMenu->onEscEvent(function () use (&$addMenu) { $this->removeWidget($addMenu->hide()); });
                            $addMenu->onEnterEvent(function ($flag) use ($icon, &$addMenu) {
                                $addMenu->hide();
                                $this->removeWidget($addMenu);

                                $icons = app('start')->getIcon()->create($icon['path'], $flag);

                                $width = 60;

                                foreach ($icons as $icon) {
                                    if ($width < mb_strlen($icon)) {
                                        $width = mb_strlen($icon);
                                    }
                                }

                                $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                $popup
                                    ->setTitle('Success')
                                    ->setText(array_merge(['Add or update icons:'], $icons))
                                    ->size($width + 2, 9)
                                    ->setButton()
                                    ->setActive(true)
                                    ->show();
                                $popup->onEnterEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                            });
                        };

                        if (count($pngs) > 1) {
                            $select = $this->addWidget(new PopupSelectWidget($this->window));
                            $select
                                ->setItems($pngs)
                                ->setTitle('Select PNG file')
                                ->setEndMode()
                                ->backAccess()
                                ->maxSize(40, 10)
                                ->setActive(true)
                                ->show();
                            $select->onEscEvent(function () use (&$select) { $this->removeWidget($select->hide()); });
                            $select->onEnterEvent(function ($item) use (&$create, &$select) {
                                $this->removeWidget($select->hide());
                                $create($item);
                            });
                        } elseif (count($pngs) > 0) {
                            $create(reset($pngs));
                        }
                    }

                    if ('remove' === $type['id']) {
                        $icons = app('start')->getIcon()->findExistIcons();

                        if ($icons) {
                            $width = 60;

                            foreach ($icons as $icon) {
                                if ($width < mb_strlen($icon)) {
                                    $width = mb_strlen($icon);
                                }
                            }

                            $popup = $this->addWidget(new PopupYesNoWidget($this->getWindow()));
                            $popup
                                ->setTitle('Remove?')
                                ->setText(array_merge(['Found icons:'], $icons))
                                ->size($width + 2, 9)
                                ->backAccess()
                                ->setActive(true)
                                ->show();
                            $popup->onEscEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                            $popup->onEnterEvent(function ($flag) use (&$popup) {
                                $this->removeWidget($popup->hide());

                                if ($flag) {
                                    app('start')->getIcon()->remove();

                                    $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                    $popup
                                        ->setTitle('Success')
                                        ->setText('Icons removed')
                                        ->setButton()
                                        ->setActive(true)
                                        ->show();

                                    $popup->onEnterEvent(function () use (&$popup) {
                                        $this->removeWidget($popup->hide());
                                    });
                                }
                            });
                        } else {
                            $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                            $popup
                                ->setTitle('Error')
                                ->setText('Icons not found')
                                ->setButton()
                                ->backAccess()
                                ->setActive(true)
                                ->show();
                            $popup->onEscEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                            $popup->onEnterEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                        }
                    }
                });
            }
            if ('pack' === $item['id']) {
                $select = $this->addWidget(new PopupSelectWidget($this->window));
                $select
                    ->setItems([
                        ['id' => 'pack',   'name' => 'Pack'],
                        ['id' => 'unpack', 'name' => 'UnPack'],
                    ])
                    ->border()
                    ->setFullMode()
                    ->backAccess()
                    ->maxSize(null, 4)
                    ->offset($xy['x'], $xy['y'])
                    ->setActive(true)
                    ->show();
                $select->onEscEvent(function () use (&$select) { $this->removeWidget($select->hide()); });
                $select->onEnterEvent(function ($type) use (&$select, &$xy) {
                    $this->removeWidget($select->hide());

                    $select = $this->addWidget(new PopupSelectWidget($this->window));
                    $select
                        ->setItems([
                            ['id' => 'wine', 'name' => 'Wine'],
                            ['id' => 'data', 'name' => 'Data'],
                        ])
                        ->setTitle($type['name'])
                        ->border()
                        ->setFullMode()
                        ->backAccess()
                        ->maxSize(null, 4)
                        ->offset($xy['x'], $xy['y'])
                        ->setActive(true)
                        ->show();
                    $select->onEscEvent(function () use (&$select) { $this->removeWidget($select->hide()); });
                    $select->onEnterEvent(function ($folder) use (&$select, &$type) {
                        $this->removeWidget($select->hide());

                        /** @var Config $config */
                        $config = app('start')->getConfig();
                        $path   = '';

                        if ('wine' === $folder['id']) {
                            $path = $config->getWineDir();
                        }
                        if ('data' === $folder['id']) {
                            $path = $config->getDataDir();
                        }

                        if ($path) {

                            $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                            $popup
                                ->setTitle($type['name'] . 'ing ' . $folder['id'])
                                ->setText('Wait...')
                                ->setActive(true)
                                ->show();

                            $status = false;

                            if ('pack' === $type['id']) {
                                $status = app('start')->getPack()->pack($path);
                            }
                            if ('unpack' === $type['id']) {
                                $status = app('start')->getPack()->unpack($path);
                            }

                            $this->removeWidget($popup->hide());

                            if ($status) {
                                $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                $popup
                                    ->setTitle('Success')
                                    ->setText('Success ' . $type['id'] . ' "' . $folder['id'] . '" folder')
                                    ->setButton()
                                    ->setActive(true)
                                    ->show();
                                $popup->onEnterEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                            } else {
                                $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                $popup
                                    ->setTitle('Error')
                                    ->setText('Error ' . $type['id'] . ' "' . $folder['id'] . '"')
                                    ->setButton()
                                    ->setActive(true)
                                    ->show();
                                $popup->onEnterEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                            }
                        }
                    });
                });
            }
            if ('symlink' === $item['id']) {

                $folders = app('start')->getSymlink()->getDirs();

                if (!$folders) {
                    $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                    $popup
                        ->setTitle('Error')
                        ->setText('Not found directories in the "data" folder.')
                        ->setButton()
                        ->setActive(true)
                        ->show();
                    $popup->onEnterEvent(function () use (&$popup) {
                        $this->removeWidget($popup->hide());
                    });
                } else {
                    $select = $this->addWidget(new PopupSelectWidget($this->window));
                    $select
                        ->setItems(array_map(function ($n) {return ['name' => $n];}, $folders))
                        ->border()
                        ->setTitle('Directory')
                        ->setFullMode()
                        ->backAccess()
                        ->maxSize(null, 4)
                        ->offset($xy['x'], $xy['y'])
                        ->setActive(true)
                        ->show();
                    $select->onEscEvent(function () use (&$select) { $this->removeWidget($select->hide()); });
                    $select->onEnterEvent(function ($type) use (&$select) {
                        $this->removeWidget($select->hide());

                        $fs   = app('start')->getFileSystem();
                        $data = $fs->relativePath(app('start')->getConfig()->getDataDir());

                        $popup = $this->addWidget(new PopupYesNoWidget($this->window));
                        $popup
                            ->setTitle('Symlink Wizard')
                            ->setText("Replace \"./{$data}/{$type['name']}\" folder to symlink?")
                            ->setActive(true)
                            ->show();
                        $popup->onEscEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                        $popup->onEnterEvent(function ($flag) use (&$popup, &$type) {
                            $this->removeWidget($popup->hide());

                            if ($flag) {
                                $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                $popup
                                    ->setTitle('Create symlinks')
                                    ->setText('Wait...')
                                    ->setActive(true)
                                    ->show();

                                $result = app('start')->getSymlink()->replace($type['name']);

                                $this->removeWidget($popup->hide());

                                $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                $popup
                                    ->setTitle($result ? 'Success' : 'Error')
                                    ->setText($result ? 'Moved data' : 'Error moving')
                                    ->setButton()
                                    ->setActive(true)
                                    ->show();
                                $popup->onEnterEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                            }
                        });
                    });
                }
            }
            if ('build' === $item['id']) {

                $select = $this->addWidget(new PopupSelectWidget($this->window));
                $select
                    ->setItems([
                        ['id' => 'standard', 'name' => 'Standard'],
                        ['id' => 'prefix',   'name' => 'With "prefix" folder'],
                    ])
                    ->border()
                    ->setTitle('Build')
                    ->setFullMode()
                    ->backAccess()
                    ->maxSize(null, 4)
                    ->offset($xy['x'], $xy['y'])
                    ->setActive(true)
                    ->show();
                $select->onEscEvent(function () use (&$select) { $this->removeWidget($select->hide()); });
                $select->onEnterEvent(function ($type) use (&$select) {
                    $this->removeWidget($select->hide());

                    $popup = $this->addWidget(new PopupYesNoWidget($this->window));
                    $popup
                        ->setTitle('Build Wizard')
                        ->setText([
                            'Create a distribution of the game?',
                            'In to "./build" folder.'
                        ])
                        ->setActive(true)
                        ->show();
                    $popup->onEscEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                    $popup->onEnterEvent(function ($flag) use (&$popup, &$type) {
                        $this->removeWidget($popup->hide());

                        if ($flag) {
                            $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                            $popup
                                ->setTitle('Build')
                                ->setText('Wait...')
                                ->setActive(true)
                                ->show();

                            app('start')->getBuild()->build($type['id'] === 'prefix');

                            $this->removeWidget($popup->hide());

                            $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                            $popup
                                ->setTitle('Success')
                                ->setText('Build completed!')
                                ->setButton()
                                ->setActive(true)
                                ->show();
                            $popup->onEnterEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                        }
                    });
                });
            }
            if ('reset' === $item['id']) {
                if (!app('start')->getBuild()->checkSupportReset()) {
                    $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                    $popup
                        ->setTitle('Error')
                        ->setText('This game not supported reset functionality.')
                        ->setButton()
                        ->setActive(true)
                        ->show();
                    $popup->onEnterEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                } else {
                    $popup = $this->addWidget(new PopupYesNoWidget($this->window));
                    $popup
                        ->setTitle('Reset Wizard')
                        ->setText([
                            'Reset files the game?',
                            'Deleted files can not be returned.',
                        ])
                        ->setActive(true)
                        ->show();
                    $popup->onEscEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                    $popup->onEnterEvent(function ($flag) use (&$popup, &$type) {
                        $this->removeWidget($popup->hide());

                        if ($flag) {
                            $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                            $popup
                                ->setTitle('Build')
                                ->setText('Wait...')
                                ->setActive(true)
                                ->show();

                            app('start')->getBuild()->reset();

                            $this->removeWidget($popup->hide());

                            $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                            $popup
                                ->setTitle('Success')
                                ->setText('Reset completed!')
                                ->setButton()
                                ->setActive(true)
                                ->show();
                            $popup->onEnterEvent(function ()  use (&$popup) {
                                $this->removeWidget($popup->hide());
                                app()->close();
                            });
                        }
                    });
                }
            }
            if ('update' === $item['id']) {

                $select = $this->addWidget(new PopupSelectWidget($this->window));
                $select
                    ->setItems([
                        ['id' => 'script', 'name' => 'Script'],
                        ['id' => 'dxvk',   'name' => 'DXVK'],
                    ])
                    ->border()
                    ->setFullMode()
                    ->backAccess()
                    ->maxSize(null, 4)
                    ->offset($xy['x'], $xy['y'])
                    ->setActive(true)
                    ->show();
                $select->onEscEvent(function () use (&$select) { $this->removeWidget($select->hide()); });
                $select->onEnterEvent(function ($type) use (&$select, &$xy) {
                    $this->removeWidget($select->hide());

                    if ('script' === $type['id']) {
                        $current = app('start')->getUpdate()->version();
                        $remote  = app('start')->getUpdate()->versionRemote();

                        if ($current === $remote) {
                            $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                            $popup
                                ->setTitle('Success')
                                ->setText('Your script version is up to date.')
                                ->setButton()
                                ->setActive(true)
                                ->show();
                            $popup->onEnterEvent(function ()  use (&$popup) { $this->removeWidget($popup->hide()); });
                        } else {
                            $popup = $this->addWidget(new PopupYesNoWidget($this->window));
                            $popup
                                ->setTitle('Update Wizard')
                                ->setText([
                                    'Download the new version of the script?',
                                ])
                                ->setActive(true)
                                ->show();
                            $popup->onEscEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                            $popup->onEnterEvent(function ($flag) use (&$popup) {
                                $this->removeWidget($popup->hide());

                                if ($flag) {
                                    $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                    $popup
                                        ->setTitle('Download')
                                        ->setText('Wait...')
                                        ->setActive(true)
                                        ->show();

                                    $result = app('start')->getUpdate()->update();

                                    $this->removeWidget($popup->hide());

                                    if ($result) {
                                        $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                        $popup
                                            ->setTitle('Success')
                                            ->setText('Script updated, restart script to apply.')
                                            ->setButton()
                                            ->setActive(true)
                                            ->show();
                                        $popup->onEnterEvent(function ()  use (&$popup) { $this->removeWidget($popup->hide()); });
                                    } else {
                                        $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                        $popup
                                            ->setTitle('Error')
                                            ->setText('Script update failed.')
                                            ->setButton()
                                            ->setActive(true)
                                            ->show();
                                        $popup->onEnterEvent(function ()  use (&$popup) { $this->removeWidget($popup->hide()); });
                                    }
                                }
                            });
                        }
                    }
                    if ('dxvk' === $type['id']) {
                        $current = app('start')->getUpdate()->versionDxvk();
                        $remote  = app('start')->getUpdate()->versionDxvkRemote();

                        if ($current === $remote) {
                            $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                            $popup
                                ->setTitle('Success')
                                ->setText('Your DXVK version is up to date.')
                                ->setButton()
                                ->setActive(true)
                                ->show();
                            $popup->onEnterEvent(function ()  use (&$popup) { $this->removeWidget($popup->hide()); });
                        } else {
                            $popup = $this->addWidget(new PopupYesNoWidget($this->window));
                            $popup
                                ->setTitle('Update Wizard')
                                ->setText([
                                    'Download the new version of the DXVK?',
                                ])
                                ->setActive(true)
                                ->show();
                            $popup->onEscEvent(function () use (&$popup) { $this->removeWidget($popup->hide()); });
                            $popup->onEnterEvent(function ($flag) use (&$popup) {
                                $this->removeWidget($popup->hide());

                                if ($flag) {
                                    $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                    $popup
                                        ->setTitle('Download')
                                        ->setText('Wait...')
                                        ->setActive(true)
                                        ->show();

                                    $result = app('start')->getUpdate()->updateDxvk();

                                    $this->removeWidget($popup->hide());

                                    if ($result) {
                                        $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                        $popup
                                            ->setTitle('Success')
                                            ->setText('DXVK updated.')
                                            ->setButton()
                                            ->setActive(true)
                                            ->show();
                                        $popup->onEnterEvent(function ()  use (&$popup) { $this->removeWidget($popup->hide()); });
                                    } else {
                                        $popup = $this->addWidget(new PopupInfoWidget($this->getWindow()));
                                        $popup
                                            ->setTitle('Error')
                                            ->setText('DXVK update failed.')
                                            ->setButton()
                                            ->setActive(true)
                                            ->show();
                                        $popup->onEnterEvent(function ()  use (&$popup) { $this->removeWidget($popup->hide()); });
                                    }
                                }
                            });
                        }
                    }
                });
            }
        });

        return $select;
    }

    public function pressKey($key) {}
}



class WineScene extends AbstractScene {
    public function render()
    {
        /** @var Config $config */
        $config = app('start')->getConfig();
        /** @var Update $update */
        $update = app('start')->getUpdate();
        /** @var Wine $wine */
        $wine = app('start')->getWine();

        $this->window
            ->border()
            ->title($wine->version())
            ->status($update->getUrl())
            ->refresh();

        $menu = $this->renderMenu();

        $info = $this->addWidget(new InfoWidget($this->window));
        $info
            ->setData($menu)
            ->show();
    }

    public function renderMenu()
    {
        $items = [
            ['id' => 'back',        'name' => 'Back'],
            ['id' => 'winecfg',     'name' => 'Config',          'wine' => 'WINECFG'],
            ['id' => 'filemanager', 'name' => 'File Manager',    'wine' => 'WINEFILE'],
            ['id' => 'regedit',     'name' => 'Regedit',         'wine' => 'REGEDIT'],
            ['id' => 'taskmgr',     'name' => 'Task Manager',    'wine' => 'WINETASKMGR'],
            ['id' => 'uninstaller', 'name' => 'Uninstaller',     'wine' => 'WINEUNINSTALLER'],
            ['id' => 'progman',     'name' => 'Program Manager', 'wine' => 'WINEPROGRAM'],
        ];

        $select = $this->addWidget(new PopupSelectWidget($this->window));
        $select
            ->setItems($items)
            ->border()
            ->setFullMode()
            ->maxSize(null, 16)
            ->offset(2, 1)
            ->setActive(true)
            ->show();

        $select->onEnterEvent(function ($item) {
            if ('back' === $item['id']) {
                app()->showMain();
            }
            if (in_array($item['id'], ['winecfg', 'filemanager', 'regedit', 'taskmgr', 'uninstaller', 'progman'])) {
                $config = app('start')->getConfig();
                $task   = new Task($config);
                $task
                    ->debug()
                    ->logName($item['id'])
                    ->cmd(Text::quoteArgs($config->wine($item['wine'])))
                    ->run();
            }
        });

        return $select;
    }

    public function pressKey($key) {}
}



abstract class AbstractWidget {

    /** @var \NcursesObjects\Window  */
    protected $parentWindow;
    /** @var \NcursesObjects\Window  */
    protected $window;
    protected $active = false;
    protected $visible = false;
    protected $change;
    protected $changeActive;
    protected $enter;
    protected $esc;
    protected $back = false;

    /**
     * AbstractWidget constructor.
     * @param \NcursesObjects\Window $window
     */
    public function __construct($window)
    {
        $this->parentWindow = $window;
        $this->change       = [];
        $this->changeActive = [];
        $this->enter        = [];
        $this->esc          = [];
    }

    public function getWindow()
    {
        return $this->window;
    }

    public function getParentWindow()
    {
        return $this->parentWindow;
    }

    public function isActive()
    {
        if (!$this->isVisible()) {
            $this->active = false;
        }

        return $this->active;
    }

    public function setActive($flag = true)
    {
        $this->active = $flag;
        $this->doChangeActiveEvent($this->active, $this);

        return $this;
    }

    public function isVisible()
    {
        return $this->visible;
    }

    public function setVisible($flag = true)
    {
        $this->visible = $flag;
        return $this;
    }

    public function backAccess($flag = true)
    {
        $this->back = $flag;
        return $this;
    }

    public function refresh()
    {
        $this->getWindow()->reload();
        return $this;
    }

    public function show()
    {
        $this->visible = true;
        $this->render();

        return $this;
    }

    public function hide()
    {
        if ($this->visible) {
            $this->setVisible(false);
            $this->setActive(false);
            $this->getParentWindow()->reload();
            foreach (app()->getCurrentScene()->getWidgets() as $widget) {
                /** @var AbstractWidget $widget */
                if ($widget->isVisible()) {
                    $widget->refresh();
                }
            }
        }

        return $this;
    }

    public function onChangeEvent($callback)
    {
        $this->change[] = $callback;
    }

    public function offChangeEvent($callback)
    {
        $this->change = array_filter($this->change, function ($item) use (&$callback) {return $item !== $callback;});
    }

    protected function doChangeEvent($v1, $v2 = null, $v3 = null)
    {
        foreach ($this->change as $change) {
            $change($v1, $v2, $v3);
        }
    }

    public function onEnterEvent($callback)
    {
        $this->enter[] = $callback;
    }

    public function offEnterEvent($callback)
    {
        $this->enter = array_filter($this->enter, function ($item) use (&$callback) {return $item !== $callback;});
    }

    protected function doEnterEvent($v1 = null, $v2 = null, $v3 = null)
    {
        foreach ($this->enter as $enter) {
            $enter($v1, $v2, $v3);
        }
    }

    public function onEscEvent($callback)
    {
        $this->esc[] = $callback;
    }

    public function offEscEvent($callback)
    {
        $this->esc = array_filter($this->esc, function ($item) use (&$callback) {return $item !== $callback;});
    }

    protected function doEscEvent($v1 = null, $v2 = null, $v3 = null)
    {
        foreach ($this->esc as $esc) {
            $esc($v1, $v2, $v3);
        }
    }

    public function onChangeActiveEvent($callback)
    {
        $this->changeActive[] = $callback;
    }

    public function offChangeActiveEvent($callback)
    {
        $this->changeActive = array_filter($this->changeActive, function ($item) use (&$callback) {return $item !== $callback;});
    }

    protected function doChangeActiveEvent($v1, $v2 = null, $v3 = null)
    {
        foreach ($this->changeActive as $event) {
            $event($v1, $v2, $v3);
        }
    }

    abstract public function pressKey($key);

    abstract public function render();

    public function destruct() {
        $this->change = [];
        $this->enter = [];
        $this->setActive(false);
        $this->setVisible(false);
    }
}



class SelectWidget extends AbstractWidget
{
    private $windowBorder = false;
    private $index = 0;
    private $items;
    private $width;
    private $height;
    private $x = 2;
    private $y = 1;

    public function init()
    {
        if (null === $this->window) {

            $width = 0;

            foreach ($this->items as $item) {
                if ($width < ($len = mb_strlen($item['name']))) {
                    $width = $len;
                }
            }

            $width += 5;
            $width = ($width > 20 ? $width : 20);

            $this->window = new \NcursesObjects\Window($width, count($this->items) + 2, $this->x, $this->y);
        }

        if ($this->windowBorder) {
            $this->window->border();
        }
    }

    public function border($flag = true)
    {
        $this->windowBorder = $flag;

        return $this;
    }

    public function size($width, $height)
    {
        $this->width  = $width;
        $this->height = $height;

        return $this;
    }

    public function getWidth()
    {
        $this->window->getSize($width, $height);
        return $this->windowBorder ? $width + 2 : $width;
    }

    public function getHeight()
    {
        $this->window->getSize($width, $height);
        return $this->windowBorder ? $height + 2 : $height;
    }

    public function offset($x, $y)
    {
        $this->x = $x;
        $this->y = $y;

        return $this;
    }

    public function setItems($items)
    {
        $this->items = $items;
        return $this;
    }

    public function render()
    {
        $this->init();

        foreach ($this->items as $i => $item) {
            if ($this->index === $i) {
                $this->window->moveCursor(2, 1 + $i)->drawStringHere($item['name'], NCURSES_A_REVERSE);
            } else {
                $this->window->moveCursor(2, 1 + $i)->drawStringHere($item['name']);
            }
        }

        $this->window->refresh();
    }

    public function selectAt($index)
    {
        if (count($this->items) <= $index || 0 > $index) {
            return false;
        }

        $this->index = $index;

        $this->doChangeEvent($this->getItem());

        return true;
    }

    public function itemAt($index)
    {
        if (count($this->items) <= $index || 0 > $index) {
            return reset($this->items);
        }

        return $this->items[$this->index];
    }

    public function getItem()
    {
        return $this->itemAt($this->index);
    }

    public function selectNext()
    {
        if ($this->selectAt($this->index + 1)) {
            $this->render();
            return false;
        }

        return false;
    }

    public function selectPrev()
    {
        if ($this->selectAt($this->index - 1)) {
            $this->render();
            return false;
        }

        return false;
    }

    public function pressKey($key)
    {
        if (\NcursesObjects\Keys::KEY_DOWN === $key) {
            $this->selectNext();
        }

        if (\NcursesObjects\Keys::KEY_UP === $key) {
            $this->selectPrev();
        }

        if (\NcursesObjects\Keys::KEY_ENTER === $key) {
            $this->doEnterEvent($this->getItem());
            return false;
        }
    }
}



class InfoWidget extends AbstractWidget {

    /** @var SelectWidget */
    private $data;
    /** @var PrintWidget */
    private $windowPrint;

    private $callback;

    public function init()
    {
        if (null === $this->window) {
            $windowWidth  = $this->getParentWindow()->getWidth();
            $windowHeight = $this->getParentWindow()->getHeight();

            $menuWidth  = $this->data->getWidth();
            $menuHeight = $this->data->getHeight();

            $this->window = new \NcursesObjects\Window($windowWidth - $menuWidth - 3, $windowHeight - 2, $menuWidth + 1, 1);
        }

        if (null === $this->windowPrint) {
            $this->windowPrint = new PrintWidget($this->window);
        }
    }

    public function setData($data)
    {
        $this->data = $data;
        return $this;
    }

    public function getData()
    {
        return $this->data;
    }

    public function refresh()
    {
        parent::refresh();
        $this->windowPrint->refresh();
    }

    public function render()
    {
        $this->init();

        $window = $this->window;

        $callback = function ($item) use (&$window) {
            if ('start' === $item['id']) {

                /** @var Config $config */
                $config = $item['config'];
                $update = app('start')->getUpdate();

                if (!$config) {
                    return;
                }

                $window->erase()->border()->title($config->getGameTitle());

                $items = [
                    'File:    ' . basename($config->getConfigFile()),
                    'Path:    "C:/' . $config->getGamePath() . '/' . $config->getGameAdditionalPath() . '/' . $config->getGameExe() . '" ' . $config->getGameArgs(),
                    'Version: ' . $config->getGameVersion(),
                    'Windows: ' . $config->getWindowsVersion(),
                    'Sandbox: ' . ($config->isSandbox() ? 'on' : 'off'),
                    'Sound:   ' . ($config->isPulse() ? 'pulse' : 'alsa'),
                    'CSMT:    ' . ($config->isCsmt() ? 'on' : 'off'),
                    'DXVK:    ' . ($config->isDxvk() ? 'on ' . (($dxvkVersion = $update->versionDxvk()) ? "({$dxvkVersion})" : '') : 'off'),
                    'PBA:     ' . ($config->isPBA() ? 'on' : 'off'),
                    'Esync:   ' . ($config->isEsync() ? 'on' : 'off'),
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('wine' === $item['id']) {
                $window->erase()->border()->title($item['name']);

                $config  = app('start')->getConfig();
                $monitor = app('start')->getMonitor();
                $wine    = new Wine($config, app('start')->getCommand());

                $items = [
                    'Utilities: Config, File Manager, Regedit.',
                    '',
                ];

                $sysWine = $wine->isUsedSystemWine() ? 'Used system wine!' : null;

                $versinPrefix = $config->versionPrefix();

                if ($versinPrefix && $versinPrefix !== $wine->version()) {
                    $items = array_merge(
                        $items,
                        [
                            '!!! Warning !!!',
                            "This prefix ({$versinPrefix}) is incompatible with the current used wine!",
                            '',
                        ]
                    );
                }

                if ($sysWine) {
                    $items = array_merge($items, [$sysWine, '']);
                }

                $items = array_merge(
                    $items,
                    [
                        'Version:   ' . $wine->version(),
                        'Arch:      ' . $config->getWineArch(),
                    ]
                );

                if ($output = $monitor->getDefaultMonitor()) {
                    $items = array_merge($items, ["Monitor:   {$output['output']} ({$output['resolution']}) primary"]);
                }

                if ($miss = $wine->getMissingLibs()) {
                    $items = array_merge($items, ['', 'Missing libs:'], $miss);
                }

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('tools' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Utilities:',
                    '',
                    ' - Create\Remove Icon',
                    ' - Pack\Unpack "wine" or "data" folder',
                    ' - Replace "data" folder to symlinks',
                    ' - Set CPU mode',
                    ' - Build',
                    ' - Reset game files',
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('settings' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Configuration *.ini files',
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('info' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $system = app('start')->getSystem();

                $items = [
                    'CPU:   ' . $system->getCPU(),
                    'GPU:   ' . $system->getGPU(),
                    'RAM:   ' . $system->getRAM() . ' Mb',
                    'Distr: ' . $system->getDistrName(),
                    'Linux: ' . $system->getLinuxVersion(),
                    'Glibc: ' . $system->getGlibcVersion(),
                ];

                if ($mesa = $system->getMesaVersion()) {
                    $items[] = 'Mesa:  ' . $mesa;
                }

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('exit' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Close this application.',
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('back' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Return to main menu.',
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('icon' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Create or remove icon file.',
                    '',
                    'Found icons dir:',
                    app('start')->getIcon()->findDir(),
                ];

                $icons = app('start')->getIcon()->findExistIcons();

                if ($icons) {
                    $items = array_merge(
                        $items,
                        ['', 'Found icons:'],
                        $icons
                    );
                }

                $icons = app('start')->getIcon()->findPng();

                if ($icons) {
                    $items = array_merge(
                        $items,
                        ['', 'Found png:'],
                        $icons
                    );
                }

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('pack' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Compressed "data" and "wine" folders.',
                ];

                if ($mountes = app('start')->getPack()->getMountes()) {
                    $items = array_merge(
                        $items,
                        ['', 'Mounted:'],
                        $mountes
                    );
                }

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('symlink' === $item['id']) {

                $window->erase()->border()->title($item['name']);
                $config = app('start')->getConfig();
                $fs     = app('start')->getFileSystem();

                $items = [
                    'Replace with a symbolic link from dir RW mode',
                    '',
                    './' . $fs->relativePath($config->getDataDir()) . '/* > ./' . $fs->relativePath($config->getSymlinksDir()) . '/*',
                    '',
                    'Skip extensions:',
                    '.' . implode(', .', app('start')->getSymlink()->getExtensions()),
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('build' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Build game to "./build" folder.',
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('reset' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Full reset files the game.',
                    '',
                    'Removes all everything except files:',
                    '',
                    './game_info/data.squashfs',
                    './extract.sh',
                    './static.tar.gz',
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('winecfg' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Configuring WINE with Winecfg.',
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('filemanager' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Use file manager to install software.',
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('regedit' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Registry Editor.',
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('update' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $config  = app('start')->getConfig();
                $update  = app('start')->getUpdate();

                $current = $update->version();
                $remote  = $update->versionRemote();
                $auto    = $config->isScriptAutoupdate() ? 'on' : 'off';

                $items = [
                    'Update this script' . ($config->isDxvk() ? ' or DXVK.' : '.'),
                    '',
                    "Auto update: {$auto}",
                    "Current version: {$current}",
                    "Remote version: {$remote}",
                ];

                if ($config->isDxvk()) {
                    $currentDxvk = $update->versionDxvk();
                    $remoteDxvk  = $update->versionDxvkRemote();
                    $autoDxvk    = $config->isDxvkAutoupdate() ? 'on' : 'off';

                    $items = array_merge(
                        $items,
                        [
                            '',
                            "Auto update DXVK: {$autoDxvk}",
                            "Current DXVK version: {$currentDxvk}",
                            "Remote DXVK version: {$remoteDxvk}",
                        ]
                    );
                }

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('taskmgr' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Task Manager implementation.'
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('uninstaller' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Basic program uninstaller.'
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            } elseif ('progman' === $item['id']) {

                $window->erase()->border()->title($item['name']);

                $items = [
                    'Program Manager implementation.'
                ];

                $window->refresh();

                $this->windowPrint->padding(1, 1)->dotMode(false)->update($items);

            }
        };

        $this->getData()->onChangeEvent($callback);

        $this->callback = $callback;

        $callback($this->getData()->getItem());
    }

    public function pressKey($key) {}
}



class ProgressBarWidget extends AbstractWidget {

    private $percent = 0;
    private $offset = 0;
    private $padding = 0;

    public function pressKey($key) {}

    public function init()
    {
        if (null === $this->window) {
            $this->getParentWindow()->getSize($columns, $row);
            $this->window = new \NcursesObjects\Window($columns - ($this->offset + $this->padding * 2), 1, $this->offset + $this->padding, $row - 1);
        }

        return $this;
    }

    public function offset($offset, $padding)
    {
        $this->offset  = $offset;
        $this->padding = $padding;

        return $this;
    }

    public function setProgress($percent)
    {
        $this->percent = $percent >= 0 && $percent <= 100 ? $percent : ($percent > 100 ? 100 : 0);
        return $this;
    }

    public function render()
    {
        $this->init();

        $this->window->getSize($columns, $row);
        $symbols = round($columns / 100 * $this->percent);

        $this->window->erase()->refresh();
        $this->window->drawStringHere(str_repeat('▓', $symbols) . str_repeat('░', $columns - $symbols));
        $this->window->refresh();
    }
}



class PrintWidget extends AbstractWidget
{
    private $text = '';
    private $paddingLeft = 1;
    private $paddingRight = 1;
    private $paddingTop = 0;
    private $paddingBottom = 0;
    private $dotMode = false;

    public function init()
    {
        if (null === $this->window) {
            $this->window = new \NcursesObjects\Window(
                $this->getParentWindow()->getWidth() - 2,
                $this->getParentWindow()->getHeight() - 2 ,
                $this->getParentWindow()->getX() + 1,
                $this->getParentWindow()->getY() + 1
            );
        }
    }

    public function pressKey($key) {}

    public function render() {
        $this->init();

        $this->window->erase();

        $i = 0;

        for (; $i < $this->paddingTop; $i++) {
            $this->window->moveCursor($this->paddingLeft + 0, $i++)->drawStringHere('');
        }
        if ($this->paddingTop > 0) {
            $i--;
        }
        foreach (is_array($this->text) ? $this->text : explode("\n", $this->text) as $line) {
            $this->window->moveCursor($this->paddingLeft + 0, $i++)->drawStringHere($line);
        }

        $this->window->refresh();
    }

    public function padding($left, $top = 0, $bottom = 0, $right = null)
    {
        $this->paddingLeft   = $left;
        $this->paddingTop    = $top;
        $this->paddingBottom = $bottom;
        $this->paddingRight  = null === $right ? $left : $right;

        return $this;
    }

    public function dotMode($flag = true)
    {
        $this->dotMode = $flag;
        return $this;
    }

    public function update($text)
    {
        $buffer = [];

        $this->init();

        $width = $this->window->getWidth() - ($this->paddingLeft + $this->paddingRight);
        foreach (is_array($text) ? $text : explode("\n", $text) as $line) {
            foreach (explode("\n", $line) as $line1) {

                $str = str_split($line1, $width);

                if ($this->dotMode && count($str) > 1) {
                    $buffer[] = mb_substr($line1, 0, $width - 3) . '...';
                } else {
                    foreach ($str as $line2) {
                        $buffer[] = $line2;
                    }
                }
            }
        }

        $this->text = array_slice($buffer, -($this->window->getHeight() - $this->paddingBottom));
        $this->render();

        return $this;
    }
}



class PopupYesNoWidget extends AbstractWidget {

    private $status = true;
    private $title  = 'Continue';
    private $text   = '';
    private $yes    = ' Yes ';
    private $no     = ' No ';
    private $width  = 60;
    private $height = 8;

    public function init()
    {
        if (null === $this->window) {
            $this->window = \NcursesObjects\Window::createCenteredOf($this->getParentWindow(), $this->width, $this->height);
        }

        return $this;
    }

    public function setTitle($title)
    {
        $this->title = $title;
        return $this;
    }

    public function setYes($title)
    {
        $this->yes = $title;
        return $this;
    }


    public function setNo($title)
    {
        $this->no = $title;
        return $this;
    }

    public function setText($text)
    {
        $this->text = $text;
        return $this;
    }

    public function size($width, $height)
    {
        $this->width  = $width;
        $this->height = $height;

        return $this;
    }

    public function render()
    {
        $this->init();

        $this->window->border();

        if ($this->title) {
            $this->window->title($this->title);
        }

        if ($this->text) {
            foreach ((array)$this->text as $i => $line) {
                $this->window->moveCursor(2, $i + 2)->drawStringHere($line);
            }
        }

        $yesLen = mb_strlen($this->yes);
        $noLen  = mb_strlen($this->no);
        $width  = $this->window->getWidth();
        $space  = 6;

        $all = $yesLen + $noLen + $space;
        $yes = ($width / 2) - ($all / 2);
        $no  = $yes + $yesLen + $space;

        $this->window->moveCursor($yes, $this->height - 3)->drawStringHere($this->yes, $this->status ? NCURSES_A_REVERSE : null);
        $this->window->moveCursor($no, $this->height - 3)->drawStringHere($this->no, !$this->status ? NCURSES_A_REVERSE : null);

        $this->window->refresh();
    }

    public function pressKey($key)
    {
        if (\NcursesObjects\Keys::KEY_RIGHT === $key) {
            $this->status = false;
            $this->render();
        }

        if (\NcursesObjects\Keys::KEY_LEFT === $key) {
            $this->status = true;
            $this->render();
        }

        if (\NcursesObjects\Keys::KEY_ENTER === $key) {
            $this->hide();
            $this->doEnterEvent($this->status);
            return false;
        }
    }
}



class PopupInfoWidget extends AbstractWidget {

    private $status = true;
    private $title  = '';
    private $text   = '';
    private $button = '';
    private $width  = 60;
    private $height = 8;

    public function init()
    {
        if (null === $this->window) {
            $this->window = \NcursesObjects\Window::createCenteredOf($this->getParentWindow(), $this->width, $this->height);
        }

        return $this;
    }

    public function size($width, $height)
    {
        $this->width  = $width;
        $this->height = $height;

        return $this;
    }

    public function setTitle($title)
    {
        $this->title = $title;
        return $this;
    }

    public function setText($text)
    {
        $this->text = $text;
        return $this;
    }

    public function setButton($title = ' Ok ')
    {
        $this->button = $title;
        return $this;
    }

    public function render()
    {
        $this->init();

        $this->window->border();

        if ($this->title) {
            $this->window->title($this->title);
        }

        if ($this->text) {
            foreach ((array)$this->text as $i => $line) {
                $this->window->moveCursor(2, $i + 2)->drawStringHere($line);
            }
        }

        if ($this->button) {
            $buttonLen = mb_strlen($this->button);
            $width     = $this->window->getWidth();
            $position  = ($width / 2) - ($buttonLen / 2);
            $this->window->moveCursor($position, $this->height - 3)->drawStringHere($this->button, NCURSES_A_REVERSE);
        }

        $this->window->refresh();
    }

    public function pressKey($key)
    {
        if (($this->button && \NcursesObjects\Keys::KEY_ENTER === $key) || !$this->button) {
            $this->hide();
            $this->doEnterEvent();
        }
    }
}



class PopupSelectWidget extends AbstractWidget {

    private $title;
    private $items = [];
    private $index = 0;
    private $mode = 'start';
    private $columns = 50;
    private $rows = 10;
    private $height;
    private $width;
    private $x;
    private $y;
    private $border = true;
    private $progress = false;
    private $maxColumns;
    private $maxRows;
    private $activeY;
    private $activeX;

    public function init()
    {
        if (null === $this->window) {
            if ('full' === $this->mode) {
                $width = 0;

                foreach ($this->items as $item) {
                    if ($width < ($len = mb_strlen($item['name']))) {
                        $width = $len;
                    }
                }

                $width += 5;
                $width = ($width > 20 ? $width : 20);

                $this->columns = $width;
            }

            if (null !== $this->maxColumns && $this->maxColumns < $this->columns) {
                $this->columns = $this->maxColumns;
            }

            if (null !== $this->maxRows && $this->maxRows > count($this->items)) {
                $this->rows = count($this->items) + 2 + ($this->title ? 1 : 0);
            }

            $this->progress = count($this->items) > $this->getInnerHeight();

            if (null !== $this->x && null !== $this->y) {
                $this->window = new \NcursesObjects\Window($this->columns - ($this->progress ? 0 : 1), $this->rows, $this->x, $this->y);
            } else {
                $this->window = \NcursesObjects\Window::createCenteredOf($this->getParentWindow(), $this->columns - ($this->progress ? 0 : 1), $this->rows);
            }

            $this->width  = $this->window->getWidth()  - 5;
            $this->height = $this->window->getHeight() - 2;
        }
    }

    public function border($flag = true)
    {
        $this->border = $flag;
        return $this;
    }

    public function setItems($items)
    {
        $this->items = $items;
        return $this;
    }

    public function setFullMode()
    {
        $this->mode = 'full';
        return $this;
    }

    public function setEndMode()
    {
        $this->mode = 'end';
        return $this;
    }

    public function setStartMode()
    {
        $this->mode = 'start';
        return $this;
    }
    
    public function setTitle($title)
    {
        $this->title = $title;
        return $this;
    }

    public function size($width, $height)
    {
        $this->columns = $width;
        $this->rows    = $height;

        return $this;
    }

    public function maxSize($width, $height)
    {
        $this->maxColumns = $width;
        $this->maxRows    = $height;

        return $this;
    }

    public function offset($x, $y)
    {
        $this->x = $x;
        $this->y = $y;

        return $this;
    }

    public function getHeight()
    {
        return $this->window->getHeight() + 2;
    }

    public function getWidth()
    {
        return $this->window->getWidth() + 2;
    }

    private function getInnerHeight()
    {
        if (!$this->title) {
            return $this->rows - 2;
        }

        return $this->rows - 3;
    }

    private function getInnerWidth()
    {
        return $this->width;
    }

    private function titleItem($title)
    {
        $len = mb_strlen($title);

        $width = ($this->getInnerWidth() + ('full' === $this->mode ? 1 : 0));

        if ($len <= $width) {
            return $title . str_repeat(' ', $width - $len);
        }

        if ($this->mode === 'end') {
            return '..' . mb_substr($title, - ($this->getInnerWidth() - 2));
        }

        return mb_substr($title, 0, $this->getInnerWidth() - 2) . '..';
    }

    private function items()
    {
        $offset    = (int)(($this->index + 1) - ($this->getInnerHeight() / 2));
        $offset    = $offset < 0 ? 0 : $offset;
        $maxOffset = count($this->items) - $this->getInnerHeight();
        $offset    = $offset > $maxOffset ? $maxOffset : $offset;
        $offset    = $offset < 0 ? 0 : $offset;

        return array_slice($this->items, $offset, $this->getInnerHeight(), true);
    }

    public function render()
    {
        $this->init();

        $this->window->erase();

        if ($this->border) {
            $this->window->border();
        }

        if ($this->title) {
            $this->window->title($this->title);
        }

        $ip = 0;
        $progress = $this->getProgressBar();

        $ii = 0;
        if ($this->title) {
            $ii = 1;
        }
        foreach ($this->items() as $i => $item) {
            if ($this->progress) {
                $this->window->moveCursor($this->getInnerWidth() + 3, 1 + $ii)->drawStringHere($progress[$ip]);
                $ip++;
            }

            if ($this->index === $i) {
                $this->activeX = $this->getWindow()->getX() + $this->getWindow()->getWidth();
                $this->activeY = $this->getWindow()->getY() + $ii;
                $this->window->moveCursor(2, 1 + $ii)->drawStringHere($this->titleItem($item['name']), NCURSES_A_REVERSE);
            } else {
                $this->window->moveCursor(2, 1 + $ii)->drawStringHere($this->titleItem($item['name']));
            }
            $ii++;
        }

        $this->window->refresh();
    }

    private function getProgressBar()
    {
        $result = [];

        $onePercent     = 100 / $this->getInnerHeight();
        $currentPercent = count($this->items) > 0 ? (100 / (count($this->items) / ($this->index + 1))) : 0;

        if ($currentPercent < $onePercent) {
            $result[] = '┃';
            for ($i = 0, $end = $this->getInnerHeight() - 1; $i < $end; $i++) {
                $result[] = '│';
            }

        } elseif ($currentPercent >= (100 - $onePercent)) {
            for ($i = 0, $end = $this->getInnerHeight() - 1; $i < $end; $i++) {
                $result[] = '│';
            }
            $result[] = '┃';
        } else {
            $i1 = ($currentPercent / $onePercent) -1;
            for ($i = 0, $end = $i1; $i < $end; $i++) {
                $result[] = '│';
            }
            $result[] = '┃';
            for ($i = 0, $end = $this->getInnerHeight() - 1 - $i1; $i < $end; $i++) {
                $result[] = '│';
            }
        }

        return $result;
    }

    public function selectAt($index)
    {
        if (count($this->items) <= $index || 0 > $index) {
            return false;
        }

        $this->index = $index;

        $this->doChangeEvent($this->getItem());

        return true;
    }

    public function index()
    {
        return $this->index;
    }

    public function itemAt($index)
    {
        if (count($this->items) <= $index || 0 > $index) {
            return reset($this->items);
        }

        return $this->items[$this->index];
    }

    public function getItem()
    {
        return $this->itemAt($this->index);
    }

    public function selectNext()
    {
        if ($this->selectAt($this->index + 1)) {
            $this->render();
            return false;
        }

        return false;
    }

    public function selectPrev()
    {
        if ($this->selectAt($this->index - 1)) {
            $this->render();
            return false;
        }

        return false;
    }

    public function pressKey($key)
    {
        if (\NcursesObjects\Keys::KEY_DOWN === $key) {
            $this->selectNext();
        }

        if (\NcursesObjects\Keys::KEY_UP === $key) {
            $this->selectPrev();
        }

        if ($this->back && \NcursesObjects\Keys::KEY_ESC == $key) {
            $this->doEscEvent();
        }

        if (\NcursesObjects\Keys::KEY_ENTER === $key) {
            $this->doEnterEvent($this->getItem(), ['x' => $this->activeX, 'y' => $this->activeY]);
            return false;
        }
    }
}



class Start
{
    private $config;
    private $command;
    private $system;
    private $winePrefix;
    private $gameInfo;
    private $log;
    private $update;
    private $monitor;
    private $buffer;
    private $mountes;
    private $icon;
    private $fs;
    private $symlink;
    private $build;
    private $wine;
    private $console;

    public function __construct()
    {
        if (file_exists(__DIR__ . '/start-tmp')) {
            @unlink(__DIR__ . '/start-tmp');
        }

        app($this);

        $this->config     = new Config();
        $this->log        = new Logs();
        $this->command    = new Command($this->config);
        $this->gameInfo   = new GameInfo($this->config, $this->command);
        $this->winePrefix = new WinePrefix($this->config, $this->command);
        $this->system     = new System($this->config, $this->command);
        $this->fs         = new FileSystem($this->config, $this->command);
        $this->update     = new Update($this->config, $this->command);
        $this->monitor    = new Monitor($this->config, $this->command);
        $this->buffer     = new Buffer();
        $this->icon       = new Icon($this->config, $this->command, $this->system);
        $this->pack       = new Pack($this->config, $this->command, $this->fs);
        $this->symlink    = new Symlink($this->config, $this->command, $this->fs);
        $this->build      = new Build($this->config, $this->command, $this->system, $this->fs);
        $this->wine       = new Wine($this->config, $this->command);
        $this->console    = new Console($this->config, $this->command, $this->system, $this->log);
        $this->mountes    = [
            new Mount($this->config, $this->command, $this->console, $this->config->getDataDir()),
            new Mount($this->config, $this->command, $this->console, $this->config->getWineDir()),
        ];

        $this->init();
    }

    private function init()
    {
        $this->console->lock();

        $this->gameInfo->create();
        $this->winePrefix->create();
        $this->update->init();

        if (!$this->system->checkPhp() || (!$this->gameInfo->isCreated() && !$this->winePrefix->isCreated())) {
            $this->console->init();
        }

        if (!$this->system->checkPhp()) {
            return;
        }

        if ($this->gameInfo->isCreated() || $this->winePrefix->isCreated() || $this->console->isGui()) {
            app('gui');
            app($this)->start();
        }
    }

    /**
     * @return Config
     */
    public function getConfig()
    {
        return $this->config;
    }

    /**
     * @param Config $config
     */
    public function setConfig($config)
    {
        $this->config = $config;
    }

    /**
     * @return Command
     */
    public function getCommand()
    {
        return $this->command;
    }

    /**
     * @return System
     */
    public function getSystem()
    {
        return $this->system;
    }

    /**
     * @return WinePrefix
     */
    public function getWinePrefix()
    {
        return $this->winePrefix;
    }

    /**
     * @return GameInfo
     */
    public function getGameInfo()
    {
        return $this->gameInfo;
    }

    /**
     * @return Logs
     */
    public function getLog()
    {
        return $this->log;
    }

    /**
     * @return Update
     */
    public function getUpdate()
    {
        return $this->update;
    }

    /**
     * @return Monitor
     */
    public function getMonitor()
    {
        return $this->monitor;
    }

    /**
     * @return Buffer
     */
    public function getBuffer()
    {
        return $this->buffer;
    }

    /**
     * @return Icon
     */
    public function getIcon()
    {
        return $this->icon;
    }

    /**
     * @return FileSystem
     */
    public function getFileSystem()
    {
        return $this->fs;
    }

    /**
     * @return array[Mount]
     */
    public function getMountes()
    {
        return $this->mountes;
    }

    /**
     * @return Pack
     */
    public function getPack()
    {
        return $this->pack;
    }

    /**
     * @return Symlink
     */
    public function getSymlink()
    {
        return $this->symlink;
    }

    /**
     * @return Build
     */
    public function getBuild()
    {
        return $this->build;
    }

    /**
     * @return Wine
     */
    public function getWine()
    {
        return $this->wine;
    }


    /**
     * @return Console
     */
    public function getConsole()
    {
        return $this->console;
    }
}

pcntl_signal(SIGINT, function ($signal) {
    switch($signal) {
        case SIGINT:
        case SIGKILL:
        case SIGQUIT:
        case SIGTERM:
        case SIGSTOP:
            if (app('start')->getSystem()->checkPhp()) {
                $scene = app()->getCurrentScene();
                $popup = $scene->addWidget(new PopupInfoWidget($scene->getWindow()));
                $popup
                    ->setTitle('Exit')
                    ->setText('Wait umount...')
                    ->setActive(true)
                    ->show();
            }

            exit(0);
    }
}, false);

new Start();
}